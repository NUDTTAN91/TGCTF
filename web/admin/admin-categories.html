<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="author" content="tan91">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/fonts.css">
    <style>
        :root {
            --bg-dark: #121212;
            --bg-panel: #1e1e1e;
            --border-color: #333;
            --accent: #ff6b00;
            --danger: #ef4444;
            --success: #22c55e;
            --text-main: #e0e0e0;
            --text-dim: #737373;
        }
        body { background-color: var(--bg-dark); color: var(--text-main); font-family: 'Noto Sans SC', sans-serif; }
        .font-eng { font-family: 'Chakra Petch', sans-serif; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        .sidebar-item { border-left: 2px solid transparent; transition: all 0.2s; }
        .sidebar-item:hover, .sidebar-item.active { background: rgba(255, 107, 0, 0.05); border-left-color: var(--accent); color: white; }
        .sidebar-item.active .icon { color: var(--accent); }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #111; }
        ::-webkit-scrollbar-thumb { background: #333; }

        .admin-table { width: 100%; border-collapse: collapse; }
        .admin-table th, .admin-table td { padding: 16px; text-align: left; border-bottom: 1px solid #333; }
        .admin-table th { background: #1a1a1a; font-size: 10px; font-weight: bold; text-transform: uppercase; letter-spacing: 0.1em; color: #888; }
        .admin-table tr:hover { background: rgba(255, 107, 0, 0.03); }

        .btn-action { padding: 6px 12px; font-size: 11px; font-family: 'JetBrains Mono', monospace; border: 1px solid; transition: all 0.2s; cursor: pointer; }
        .btn-edit { border-color: #666; color: #888; }
        .btn-edit:hover { border-color: var(--accent); color: var(--accent); }
        .btn-delete { border-color: #666; color: #888; }
        .btn-delete:hover { border-color: var(--danger); color: var(--danger); }

        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(4px); z-index: 50; display: none; align-items: center; justify-content: center; }
        .modal-overlay.active { display: flex; }
        .modal-content { background: #1a1a1a; border: 1px solid #333; width: 100%; max-width: 500px; max-height: 90vh; overflow-y: auto; }

        .form-input { background: #111; border: 1px solid #333; color: white; padding: 12px 16px; width: 100%; outline: none; font-family: 'JetBrains Mono', monospace; transition: 0.2s; }
        .form-input:focus { border-color: var(--accent); }
        .form-label { display: block; font-size: 11px; font-weight: bold; color: #888; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.05em; }

        .category-icon { min-width: 40px; height: 40px; padding: 0 8px; background: #222; border: 1px solid #444; display: flex; align-items: center; justify-content: center; font-size: 14px; color: var(--accent); white-space: nowrap; }
        .default-badge { background: rgba(34, 197, 94, 0.1); color: var(--success); border: 1px solid rgba(34, 197, 94, 0.3); padding: 2px 8px; font-size: 10px; font-family: 'JetBrains Mono', monospace; }
    </style>
</head>
<body class="flex h-screen overflow-hidden selection:bg-[#ff6b00] selection:text-black">

    <!-- å·¦ä¾§ä¾§è¾¹æ  -->
    <aside class="w-48 bg-[#161616] border-r border-[#333] flex flex-col z-20 shadow-xl">
        <div class="h-16 flex items-center px-6 border-b border-[#333]">
            <div class="bg-[#ff6b00] text-black font-black text-xl px-2 py-0.5 font-eng tracking-tighter mr-3">TG</div>
            <span class="font-bold text-gray-300 tracking-wider text-sm">ç®¡ç†ä¸­æ¢</span>
        </div>
        <nav class="flex-1 py-6 space-y-1 font-mono text-xs overflow-y-auto">
            <a href="/admin/admin.html" class="sidebar-item flex items-center px-6 py-3 text-gray-400"><span class="icon mr-3">âŒ‚</span> æ¦‚è§ˆ</a>
            <p class="px-6 text-[#555] mb-2 font-bold mt-4">èµ›äº‹æ ¸å¿ƒ</p>
            <a href="/admin/admin-contests.html" class="sidebar-item flex items-center px-6 py-3 text-gray-400"><span class="icon mr-3">âš‘</span> æ¯”èµ›ç®¡ç†</a>
            <a href="/admin/admin-question-bank.html" class="sidebar-item active flex items-center px-6 py-3 text-gray-400"><span class="icon mr-3">â˜·</span> é¢˜åº“</a>
            <a href="/admin/admin-users.html" class="sidebar-item flex items-center px-6 py-3 text-gray-400"><span class="icon mr-3">ì›ƒ</span> ç”¨æˆ·ç®¡ç†</a>
            <a href="/admin/admin-teams.html" class="sidebar-item flex items-center px-6 py-3 text-gray-400"><span class="icon mr-3">â—ˆ</span> é˜Ÿä¼ç®¡ç†</a>
            <a href="/admin/admin-organizations.html" class="sidebar-item flex items-center px-6 py-3 text-gray-400"><span class="icon mr-3">ğŸ¢</span> ç»„ç»‡ç®¡ç†</a>
            <a href="/admin/admin-data-import.html" class="sidebar-item flex items-center px-6 py-3 text-gray-400"><span class="icon mr-3">ğŸ“¥</span> æ•°æ®å¯¼å…¥</a>
            <p class="px-6 text-[#555] mb-2 font-bold mt-6">è¿ç»´ç›‘æ§</p>
            <a href="/admin/admin-docker.html" class="sidebar-item flex items-center px-6 py-3 text-gray-400"><span class="icon mr-3">ğŸ³</span> dockerå®ä¾‹ç®¡ç†</a>
            <a href="/admin/admin-anti-cheat.html" class="sidebar-item flex items-center px-6 py-3 text-gray-400"><span class="icon mr-3">ğŸ›¡ï¸</span> é˜²ä½œå¼Šç³»ç»Ÿ</a>
            <a href="/admin/admin-logs.html" class="sidebar-item flex items-center px-6 py-3 text-gray-400"><span class="icon mr-3">âš </span> ç³»ç»Ÿæ—¥å¿—</a>
            <a href="/admin/admin-settings.html" class="sidebar-item flex items-center px-6 py-3 text-gray-400"><span class="icon mr-3">âš™</span> ç³»ç»Ÿè®¾ç½®</a>
        </nav>
        <div class="p-4 border-t border-[#333]">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 bg-[#333] rounded-full flex items-center justify-center text-[#ff6b00] font-bold">A</div>
                <div><p class="text-xs text-white font-bold">è¶…çº§ç®¡ç†å‘˜</p><p class="text-[10px] text-green-500">â— è¿æ¥ç¨³å®š</p></div>
            </div>
        </div>
    </aside>

    <!-- å³ä¾§å†…å®¹åŒº -->
    <div class="flex-1 flex flex-col min-w-0 bg-[#121212]">
        <header class="h-16 bg-[#161616] border-b border-[#333] flex items-center justify-between px-8 z-10">
            <div class="flex items-center gap-4 text-xs font-mono">
                <span class="text-gray-500">ä½ç½®:</span>
                <a href="/admin/admin-question-bank.html" class="text-[#ff6b00] hover:text-white">é¢˜åº“</a>
                <span class="text-gray-600">/</span>
                <span class="text-white">é¢˜ç›®ç±»åˆ«</span>
            </div>
            <div class="flex items-center gap-3">
                <a href="/home.html" class="font-mono text-xs font-bold border border-gray-500 text-gray-400 px-4 py-2 hover:border-white hover:text-white transition-all uppercase tracking-wider">â† è¿”å›å‰å°</a>
                <button id="logout-btn" class="font-mono text-xs font-bold border border-[#ff6b00] text-[#ff6b00] px-4 py-2 hover:bg-[#ff6b00] hover:text-black transition-all uppercase tracking-wider">Logout_ç¦»çº¿</button>
            </div>
        </header>

        <main class="flex-1 flex flex-col pt-6 px-8 relative overflow-hidden">
            <div class="absolute inset-0 z-0 opacity-10 pointer-events-none" style="background-image: radial-gradient(#333 1px, transparent 1px); background-size: 20px 20px;"></div>
            
            <div class="relative z-10 w-full max-w-[1400px] mx-auto flex-1 flex flex-col">
                
                <!-- æ“ä½œæ  -->
                <div class="flex items-center justify-between mb-6">
                    <div class="flex items-center gap-4">
                        <a href="/admin/admin-question-bank.html" class="text-gray-500 hover:text-white font-mono text-sm">â† è¿”å›é¢˜åº“</a>
                        <h1 class="text-xl font-bold font-eng text-white">é¢˜ç›®ç±»åˆ«ç®¡ç†</h1>
                    </div>
                    <button onclick="showModal()" class="bg-[#ff6b00] text-black font-bold px-6 py-3 font-mono text-sm hover:bg-white transition-all" style="clip-path: polygon(8px 0, 100% 0, 100% 100%, 0 100%, 0 8px);">
                        + æ–°å¢ç±»åˆ«
                    </button>
                </div>

                <!-- æç¤ºä¿¡æ¯ -->
                <div class="bg-[#1a1a1a] border border-[#333] p-4 mb-6">
                    <p class="text-xs text-gray-500 font-mono">
                        <span class="text-[#ff6b00]">â—</span> é»˜è®¤ç±»åˆ«ï¼ˆWEBã€MISCã€PWNã€REVERSEã€CRYPTOã€OSINTï¼‰ä¸å¯åˆ é™¤å’Œé‡å‘½å
                    </p>
                    <p class="text-xs text-gray-500 font-mono mt-1">
                        <span class="text-[#ff6b00]">â—</span> è‡ªå®šä¹‰ç±»åˆ«å¯ä¸Šä¼ 1:1æ¯”ä¾‹çš„å›¾æ ‡ï¼Œæœªä¸Šä¼ å›¾æ ‡æ—¶å°†æ˜¾ç¤ºç±»åˆ«åç§°å‘å…‰å­—æ ·
                    </p>
                </div>

                <!-- è¡¨æ ¼ -->
                <div class="bg-[#1a1a1a] border border-[#333] overflow-hidden">
                    <div style="max-height: 665px; overflow-y: auto;">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>å›¾æ ‡</th>
                                <th>ç±»åˆ«åç§°</th>
                                <th>å‘å…‰é¢œè‰²</th>
                                <th>ç±»å‹</th>
                                <th>åˆ›å»ºæ—¶é—´</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="category-list">
                            <tr><td colspan="7" class="text-center text-gray-500 py-8">åŠ è½½ä¸­...</td></tr>
                        </tbody>
                    </table>
                    </div>
                </div>

            </div>

            <footer class="py-1 border-t border-[#333] flex items-center justify-center flex-shrink-0 mt-auto">
                <div class="flex items-center justify-center gap-4 text-xs flex-wrap">
                    <div class="flex items-center gap-1">
                        <div class="bg-[#ff6b00] text-black font-black px-1.5 py-0.5 font-eng tracking-tighter">TG</div>
                        <span class="text-gray-500">å¤©æ ¼åå°ç®¡ç†ç³»ç»Ÿ</span>
                    </div>
                    <span class="text-white font-mono">Copyright Â© 2021-present tan91. All Rights Reserved.</span>
                </div>
            </footer>
        </main>
    </div>

    <!-- æ–°å¢/ç¼–è¾‘å¼¹çª— -->
    <div id="modal" class="modal-overlay">
        <div class="modal-content">
            <div class="p-6 border-b border-[#333] flex justify-between items-center">
                <h2 class="text-lg font-bold font-eng" id="modal-title">æ–°å¢é¢˜ç›®ç±»åˆ«</h2>
                <button onclick="hideModal()" class="text-gray-500 hover:text-white text-2xl">&times;</button>
            </div>
            <form id="category-form" class="p-6 space-y-6">
                <input type="hidden" id="form-id">
                <input type="hidden" id="form-clear-icon">
                
                <div>
                    <label class="form-label">ç±»åˆ«åç§° *</label>
                    <input type="text" id="form-name" class="form-input" placeholder="å¦‚ï¼šBLOCKCHAIN" required>
                </div>

                <div>
                    <label class="form-label">å›¾æ ‡ä¸Šä¼  (1:1æ¯”ä¾‹ï¼Œå¯é€‰)</label>
                    <div class="flex items-center gap-4">
                        <div id="icon-preview" class="w-16 h-16 bg-[#222] border border-[#444] flex items-center justify-center text-[#ff6b00] font-bold text-sm" style="text-shadow: 0 0 10px #ff6b00;">é¢„è§ˆ</div>
                        <div class="flex-1">
                            <input type="file" id="form-icon-file" accept="image/*" class="hidden">
                            <input type="hidden" id="form-icon">
                            <button type="button" onclick="document.getElementById('form-icon-file').click()" class="border border-[#333] text-gray-400 px-4 py-2 hover:border-[#ff6b00] hover:text-[#ff6b00] transition-all font-mono text-sm">é€‰æ‹©å›¾ç‰‡</button>
                            <button type="button" onclick="clearIcon()" class="border border-[#333] text-gray-400 px-4 py-2 hover:border-red-500 hover:text-red-500 transition-all font-mono text-sm ml-2">æ¸…é™¤</button>
                            <p class="text-xs text-gray-600 mt-2">ä¸ä¸Šä¼ åˆ™æ˜¾ç¤ºç±»åˆ«åç§°å‘å…‰å­—æ ·</p>
                        </div>
                    </div>
                </div>

                <div>
                    <label class="form-label">å‘å…‰é¢œè‰² (å¯é€‰)</label>
                    <div class="flex items-center gap-3">
                        <input type="color" id="form-color-picker" class="w-12 h-10 bg-transparent border border-[#333] cursor-pointer" value="#ff6b00">
                        <input type="text" id="form-glow-color" class="form-input flex-1" placeholder="#ff6b00 æˆ– rgb(255, 107, 0)" value="#ff6b00">
                    </div>
                    <p class="text-xs text-gray-600 mt-2">æ”¯æŒåå…­è¿›åˆ¶(#RRGGBB)æˆ–RGBæ ¼å¼ï¼Œç”¨äºæ— å›¾æ ‡æ—¶çš„å‘å…‰æ•ˆæœ</p>
                </div>

                <div class="flex gap-4 pt-4">
                    <button type="button" onclick="hideModal()" class="flex-1 border border-[#333] text-gray-400 py-3 hover:border-white hover:text-white transition-all font-mono">å–æ¶ˆ</button>
                    <button type="submit" class="flex-1 bg-[#ff6b00] text-black py-3 font-bold hover:bg-white transition-all font-mono">ä¿å­˜</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        function parseJwt(token) {
            try {
                const base64Url = token.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const jsonPayload = decodeURIComponent(atob(base64).split('').map(c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join(''));
                return JSON.parse(jsonPayload);
            } catch (e) { return null; }
        }

        const token = localStorage.getItem('tg_token');
        if (!token) {
            window.location.href = '/login.html';
        } else {
            const payload = parseJwt(token);
            if (!payload || payload.role !== 'super') {
                alert('æƒé™ä¸è¶³');
                window.location.href = '/home.html';
            }
        }

        document.getElementById('logout-btn').addEventListener('click', () => {
            localStorage.removeItem('tg_token');
            window.location.href = '/login.html';
        });

        let categories = [];

        // åå…­è¿›åˆ¶è½¬ RGB æ ¼å¼
        function hexToRgb(hex) {
            if (!hex || !hex.startsWith('#')) return '';
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            if (!result) return '';
            const r = parseInt(result[1], 16);
            const g = parseInt(result[2], 16);
            const b = parseInt(result[3], 16);
            return `rgb(${r}, ${g}, ${b})`;
        }

        async function loadCategories() {
            try {
                const res = await fetch('/api/admin/categories', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                if (!res.ok) throw new Error('Failed');
                categories = await res.json();
                renderCategories();
            } catch (e) {
                console.error(e);
                document.getElementById('category-list').innerHTML = '<tr><td colspan="7" class="text-center text-red-500 py-8">åŠ è½½å¤±è´¥</td></tr>';
            }
        }

        function renderCategories() {
            const tbody = document.getElementById('category-list');
            if (categories.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center text-gray-500 py-8">æš‚æ— æ•°æ®</td></tr>';
                return;
            }

            tbody.innerHTML = categories.map(cat => {
                const glowColor = cat.glowColor || '#ff6b00';
                // è½¬æ¢ä¸ºRGBæ˜¾ç¤º
                const rgbDisplay = hexToRgb(glowColor);
                return `
                <tr>
                    <td class="font-mono text-gray-400">${cat.id}</td>
                    <td>
                        ${cat.iconUrl 
                            ? `<img src="${cat.iconUrl}" class="w-10 h-10 object-cover border border-[#444]">`
                            : `<div class="category-icon font-bold" style="color: ${glowColor}; text-shadow: 0 0 10px ${glowColor};">${cat.name}</div>`
                        }
                    </td>
                    <td>
                        <span class="font-bold text-white">${cat.name}</span>
                    </td>
                    <td>
                        ${!cat.iconUrl ? `
                            <div class="flex items-center gap-2">
                                <span class="w-4 h-4 rounded" style="background: ${glowColor}; box-shadow: 0 0 6px ${glowColor};"></span>
                                <div class="text-xs font-mono">
                                    <div style="color: ${glowColor};">${glowColor.toUpperCase()}</div>
                                    <div class="text-gray-500">${rgbDisplay}</div>
                                </div>
                            </div>
                        ` : '<span class="text-gray-600 text-xs">ä½¿ç”¨å›¾æ ‡</span>'}
                    </td>
                    <td>
                        ${cat.isDefault 
                            ? '<span class="default-badge">é»˜è®¤</span>'
                            : '<span class="text-gray-500 text-xs">è‡ªå®šä¹‰</span>'
                        }
                    </td>
                    <td class="font-mono text-xs text-gray-500">${new Date(cat.createdAt).toLocaleDateString()}</td>
                    <td>
                        <div class="flex gap-2">
                            <button onclick="editCategory(${cat.id})" class="btn-action btn-edit">ç¼–è¾‘</button>
                            ${!cat.isDefault 
                                ? `<button onclick="deleteCategory(${cat.id}, '${cat.name}')" class="btn-action btn-delete">åˆ é™¤</button>`
                                : ''
                            }
                        </div>
                    </td>
                </tr>
            `;
            }).join('');
        }

        function showModal(isEdit = false) {
            document.getElementById('modal').classList.add('active');
            document.getElementById('modal-title').textContent = isEdit ? 'ç¼–è¾‘é¢˜ç›®ç±»åˆ«' : 'æ–°å¢é¢˜ç›®ç±»åˆ«';
            if (!isEdit) {
                document.getElementById('category-form').reset();
                document.getElementById('form-id').value = '';
                document.getElementById('form-clear-icon').value = ''; // é‡ç½®æ¸…é™¤æ ‡è®°
                document.getElementById('form-glow-color').value = '#ff6b00';
                document.getElementById('form-color-picker').value = '#ff6b00';
                updateIconPreview(null, 'é¢„è§ˆ', '#ff6b00');
            }
        }

        function hideModal() {
            document.getElementById('modal').classList.remove('active');
        }

        function editCategory(id) {
            const cat = categories.find(c => c.id === id);
            if (!cat) return;
            
            document.getElementById('form-id').value = cat.id;
            document.getElementById('form-name').value = cat.name;
            document.getElementById('form-icon').value = cat.iconUrl || '';
            document.getElementById('form-clear-icon').value = ''; // é‡ç½®æ¸…é™¤æ ‡è®°
            
            // è®¾ç½®é¢œè‰²
            const glowColor = cat.glowColor || '#ff6b00';
            document.getElementById('form-glow-color').value = glowColor;
            // å°è¯•è®¾ç½®é¢œè‰²é€‰æ‹©å™¨ï¼ˆåªæ”¯æŒåå…­è¿›åˆ¶ï¼‰
            if (glowColor.startsWith('#')) {
                document.getElementById('form-color-picker').value = glowColor;
            }
            
            // æ›´æ–°é¢„è§ˆ
            updateIconPreview(cat.iconUrl, cat.name, glowColor);
            
            // é»˜è®¤ç±»åˆ«ç¦æ­¢ä¿®æ”¹åç§°
            document.getElementById('form-name').disabled = cat.isDefault;
            
            showModal(true);
        }

        function updateIconPreview(iconUrl, name, glowColor) {
            const preview = document.getElementById('icon-preview');
            const color = glowColor || document.getElementById('form-glow-color').value || '#ff6b00';
            if (iconUrl) {
                preview.innerHTML = `<img src="${iconUrl}" class="w-full h-full object-cover">`;
                preview.style.color = '';
                preview.style.textShadow = '';
            } else {
                preview.innerHTML = name || 'é¢„è§ˆ';
                preview.style.color = color;
                preview.style.textShadow = `0 0 10px ${color}`;
            }
        }

        function clearIcon() {
            document.getElementById('form-icon').value = '';
            document.getElementById('form-icon-file').value = '';
            document.getElementById('form-clear-icon').value = 'true'; // æ ‡è®°éœ€è¦æ¸…é™¤å›¾æ ‡
            const name = document.getElementById('form-name').value || 'é¢„è§ˆ';
            const glowColor = document.getElementById('form-glow-color').value || '#ff6b00';
            updateIconPreview(null, name, glowColor);
        }

        // å›¾ç‰‡ä¸Šä¼ å¤„ç†
        document.getElementById('form-icon-file').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            // è½¬ä¸ºBase64ç”¨äºé¢„è§ˆå’Œå­˜å‚¨ï¼ˆç®€åŒ–å¤„ç†ï¼‰
            const reader = new FileReader();
            reader.onload = (event) => {
                const dataUrl = event.target.result;
                document.getElementById('form-icon').value = dataUrl;
                document.getElementById('form-clear-icon').value = ''; // é‡ç½®æ¸…é™¤æ ‡è®°
                updateIconPreview(dataUrl, null);
            };
            reader.readAsDataURL(file);
        });

        // åç§°è¾“å…¥æ—¶æ›´æ–°é¢„è§ˆ
        document.getElementById('form-name').addEventListener('input', (e) => {
            const iconUrl = document.getElementById('form-icon').value;
            if (!iconUrl) {
                const glowColor = document.getElementById('form-glow-color').value || '#ff6b00';
                updateIconPreview(null, e.target.value || 'é¢„è§ˆ', glowColor);
            }
        });

        // é¢œè‰²é€‰æ‹©å™¨è”åŠ¨
        document.getElementById('form-color-picker').addEventListener('input', (e) => {
            document.getElementById('form-glow-color').value = e.target.value;
            const iconUrl = document.getElementById('form-icon').value;
            if (!iconUrl) {
                const name = document.getElementById('form-name').value || 'é¢„è§ˆ';
                updateIconPreview(null, name, e.target.value);
            }
        });

        // é¢œè‰²è¾“å…¥æ¡†è”åŠ¨
        document.getElementById('form-glow-color').addEventListener('input', (e) => {
            // å°è¯•åŒæ­¥åˆ°é¢œè‰²é€‰æ‹©å™¨
            const val = e.target.value.trim();
            if (val.match(/^#[0-9a-fA-F]{6}$/)) {
                document.getElementById('form-color-picker').value = val;
            }
            const iconUrl = document.getElementById('form-icon').value;
            if (!iconUrl) {
                const name = document.getElementById('form-name').value || 'é¢„è§ˆ';
                updateIconPreview(null, name, val);
            }
        });

        async function deleteCategory(id, name) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤ç±»åˆ«"${name}"å—ï¼Ÿ`)) return;
            
            try {
                const res = await fetch(`/api/admin/categories/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                
                if (!res.ok) {
                    const data = await res.json();
                    if (data.error === 'CATEGORY_IN_USE') {
                        alert(`è¯¥ç±»åˆ«æ­£åœ¨è¢«${data.count}ä¸ªé¢˜ç›®ä½¿ç”¨ï¼Œæ— æ³•åˆ é™¤`);
                    } else {
                        alert('åˆ é™¤å¤±è´¥: ' + data.error);
                    }
                    return;
                }
                
                loadCategories();
            } catch (e) {
                console.error(e);
                alert('åˆ é™¤å¤±è´¥');
            }
        }

        document.getElementById('category-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const id = document.getElementById('form-id').value;
            const data = {
                name: document.getElementById('form-name').value,
                iconUrl: document.getElementById('form-icon').value,
                clearIcon: document.getElementById('form-clear-icon').value === 'true',
                glowColor: document.getElementById('form-glow-color').value || '#ff6b00'
            };
            
            try {
                const res = await fetch(id ? `/api/admin/categories/${id}` : '/api/admin/categories', {
                    method: id ? 'PUT' : 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + token,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                if (!res.ok) {
                    const err = await res.json();
                    alert('ä¿å­˜å¤±è´¥: ' + err.error);
                    return;
                }
                
                hideModal();
                loadCategories();
            } catch (e) {
                console.error(e);
                alert('ä¿å­˜å¤±è´¥');
            }
        });

        loadCategories();
    </script>

</body>
</html>
