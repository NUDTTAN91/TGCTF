<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="author" content="tan91">
    <title>修改密码 - 天格平台</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@400;600;700&family=JetBrains+Mono:wght@400;700&family=Noto+Sans+SC:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #0f0f0f;
            --bg-panel: #1a1a1a;
            --accent: #ff6b00;
            --text-main: #e0e0e0;
            --text-dim: #555;
        }
        body { background-color: var(--bg-dark); color: var(--text-main); font-family: 'Noto Sans SC', sans-serif; overflow: hidden; }
        .font-eng { font-family: 'Chakra Petch', sans-serif; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        
        /* 动态网格背景 */
        .perspective-grid {
            position: absolute;
            width: 200%;
            height: 200%;
            top: -50%;
            left: -50%;
            background-image: 
                linear-gradient(rgba(255, 107, 0, 0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 107, 0, 0.05) 1px, transparent 1px);
            background-size: 50px 50px;
            transform: perspective(500px) rotateX(60deg);
            animation: grid-move 20s linear infinite;
            z-index: -1;
            mask-image: radial-gradient(circle, black 0%, transparent 70%);
        }
        @keyframes grid-move {
            0% { transform: perspective(500px) rotateX(60deg) translateY(0); }
            100% { transform: perspective(500px) rotateX(60deg) translateY(50px); }
        }

        /* 战术边框 */
        .access-panel {
            background: rgba(26, 26, 26, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid #333;
            box-shadow: 0 0 50px rgba(0,0,0,0.8);
        }
        .corner-accent {
            position: absolute;
            width: 10px;
            height: 10px;
            border: 2px solid var(--accent);
            transition: all 0.3s ease;
        }
        .c-tl { top: -1px; left: -1px; border-right: none; border-bottom: none; }
        .c-tr { top: -1px; right: -1px; border-left: none; border-bottom: none; }
        .c-bl { bottom: -1px; left: -1px; border-right: none; border-top: none; }
        .c-br { bottom: -1px; right: -1px; border-left: none; border-top: none; }

        /* 输入框样式 */
        .tactical-input {
            background: #111;
            border: 1px solid #333;
            color: white;
            transition: all 0.3s;
        }
        .tactical-input:focus {
            outline: none;
            border-color: var(--accent);
            background: #000;
        }

        /* 扫描线 */
        .scan-line {
            width: 100%;
            height: 2px;
            background: rgba(255, 107, 0, 0.3);
            position: fixed;
            top: 0;
            z-index: 50;
            animation: scan 8s linear infinite;
            pointer-events: none;
        }
        @keyframes scan { 0% { top: -10%; } 100% { top: 110%; } }

        /* 密码要求列表 */
        .pwd-rule {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 11px;
            color: #666;
            transition: color 0.2s;
        }
        .pwd-rule.valid { color: #22c55e; }
        .pwd-rule.invalid { color: #ef4444; }
        .pwd-rule .icon { width: 12px; height: 12px; }
    </style>
</head>
<body class="h-screen flex flex-col justify-center items-center relative">

    <!-- 背景特效 -->
    <div class="perspective-grid"></div>
    <div class="scan-line"></div>
    
    <!-- 顶部极简栏 -->
    <div class="absolute top-0 w-full p-6 flex justify-between items-center text-xs font-mono text-gray-500 z-10">
        <div class="flex items-center gap-2">
            <span class="w-2 h-2 bg-[#ff6b00]"></span>
            <span>SECURITY_UPDATE_REQUIRED</span>
        </div>
        <div>
            <span class="text-[#ff6b00] animate-pulse">⚠ MANDATORY</span>
        </div>
    </div>

    <!-- 主内容区 -->
    <main class="container mx-auto px-6 flex flex-col items-center justify-center z-20">
        
        <!-- 修改密码面板 -->
        <div class="relative w-full max-w-md">
            <div class="access-panel p-8 relative">
                <!-- 四个角的装饰 -->
                <div class="corner-accent c-tl"></div>
                <div class="corner-accent c-tr"></div>
                <div class="corner-accent c-bl"></div>
                <div class="corner-accent c-br"></div>

                <div class="text-center mb-6">
                    <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-[#ff6b00]/20 flex items-center justify-center">
                        <svg class="w-8 h-8 text-[#ff6b00]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
                        </svg>
                    </div>
                    <h2 class="text-xl font-bold text-white font-eng tracking-widest">PASSWORD UPDATE</h2>
                    <p class="text-[10px] text-gray-500 font-mono mt-1">首次登录必须修改密码</p>
                </div>

                <!-- 警告提示 -->
                <div class="bg-[#ff6b00]/10 border border-[#ff6b00]/30 rounded p-3 mb-6 text-xs text-[#ff6b00]">
                    <p class="font-bold mb-1">⚠ 安全提示</p>
                    <p class="text-[10px] opacity-80">您的账户使用默认密码(123456)，请设置一个高强度密码以确保账户安全。</p>
                </div>

                <!-- 修改密码表单 -->
                <form class="space-y-4" id="change-password-form">
                    <div>
                        <label class="block text-[10px] font-mono text-[#ff6b00] mb-1 uppercase tracking-wider">New Password // 新密码</label>
                        <input type="password" id="newPassword" name="newPassword" class="tactical-input w-full px-4 py-3 font-mono text-sm" placeholder="输入新密码" required>
                    </div>
                    <div>
                        <label class="block text-[10px] font-mono text-[#ff6b00] mb-1 uppercase tracking-wider">Confirm Password // 确认密码</label>
                        <input type="password" id="confirmPassword" name="confirmPassword" class="tactical-input w-full px-4 py-3 font-mono text-sm" placeholder="再次输入新密码" required>
                    </div>

                    <!-- 密码要求 -->
                    <div class="bg-[#111] border border-[#333] rounded p-3 space-y-2">
                        <p class="text-[10px] text-gray-500 font-mono mb-2">密码要求 / PASSWORD REQUIREMENTS:</p>
                        <div class="pwd-rule" id="rule-length">
                            <span class="icon">○</span> 至少8位字符
                        </div>
                        <div class="pwd-rule" id="rule-upper">
                            <span class="icon">○</span> 包含大写字母 (A-Z)
                        </div>
                        <div class="pwd-rule" id="rule-lower">
                            <span class="icon">○</span> 包含小写字母 (a-z)
                        </div>
                        <div class="pwd-rule" id="rule-digit">
                            <span class="icon">○</span> 包含数字 (0-9)
                        </div>
                        <div class="pwd-rule" id="rule-special">
                            <span class="icon">○</span> 包含特殊符号 (!@#$%^&*等)
                        </div>
                        <div class="pwd-rule" id="rule-match">
                            <span class="icon">○</span> 两次密码输入一致
                        </div>
                    </div>

                    <!-- 提交按钮 -->
                    <button type="submit" id="submit-btn" disabled class="w-full bg-gray-700 text-gray-400 font-bold py-3 uppercase tracking-widest text-sm cursor-not-allowed transition-all">
                        确认修改_
                    </button>
                </form>
                
                <!-- 底部状态条 -->
                <div class="mt-6 pt-4 border-t border-[#333] flex justify-between text-[10px] text-gray-600 font-mono" id="status-bar">
                    <span>STATUS: AWAITING_UPDATE</span>
                    <span class="text-yellow-600">● PENDING</span>
                </div>
            </div>
        </div>
    </main>

    <!-- 底部版权 -->
    <footer class="absolute bottom-4 text-center z-20">
        <p class="text-[10px] text-[#333] font-mono tracking-widest">
            Copyright © 2021-present tan91. All Rights Reserved.
        </p>
    </footer>

    <script>
        // 检查是否有token和mustChangePassword标记
        const token = localStorage.getItem('tg_token');
        const mustChange = localStorage.getItem('tg_must_change_password');
        
        if (!token) {
            // 没有登录，跳转到登录页
            window.location.href = '/login.html';
        }
        
        if (mustChange !== 'true') {
            // 不需要强制修改密码，跳转到首页
            window.location.href = '/home.html';
        }

        const form = document.getElementById('change-password-form');
        const newPwdInput = document.getElementById('newPassword');
        const confirmPwdInput = document.getElementById('confirmPassword');
        const submitBtn = document.getElementById('submit-btn');
        const statusBar = document.getElementById('status-bar');

        // 密码规则检测
        const rules = {
            length: { el: document.getElementById('rule-length'), check: pwd => pwd.length >= 8 },
            upper: { el: document.getElementById('rule-upper'), check: pwd => /[A-Z]/.test(pwd) },
            lower: { el: document.getElementById('rule-lower'), check: pwd => /[a-z]/.test(pwd) },
            digit: { el: document.getElementById('rule-digit'), check: pwd => /[0-9]/.test(pwd) },
            special: { el: document.getElementById('rule-special'), check: pwd => /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?~]/.test(pwd) }
        };
        const ruleMatch = document.getElementById('rule-match');

        function validatePassword() {
            const newPwd = newPwdInput.value;
            const confirmPwd = confirmPwdInput.value;
            let allValid = true;

            // 检查每条规则
            for (const [key, rule] of Object.entries(rules)) {
                const valid = rule.check(newPwd);
                rule.el.classList.toggle('valid', valid);
                rule.el.classList.toggle('invalid', newPwd.length > 0 && !valid);
                rule.el.querySelector('.icon').textContent = valid ? '✓' : '○';
                if (!valid) allValid = false;
            }

            // 检查两次密码是否一致
            const match = confirmPwd.length > 0 && newPwd === confirmPwd;
            ruleMatch.classList.toggle('valid', match);
            ruleMatch.classList.toggle('invalid', confirmPwd.length > 0 && !match);
            ruleMatch.querySelector('.icon').textContent = match ? '✓' : '○';
            if (!match) allValid = false;

            // 更新提交按钮状态
            if (allValid && confirmPwd.length > 0) {
                submitBtn.disabled = false;
                submitBtn.classList.remove('bg-gray-700', 'text-gray-400', 'cursor-not-allowed');
                submitBtn.classList.add('bg-[#ff6b00]', 'text-black', 'hover:bg-white', 'shadow-[0_0_15px_rgba(255,107,0,0.4)]');
            } else {
                submitBtn.disabled = true;
                submitBtn.classList.add('bg-gray-700', 'text-gray-400', 'cursor-not-allowed');
                submitBtn.classList.remove('bg-[#ff6b00]', 'text-black', 'hover:bg-white', 'shadow-[0_0_15px_rgba(255,107,0,0.4)]');
            }

            return allValid;
        }

        newPwdInput.addEventListener('input', validatePassword);
        confirmPwdInput.addEventListener('input', validatePassword);

        // 阻止复制粘贴到确认密码框
        confirmPwdInput.addEventListener('paste', (e) => {
            e.preventDefault();
            alert('请手动输入确认密码');
        });

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!validatePassword()) {
                alert('请满足所有密码要求');
                return;
            }

            const newPassword = newPwdInput.value;

            statusBar.querySelector('span').textContent = 'STATUS: UPDATING...';
            submitBtn.disabled = true;
            submitBtn.textContent = '处理中...';

            try {
                const resp = await fetch('/api/profile/password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token
                    },
                    body: JSON.stringify({ newPassword })
                });

                const data = await resp.json();

                if (!resp.ok) {
                    if (data.error === 'WRONG_PASSWORD') {
                        throw new Error('当前密码错误');
                    } else if (data.error === 'WEAK_PASSWORD') {
                        throw new Error(data.message || '密码强度不足');
                    }
                    throw new Error(data.message || '修改失败');
                }

                // 清除强制修改密码标记
                localStorage.removeItem('tg_must_change_password');
                
                statusBar.querySelector('span').textContent = 'STATUS: UPDATED';
                statusBar.querySelector('span:last-child').textContent = '● SUCCESS';
                statusBar.querySelector('span:last-child').className = 'text-green-500';

                alert('密码修改成功！即将跳转到首页');
                window.location.href = '/home.html';

            } catch (err) {
                statusBar.querySelector('span').textContent = 'STATUS: ERROR';
                statusBar.querySelector('span:last-child').textContent = '● FAILED';
                statusBar.querySelector('span:last-child').className = 'text-red-500';
                alert(err.message || '修改失败');
                submitBtn.disabled = false;
                submitBtn.textContent = '确认修改_';
                validatePassword(); // 重新验证以恢复按钮状态
            }
        });

        // 防止用户通过修改URL绕过
        window.addEventListener('beforeunload', (e) => {
            if (localStorage.getItem('tg_must_change_password') === 'true') {
                // 如果还没修改密码就要离开，清除token强制重新登录
                // 这里不能直接阻止，但可以在其他页面检测
            }
        });

        // 禁止后退
        history.pushState(null, null, location.href);
        window.addEventListener('popstate', function () {
            history.pushState(null, null, location.href);
        });
    </script>

</body>
</html>
