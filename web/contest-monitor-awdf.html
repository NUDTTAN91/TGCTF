<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TG AWD-F MONITOR // æ”»é˜²æ€åŠ¿æ„ŸçŸ¥</title>
    <script src="/assets/js/tailwind.min.js"></script>
    <script src="/assets/js/chart.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@400;600;700&family=JetBrains+Mono:wght@400;700&family=Noto+Sans+SC:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0b0c10;
            --panel: #141416;
            --accent: #ff6b00;
            --border: #2a2a2a;
            --text-main: #e0e0e0;
            --text-dim: #777;
            --gold: #ffd700;
            --silver: #c0c0c0;
            --bronze: #cd7f32;
            --danger: #ef4444;
            --success: #22c55e;
            --info: #3b82f6;
        }
        body { background-color: var(--bg); color: var(--text-main); font-family: 'Noto Sans SC', sans-serif; overflow: hidden; }
        .font-eng { font-family: 'Chakra Petch', sans-serif; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }

        /* é¡¶éƒ¨æ  */
        .header {
            height: 80px; display: flex; align-items: center; justify-content: space-between;
            padding: 0 40px; background: #0f0f12; border-bottom: 2px solid var(--accent);
            box-shadow: 0 5px 20px rgba(0,0,0,0.5);
        }
        .title { font-size: 2.5rem; font-weight: 900; letter-spacing: 2px; text-transform: uppercase; color: white; white-space: nowrap; overflow: hidden; }
        .timer { font-size: 2.5rem; font-weight: bold; color: var(--accent); font-family: 'Chakra Petch'; }

        /* é€šç”¨é¢æ¿ */
        .panel { background: var(--panel); border: 1px solid var(--border); border-radius: 4px; display: flex; flex-direction: column; overflow: hidden; }
        .panel-header {
            padding: 12px 20px; background: #1a1a1d; border-bottom: 1px solid var(--border);
            font-family: 'Chakra Petch', sans-serif; font-weight: bold; font-size: 1.1rem; color: #aaa;
            display: flex; justify-content: space-between; align-items: center; flex-shrink: 0;
        }
        .panel-content { flex: 1; min-height: 0; overflow: hidden; }

        /* å·¦ä¾§æ’è¡Œæ¦œè¡¨æ ¼ */
        .rank-container { flex: 1; overflow: hidden; position: relative; }
        .rank-table { width: 100%; border-collapse: collapse; }
        .rank-row { 
            border-bottom: 1px solid #222; transition: opacity 0.5s; 
            height: 60px;
        } 
        .rank-row td { padding: 0 15px; vertical-align: middle; }
        
        /* æ’åå¾½ç«  */
        .rank-badge { 
            width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;
            font-weight: bold; font-family: 'Chakra Petch'; border-radius: 4px; background: #222; color: #888;
        }
        .r-1 .rank-badge { background: var(--gold); color: black; box-shadow: 0 0 10px rgba(255,215,0,0.3); }
        .r-2 .rank-badge { background: var(--silver); color: black; }
        .r-3 .rank-badge { background: var(--bronze); color: black; }

        /* ç¿»é¡µè¿›åº¦æ¡ */
        .page-indicator { height: 4px; background: #222; width: 100%; position: absolute; bottom: 0; left: 0; }
        .page-progress { height: 100%; background: var(--accent); width: 0%; transition: width 10s linear; }

        /* è¶‹åŠ¿å›¾ */
        .chart-container { position: relative; flex: 1; min-height: 0; width: 100%; padding: 10px; }

        /* åº•éƒ¨æƒ…æŠ¥æµå¸ƒå±€ */
        .feed-grid { display: grid; grid-template-columns: 50% 50%; flex: 1; min-height: 0; overflow: hidden; }
        .feed-col { padding: 0; overflow-y: auto; border-right: 1px solid var(--border); display: flex; flex-direction: column; }
        .feed-col:last-child { border-right: none; }
        .feed-content { flex: 1; overflow-y: auto; }

        /* æˆ˜æŠ¥æ¡ç›® - ä½¿ç”¨è¡¨æ ¼å¸ƒå±€ */
        .feed-table { width: 100%; border-collapse: collapse; }
        .feed-table tr { border-bottom: 1px dashed #222; animation: fadeIn 0.5s; }
        .feed-table tr:last-child { border-bottom: none; }
        .feed-table td { padding: 10px 8px; font-size: 0.85rem; vertical-align: middle; }
        .feed-table .col-tag { width: 60px; }
        .feed-table .col-time { text-align: right; white-space: nowrap; }
        
        /* æ ‡ç­¾æ ·å¼ */
        .tag { padding: 2px 6px; border-radius: 2px; font-size: 0.75rem; font-weight: bold; font-family: 'JetBrains Mono'; white-space: nowrap; display: inline-block; }
        .tag-1st { background: rgba(255, 215, 0, 0.2); color: #ffd700; border: 1px solid #ffd700; animation: pulse 2s infinite; }
        .tag-2nd { background: rgba(192, 192, 192, 0.2); color: #c0c0c0; border: 1px solid #c0c0c0; }
        .tag-3rd { background: rgba(205, 127, 50, 0.2); color: #cd7f32; border: 1px solid #cd7f32; }
        .tag-solve { background: rgba(0, 255, 0, 0.1); color: #4dff88; border: 1px solid #4dff88; }
        .tag-try { background: rgba(59, 130, 246, 0.15); color: #60a5fa; border: 1px solid #3b82f6; }
        .tag-ban { background: rgba(239, 68, 68, 0.2); color: #f87171; border: 1px solid #ef4444; }
        .tag-cheat { background: rgba(239, 68, 68, 0.3); color: #f87171; border: 1px solid #ef4444; animation: pulse 2s infinite; }
        .tag-sys { background: #333; color: #aaa; border: 1px solid #555; }

        /* æ»šåŠ¨æ¡ */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: #111; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 2px; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
    </style>
</head>
<body class="h-screen w-screen overflow-hidden">

    <!-- 1. é¡¶éƒ¨ Header -->
    <header class="header shrink-0 z-20">
        <div class="w-1/4 text-gray-500 font-mono text-sm">TG_CTF_PLATFORM // AWD-F MONITOR</div>
        <div class="w-1/2 text-center">
            <div id="contest-name" class="title font-eng">TG AWD-F MONITOR</div>
        </div>
        <div class="w-1/4 text-right flex items-center justify-end gap-4">
            <span id="timer-label" class="text-xs text-gray-500 font-mono tracking-widest uppercase">Time Remaining</span>
            <div id="timer" class="timer">--:--:--</div>
        </div>
    </header>

    <!-- 2. ä¸»å†…å®¹åŒº (Grid) - å›ºå®šé«˜åº¦ä¸ºè§†çª—é«˜åº¦å‡header -->
    <main class="grid grid-cols-12 gap-4 p-4 bg-[#0b0c10] overflow-hidden" style="height: calc(100vh - 80px);">
        
        <!-- å·¦ä¾§ï¼šè‡ªåŠ¨ç¿»é¡µæ’è¡Œæ¦œ (25%) -->
        <div class="col-span-3 panel relative h-full">
            <div class="panel-header">
                <span>å®æ—¶æ’å (Live Ranking)</span>
                <div class="flex items-center gap-2">
                    <button id="pause-btn" onclick="togglePause()" class="text-xs px-2 py-1 border border-[#444] hover:border-[#ff6b00] text-gray-400 hover:text-[#ff6b00] transition font-mono">â–¶ AUTO</button>
                    <span class="text-xs text-[#ff6b00]" id="page-info">PAGE 1/1</span>
                </div>
            </div>
            
            <div class="rank-container" id="rank-container">
                <table class="rank-table">
                    <tbody id="rank-body">
                        <!-- JS å¡«å…… -->
                    </tbody>
                </table>
            </div>

            <!-- ç¿»é¡µè¿›åº¦æ¡ -->
            <div class="page-indicator"><div class="page-progress" id="page-progress"></div></div>
        </div>

        <!-- å³ä¾§ï¼šå›¾è¡¨ + åŠ¨æ€ (75%) - å›ºå®šé«˜åº¦æ¯”ä¾‹ -->
        <div class="col-span-9 flex flex-col gap-4 h-full overflow-hidden">
            
            <!-- ä¸ŠåŠéƒ¨åˆ†ï¼šå¾—åˆ†è¶‹åŠ¿å›¾ (50% é«˜åº¦) -->
            <div class="panel" style="flex: 1; min-height: 0;">
                <div class="panel-header">
                    <span>å¾—åˆ†è¶‹åŠ¿ (Top 5 Trend)</span>
                    <span class="text-xs text-gray-500">Auto-Refresh: 30s</span>
                </div>
                <div class="chart-container">
                    <canvas id="trendChart"></canvas>
                </div>
            </div>

            <!-- ä¸‹åŠéƒ¨åˆ†ï¼šç»¼åˆæƒ…æŠ¥æµ (50% é«˜åº¦) -->
            <div class="panel" style="flex: 1; min-height: 0; max-height: 50%; overflow: hidden;">
                <div class="panel-header">
                    <span>æˆ˜åœºæƒ…æŠ¥ (Intel Feed)</span>
                    <span id="connection-status" class="text-xs text-green-500 animate-pulse">â— Connected</span>
                </div>
                
                <div class="feed-grid">
                    
                    <!-- å·¦åˆ†æ ï¼šé«˜å…‰æ—¶åˆ» (Top 3 Solves) -->
                    <div class="feed-col bg-[#111]">
                        <div class="p-2 text-xs text-gray-500 border-b border-[#222] font-mono bg-[#161616] flex-shrink-0">â˜… é«˜å…‰æ—¶åˆ» (First Bloods)</div>
                        <div id="highlight-feed" class="feed-content">
                            <!-- åŠ¨æ€å¡«å…… -->
                        </div>
                    </div>

                    <!-- å³åˆ†æ ï¼šå®æ—¶æµæ°´ (Live Stream) -->
                    <div class="feed-col">
                        <div class="p-2 text-xs text-gray-500 border-b border-[#222] font-mono bg-[#161616] flex-shrink-0">>> å®æ—¶æµæ°´ (Live Stream)</div>
                        <div id="live-feed" class="feed-content">
                            <!-- åŠ¨æ€å¡«å…… -->
                        </div>
                    </div>

                </div>
            </div>

        </div>

    </main>

    <script>
        // === é…ç½® ===
        const urlParams = new URLSearchParams(window.location.search);
        const contestId = urlParams.get('id');
        const token = localStorage.getItem('tg_token');

        if (!contestId) {
            document.body.innerHTML = '<div class="flex items-center justify-center h-screen text-2xl text-red-500 font-mono">ERROR: Contest ID not specified (AWD-F)</div>';
        }

        // === å…¨å±€æ•°æ® ===
        let allTeams = [];
        let currentPage = 0;
        let pageSize = 10;
        let trendChart = null;
        let contestStatus = 'pending'; // pending / running / ended / paused
        let startRemainingSeconds = 0; // å¼€å§‹å€’è®¡æ—¶
        let endRemainingSeconds = 0;   // ç»“æŸå€’è®¡æ—¶
        let contestStartTime = null;   // æ¯”èµ›å¼€å§‹æ—¶é—´
        let contestEndTime = null;     // æ¯”èµ›ç»“æŸæ—¶é—´
        let dataLoaded = false; // æ•°æ®æ˜¯å¦å·²åŠ è½½

        // === å€’è®¡æ—¶ ===
        function formatTime(seconds) {
            if (seconds <= 0) return '00:00:00';
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = Math.floor(seconds % 60);
            return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
        }

        function updateTimer() {
            // æ•°æ®æœªåŠ è½½å®Œæˆå‰ä¸æ“ä½œ
            if (!dataLoaded) return;
            
            const timerEl = document.getElementById('timer');
            const labelEl = document.getElementById('timer-label');
            
            if (contestStatus === 'pending') {
                // æ¯”èµ›æœªå¼€å§‹ï¼Œæ˜¾ç¤ºå¼€å§‹å€’è®¡æ—¶
                labelEl.textContent = 'Starts In';
                timerEl.style.color = '#facc15'; // é»„è‰²
                if (startRemainingSeconds > 0) {
                    startRemainingSeconds--;
                    timerEl.textContent = formatTime(startRemainingSeconds);
                } else {
                    // å¼€å§‹å€’è®¡æ—¶ç»“æŸï¼Œå‰ç«¯ä¸»åŠ¨åˆ‡æ¢åˆ° running çŠ¶æ€
                    contestStatus = 'running';
                    // æ ¹æ®ç»“æŸæ—¶é—´è®¡ç®—å‰©ä½™ç§’æ•°
                    if (contestEndTime) {
                        const now = new Date();
                        const end = new Date(contestEndTime);
                        endRemainingSeconds = Math.max(0, Math.floor((end - now) / 1000));
                    }
                    timerEl.textContent = formatTime(endRemainingSeconds);
                    labelEl.textContent = 'Time Remaining';
                    timerEl.style.color = '#ff6b00';
                    // åå°åˆ·æ–°æ•°æ®
                    loadMonitorData();
                }
            } else if (contestStatus === 'running') {
                // æ¯”èµ›è¿›è¡Œä¸­ï¼Œæ˜¾ç¤ºç»“æŸå€’è®¡æ—¶
                labelEl.textContent = 'Time Remaining';
                timerEl.style.color = '#ff6b00'; // æ©™è‰²
                if (endRemainingSeconds > 0) {
                    endRemainingSeconds--;
                    timerEl.textContent = formatTime(endRemainingSeconds);
                } else {
                    timerEl.textContent = '00:00:00';
                    labelEl.textContent = 'Ended';
                    timerEl.style.color = '#666';
                }
            } else if (contestStatus === 'ended') {
                timerEl.textContent = '00:00:00';
                labelEl.textContent = 'Ended';
                timerEl.style.color = '#666';
            } else if (contestStatus === 'paused') {
                labelEl.textContent = 'Paused';
                timerEl.style.color = '#f97316'; // æ©™è‰²
            }
        }
        setInterval(updateTimer, 1000);

        // === 1. è‡ªåŠ¨ç¿»é¡µæ’è¡Œæ¦œé€»è¾‘ ===
        const rowHeight = 60;

        function renderRankPage() {
            const container = document.getElementById('rank-container');
            const tbody = document.getElementById('rank-body');
            const pageInfo = document.getElementById('page-info');
            const progressBar = document.getElementById('page-progress');

            if (allTeams.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" class="text-center text-gray-500 py-8">æš‚æ— æ•°æ®</td></tr>';
                pageInfo.innerText = 'PAGE 0/0';
                return;
            }

            const containerHeight = container.clientHeight;
            // æ ¹æ®å®¹å™¨é«˜åº¦è‡ªé€‚åº”è®¡ç®—æ¯é¡µæ•°é‡
            pageSize = Math.max(Math.floor(containerHeight / rowHeight), 1);
            const totalPages = Math.ceil(allTeams.length / pageSize);
            
            const start = currentPage * pageSize;
            const end = start + pageSize;
            const pageData = allTeams.slice(start, end);

            tbody.innerHTML = '';
            pageData.forEach(t => {
                const rankClass = t.rank === 1 ? 'r-1' : (t.rank === 2 ? 'r-2' : (t.rank === 3 ? 'r-3' : ''));
                const scoreColor = t.rank <= 3 ? 'text-[#ff6b00]' : 'text-gray-400';
                const maxScore = allTeams[0]?.totalScore || 1;
                
                // å¤´åƒæ˜¾ç¤ºï¼šæœ‰å¤´åƒç”¨å¤´åƒï¼Œæ— åˆ™ç”¨é˜Ÿåé¦–å­—æ¯
                const avatarHtml = t.avatar 
                    ? `<img src="${t.avatar}" class="w-full h-full object-cover">`
                    : `<span class="text-sm font-bold ${t.rank <= 3 ? 'text-black' : 'text-gray-400'}">${t.teamName[0].toUpperCase()}</span>`;
                const avatarBg = t.rank === 1 ? 'bg-[#ffd700]' : (t.rank === 2 ? 'bg-[#c0c0c0]' : (t.rank === 3 ? 'bg-[#cd7f32]' : 'bg-[#222]'));
                
                tbody.innerHTML += `
                <tr class="rank-row ${rankClass}">
                    <td class="w-16 text-center"><div class="rank-badge">${t.rank}</div></td>
                    <td>
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 ${avatarBg} rounded-sm border border-[#333] flex items-center justify-center overflow-hidden flex-shrink-0">
                                ${avatarHtml}
                            </div>
                            <div class="flex-1 min-w-0">
                                <div class="font-bold text-white text-lg truncate">${escapeHtml(t.teamName)}</div>
                                <div class="w-full bg-[#222] h-1.5 mt-1 rounded overflow-hidden">
                                    <div class="bg-gray-600 h-full" style="width: ${(t.totalScore/maxScore)*100}%"></div>
                                </div>
                                <div class="flex gap-3 mt-1 text-sm font-medium">
                                    <span class="text-[#ff6b00]">âš”ï¸ æ”»å‡»: ${t.attackScore || 0}</span>
                                    <span class="text-green-400">ğŸ›¡ï¸ é˜²å®ˆ: ${t.defenseScore || 0}</span>
                                </div>
                            </div>
                        </div>
                    </td>
                    <td class="text-right">
                        <div class="${scoreColor} font-mono font-bold text-xl">${t.totalScore}</div>
                        <div class="text-xs text-gray-600">${t.solveCount} Solved</div>
                    </td>
                </tr>`;
            });

            pageInfo.innerText = `PAGE ${currentPage + 1} / ${totalPages}`;

            progressBar.style.transition = 'none';
            progressBar.style.width = '0%';
            setTimeout(() => {
                progressBar.style.transition = 'width 10s linear';
                progressBar.style.width = '100%';
            }, 50);

            currentPage++;
            if (currentPage >= totalPages) currentPage = 0;
        }

        // ç¿»é¡µç”±init()å¯åŠ¨
        // setInterval(renderRankPage, 10000);

        window.addEventListener('resize', () => {
            currentPage = 0;
            renderRankPage();
        });

        // === 2. è¶‹åŠ¿å›¾ ===
        const colors = [
            '#ffd700', '#c0c0c0', '#cd7f32', '#ef4444', '#3b82f6',
            '#a855f7', '#22c55e', '#f97316', '#06b6d4', '#ec4899'
        ];
        const lineWidths = [3, 3, 3, 2, 2];

        function initTrendChart() {
            const ctx = document.getElementById('trendChart').getContext('2d');
            Chart.defaults.color = '#666';
            Chart.defaults.font.family = 'JetBrains Mono';

            trendChart = new Chart(ctx, {
                type: 'line',
                data: { labels: [], datasets: [] },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { 
                        legend: { 
                            position: 'bottom',
                            labels: { color: '#888', font: { size: 10 }, boxWidth: 10 } 
                        } 
                    },
                    scales: {
                        x: { grid: { color: '#222' }, ticks: { color: '#666' } },
                        y: { grid: { color: '#222' }, ticks: { color: '#666' } }
                    },
                    animation: { duration: 500 }
                }
            });
        }

        async function loadTrendData() {
            try {
                const res = await fetch(`/api/contests/${contestId}/scoreboard/trend`, {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                if (!res.ok) return;
                const data = await res.json();
                
                if (!data.labels || data.labels.length === 0) return;

                trendChart.data.labels = data.labels;
                trendChart.data.datasets = (data.teams || []).map((team, i) => ({
                    label: team.name,
                    data: team.scores,
                    borderColor: colors[i % colors.length],
                    borderWidth: lineWidths[i] || 1,
                    tension: 0.3,
                    pointRadius: 0
                }));
                trendChart.update();
            } catch (e) {
                console.error('Load trend error:', e);
            }
        }

        // === 3. åŠ è½½ç»¼åˆæ•°æ® ===
        async function loadMonitorData() {
            try {
                const res = await fetch(`/api/contests/${contestId}/monitor`, {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                if (!res.ok) {
                    document.getElementById('connection-status').innerHTML = '<span class="text-red-500">â— Disconnected</span>';
                    return;
                }
                const data = await res.json();
                document.getElementById('connection-status').innerHTML = '<span class="text-green-500 animate-pulse">â— Connected</span>';

                // æ›´æ–°æ¯”èµ›ä¿¡æ¯
                if (data.contest) {
                    document.getElementById('contest-name').textContent = data.contest.name || 'TG AWD-F MONITOR';
                    fitTitle(); // è‡ªåŠ¨è°ƒæ•´æ ‡é¢˜å­—å·
                    document.title = `${data.contest.name} // MONITOR`;
                    contestStatus = data.contest.status || 'pending';
                    startRemainingSeconds = data.contest.startRemainingSeconds || 0;
                    endRemainingSeconds = data.contest.endRemainingSeconds || 0;
                    contestStartTime = data.contest.startTime || null;
                    contestEndTime = data.contest.endTime || null;
                    dataLoaded = true; // æ ‡è®°æ•°æ®å·²åŠ è½½
                    updateTimer(); // ç«‹å³æ›´æ–°æ˜¾ç¤º
                }

                // æ›´æ–°æ’è¡Œæ¦œ
                const newTeams = data.rankings || [];
                // åªæœ‰é˜Ÿä¼æ•°é‡å˜åŒ–æ—¶æ‰é‡ç½®é¡µç 
                if (allTeams.length !== newTeams.length && allTeams.length > 0) {
                    currentPage = 0;
                }
                allTeams = newTeams;

                // æ›´æ–°è§£é¢˜æµæ°´
                renderSolvesFeed(data.solves || [], data.events || []);

                // æ›´æ–°å¾—åˆ†è¶‹åŠ¿å›¾
                if (data.trend && data.trend.labels && data.trend.labels.length > 0 && trendChart) {
                    trendChart.data.labels = data.trend.labels;
                    trendChart.data.datasets = (data.trend.teams || []).map((team, i) => ({
                        label: team.name,
                        data: team.scores,
                        borderColor: colors[i % colors.length],
                        borderWidth: lineWidths[i] || 1,
                        tension: 0.3,
                        pointRadius: 0
                    }));
                    trendChart.update();
                }

            } catch (e) {
                console.error('Load monitor data error:', e);
                document.getElementById('connection-status').innerHTML = '<span class="text-red-500">â— Error</span>';
            }
        }

        // === 4. æ¸²æŸ“è§£é¢˜æµæ°´ ===
        function renderSolvesFeed(solves, events = []) {
            const highlightFeed = document.getElementById('highlight-feed');
            const liveFeed = document.getElementById('live-feed');

            // é«˜å…‰æ—¶åˆ»ï¼šä¸€äºŒä¸‰è¡€
            const bloods = solves.filter(s => s.bloodRank <= 3);
            if (bloods.length > 0) {
                highlightFeed.innerHTML = '<table class="feed-table">' + bloods.map(s => {
                    let tagClass = '', rowClass = '', teamColor = '';
                    let tagText = '';
                    if (s.bloodRank === 1) {
                        tagClass = 'tag-1st'; rowClass = 'bg-yellow-900 bg-opacity-10'; tagText = '1ST'; teamColor = 'text-[#ffd700]';
                    } else if (s.bloodRank === 2) {
                        tagClass = 'tag-2nd'; rowClass = 'bg-gray-800 bg-opacity-20'; tagText = '2ND'; teamColor = 'text-[#c0c0c0]';
                    } else if (s.bloodRank === 3) {
                        tagClass = 'tag-3rd'; rowClass = 'bg-orange-900 bg-opacity-10'; tagText = '3RD'; teamColor = 'text-[#cd7f32]';
                    }
                    const solveTimeHtml = s.solveTime ? `<span class="text-gray-400 text-xs">ç”¨æ—¶ ${s.solveTime}</span>` : '';
                    return `<tr class="${rowClass}">
                        <td class="col-tag"><span class="tag ${tagClass}">${tagText}</span></td>
                        <td><span class="font-bold ${teamColor}">${escapeHtml(s.teamName)}</span> <span class="text-gray-500">æ‹¿ä¸‹</span> <span class="text-[#ff6b00]">${escapeHtml(s.challengeName)}</span> ${solveTimeHtml}</td>
                        <td class="col-time text-gray-600 text-xs font-mono">${s.solvedAt}</td>
                    </tr>`;
                }).join('') + '</table>';
            } else {
                highlightFeed.innerHTML = '<div class="text-center text-gray-500 py-8 text-sm">æš‚æ— ä¸€è¡€è®°å½•</div>';
            }

            // å®æ—¶æµæ°´ï¼šè§£é¢˜ + å°è¯• + å°ç¦ç­‰äº‹ä»¶
            const allItems = [];
            
            // è§£é¢˜è®°å½•
            solves.forEach(s => {
                let tagClass = 'tag-solve';
                let tagText = 'SOLVED';
                if (s.bloodRank === 1) { tagClass = 'tag-1st'; tagText = '1ST'; }
                else if (s.bloodRank === 2) { tagClass = 'tag-2nd'; tagText = '2ND'; }
                else if (s.bloodRank === 3) { tagClass = 'tag-3rd'; tagText = '3RD'; }
                
                const solveTimeHtml = s.solveTime ? `<span class="text-gray-500 text-xs">ç”¨æ—¶ ${s.solveTime}</span>` : '';
                allItems.push({
                    time: s.solvedAt,
                    html: `<tr>
                        <td class="col-tag"><span class="tag ${tagClass}">${tagText}</span></td>
                        <td><span class="text-gray-300 font-bold">${escapeHtml(s.teamName)}</span> <span class="text-gray-500">è§£å‡º</span> <span class="text-gray-400">${escapeHtml(s.challengeName)}</span> ${solveTimeHtml}</td>
                        <td class="col-time text-gray-600 text-xs font-mono">${s.solvedAt}</td>
                    </tr>`
                });
            });
            
            // å…¶ä»–äº‹ä»¶ï¼ˆå°è¯•è§£é¢˜ã€å°ç¦ã€AWD-Fç‰¹æœ‰äº‹ä»¶ç­‰ï¼‰
            events.forEach(e => {
                let html = '';
                if (e.type === 'attempt') {
                    html = `<tr>
                        <td class="col-tag"><span class="tag tag-try">TRY</span></td>
                        <td><span class="text-cyan-400 font-bold">[${escapeHtml(e.userName || e.teamName)}]</span> <span class="text-gray-400">å°è¯•è§£é¢˜</span> <span class="text-orange-400 font-bold">[${escapeHtml(e.challengeName)}]</span></td>
                        <td class="col-time text-gray-600 text-xs font-mono">${e.time}</td>
                    </tr>`;
                } else if (e.type === 'ban') {
                    html = `<tr class="bg-red-900 bg-opacity-10">
                        <td class="col-tag"><span class="tag tag-ban">BAN</span></td>
                        <td><span class="text-red-400 font-bold">${escapeHtml(e.teamName)}</span> <span class="text-gray-500">å·²è¢«å°ç¦</span></td>
                        <td class="col-time text-gray-600 text-xs font-mono">${e.time}</td>
                    </tr>`;
                } else if (e.type === 'cheat') {
                    html = `<tr class="bg-red-900 bg-opacity-20">
                        <td class="col-tag"><span class="tag tag-cheat">CHEAT</span></td>
                        <td><span class="text-red-400 font-bold">${escapeHtml(e.teamName)}</span> <span class="text-gray-500">å› ä½œå¼Šè¢«å°ç¦</span></td>
                        <td class="col-time text-gray-600 text-xs font-mono">${e.time}</td>
                    </tr>`;
                } else if (e.type === 'round_start') {
                    // AWD-F: æ”»å‡»è½®æ¬¡å¼€å§‹
                    html = `<tr class="bg-blue-900 bg-opacity-10">
                        <td class="col-tag"><span class="tag" style="background: #3b82f6; color: white;">ROUND</span></td>
                        <td><span class="text-blue-400 font-bold">ğŸ”” ${escapeHtml(e.teamName)}</span> <span class="text-gray-400">æ”»å‡»å¼€å§‹</span></td>
                        <td class="col-time text-gray-600 text-xs font-mono">${e.time}</td>
                    </tr>`;
                } else if (e.type === 'defense_success') {
                    // AWD-F: é˜²å®ˆæˆåŠŸ
                    html = `<tr class="bg-green-900 bg-opacity-10">
                        <td class="col-tag"><span class="tag" style="background: #22c55e; color: white;">DEF</span></td>
                        <td><span class="text-green-400 font-bold">ğŸ›¡ï¸ ${escapeHtml(e.teamName)}</span> <span class="text-gray-400">é˜²å®ˆæˆåŠŸ</span> <span class="text-green-500 font-bold">${e.userName || ''}</span> <span class="text-gray-500">${escapeHtml(e.challengeName || '')}</span></td>
                        <td class="col-time text-gray-600 text-xs font-mono">${e.time}</td>
                    </tr>`;
                } else if (e.type === 'attack_success') {
                    // AWD-F: è¢«æ”»ç ´
                    html = `<tr class="bg-orange-900 bg-opacity-10">
                        <td class="col-tag"><span class="tag" style="background: #f97316; color: white;">ATK</span></td>
                        <td><span class="text-orange-400 font-bold">âš”ï¸ ${escapeHtml(e.teamName)}</span> <span class="text-gray-400">è¢«æ”»ç ´</span> <span class="text-gray-500">${escapeHtml(e.challengeName || '')}</span></td>
                        <td class="col-time text-gray-600 text-xs font-mono">${e.time}</td>
                    </tr>`;
                } else if (e.type === 'patch_submit') {
                    // AWD-F: è¡¥ä¸æäº¤
                    html = `<tr class="bg-purple-900 bg-opacity-5">
                        <td class="col-tag"><span class="tag" style="background: #a855f7; color: white;">PATCH</span></td>
                        <td><span class="text-purple-400 font-bold">ğŸ“¦ ${escapeHtml(e.teamName)}</span> <span class="text-gray-400">æäº¤è¡¥ä¸</span> <span class="text-gray-500">${escapeHtml(e.challengeName || '')}</span></td>
                        <td class="col-time text-gray-600 text-xs font-mono">${e.time}</td>
                    </tr>`;
                } else if (e.type === 'patch_applied') {
                    // AWD-F: è¡¥ä¸ç”Ÿæ•ˆ
                    html = `<tr class="bg-green-900 bg-opacity-5">
                        <td class="col-tag"><span class="tag" style="background: #16a34a; color: white;">OK</span></td>
                        <td><span class="text-green-400 font-bold">âœ… ${escapeHtml(e.teamName)}</span> <span class="text-gray-400">è¡¥ä¸ç”Ÿæ•ˆ</span> <span class="text-gray-500">${escapeHtml(e.challengeName || '')}</span></td>
                        <td class="col-time text-gray-600 text-xs font-mono">${e.time}</td>
                    </tr>`;
                } else if (e.type === 'patch_rejected') {
                    // AWD-F: è¡¥ä¸æ‹’ç»
                    html = `<tr class="bg-red-900 bg-opacity-5">
                        <td class="col-tag"><span class="tag" style="background: #dc2626; color: white;">FAIL</span></td>
                        <td><span class="text-red-400 font-bold">âŒ ${escapeHtml(e.teamName)}</span> <span class="text-gray-400">è¡¥ä¸å¤±è´¥</span> <span class="text-gray-500">${escapeHtml(e.challengeName || '')} ${e.userName ? '(' + escapeHtml(e.userName) + ')' : ''}</span></td>
                        <td class="col-time text-gray-600 text-xs font-mono">${e.time}</td>
                    </tr>`;
                } else if (e.type === 'container_reset') {
                    // AWD-F: å®¹å™¨é‡ç½®
                    html = `<tr class="bg-yellow-900 bg-opacity-5">
                        <td class="col-tag"><span class="tag" style="background: #eab308; color: black;">RESET</span></td>
                        <td><span class="text-yellow-400 font-bold">ğŸ”„ ${escapeHtml(e.teamName)}</span> <span class="text-gray-400">é‡ç½®å®¹å™¨</span> <span class="text-gray-500">${escapeHtml(e.challengeName || '')}</span></td>
                        <td class="col-time text-gray-600 text-xs font-mono">${e.time}</td>
                    </tr>`;
                }
                if (html) {
                    allItems.push({ time: e.time, html });
                }
            });
            
            if (allItems.length > 0) {
                // æŒ‰æ—¶é—´å€’åºæ’åˆ—ï¼Œæœ€æ–°çš„åœ¨å‰é¢
                allItems.sort((a, b) => b.time.localeCompare(a.time));
                liveFeed.innerHTML = '<table class="feed-table">' + allItems.map(item => item.html).join('') + '</table>';
            } else {
                liveFeed.innerHTML = '<div class="text-center text-gray-500 py-8 text-sm">æš‚æ— è®°å½•</div>';
            }
        }

        // === WebSocket å®æ—¶æ›´æ–° ===
        let ws = null;
        let wsReconnectTimer = null;

        function connectWebSocket() {
            const wsProtocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${wsProtocol}//${location.host}/api/contests/${contestId}/monitor/ws?token=${encodeURIComponent(token)}`;
            
            ws = new WebSocket(wsUrl);
            
            ws.onopen = () => {
                console.log('WebSocket connected');
                document.getElementById('connection-status').innerHTML = '<span class="text-green-500 animate-pulse">â— Live</span>';
            };
            
            ws.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    console.log('[Monitor WS] Received data:', data);
                    
                    if (data.type === 'update') {
                        // æ›´æ–°æ’è¡Œæ¦œ
                        if (data.rankings) {
                            const newTeams = data.rankings;
                            if (allTeams.length !== newTeams.length && allTeams.length > 0) {
                                currentPage = 0;
                            }
                            allTeams = newTeams;
                            renderRankPage();
                        }
                        // æ›´æ–°è§£é¢˜æµæ°´
                        if (data.solves || data.events) {
                            renderSolvesFeed(data.solves || [], data.events || []);
                        }
                        // ç›´æ¥æ›´æ–°è¶‹åŠ¿å›¾ï¼ˆä¸å†å‘è¯·æ±‚ï¼‰
                        if (data.trend && data.trend.labels && data.trend.labels.length > 0) {
                            trendChart.data.labels = data.trend.labels;
                            trendChart.data.datasets = (data.trend.teams || []).map((team, i) => ({
                                label: team.name,
                                data: team.scores,
                                borderColor: colors[i % colors.length],
                                borderWidth: lineWidths[i] || 1,
                                tension: 0.3,
                                pointRadius: 0
                            }));
                            trendChart.update();
                        }
                    } else if (data.type === 'event') {
                        // å®æ—¶äº‹ä»¶æ¨é€ - åŠ¨æ€æ·»åŠ åˆ°æµæ°´åˆ—è¡¨
                        console.log('[Monitor WS] New event:', data.event);
                        appendEventToFeed(data.event || data.events?.[0]);
                    }
                } catch (e) {
                    console.error('WebSocket message parse error:', e);
                }
            };
            
            ws.onclose = () => {
                console.log('WebSocket disconnected, reconnecting in 5s...');
                document.getElementById('connection-status').innerHTML = '<span class="text-yellow-500">â— Reconnecting</span>';
                wsReconnectTimer = setTimeout(connectWebSocket, 5000);
            };
            
            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
            };
        }

        // === å·¥å…·å‡½æ•° ===
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text || '';
            return div.innerHTML;
        }

        // åŠ¨æ€æ·»åŠ äº‹ä»¶åˆ°æµæ°´åˆ—è¡¨ï¼ˆWebSocket å®æ—¶æ¨é€ï¼‰
        function appendEventToFeed(e) {
            if (!e) return;
            
            const liveFeed = document.getElementById('live-feed');
            let html = '';
            
            // æ ¹æ®äº‹ä»¶ç±»å‹ç”Ÿæˆ HTML
            if (e.type === 'round_start') {
                html = `<tr class="bg-blue-900 bg-opacity-10 animate-pulse">
                    <td class="col-tag"><span class="tag" style="background: #3b82f6; color: white;">ROUND</span></td>
                    <td><span class="text-blue-400 font-bold">ğŸ”” ${escapeHtml(e.teamName)}</span> <span class="text-gray-400">æ”»å‡»å¼€å§‹</span></td>
                    <td class="col-time text-gray-600 text-xs font-mono">${e.time}</td>
                </tr>`;
            } else if (e.type === 'defense_success') {
                html = `<tr class="bg-green-900 bg-opacity-10 animate-pulse">
                    <td class="col-tag"><span class="tag" style="background: #22c55e; color: white;">DEF</span></td>
                    <td><span class="text-green-400 font-bold">ğŸ›¡ï¸ ${escapeHtml(e.teamName)}</span> <span class="text-gray-400">é˜²å®ˆæˆåŠŸ</span> <span class="text-green-500 font-bold">${e.userName || ''}</span> <span class="text-gray-500">${escapeHtml(e.challengeName || '')}</span></td>
                    <td class="col-time text-gray-600 text-xs font-mono">${e.time}</td>
                </tr>`;
            } else if (e.type === 'attack_success') {
                html = `<tr class="bg-orange-900 bg-opacity-10 animate-pulse">
                    <td class="col-tag"><span class="tag" style="background: #f97316; color: white;">ATK</span></td>
                    <td><span class="text-orange-400 font-bold">âš”ï¸ ${escapeHtml(e.teamName)}</span> <span class="text-gray-400">è¢«æ”»ç ´</span> <span class="text-gray-500">${escapeHtml(e.challengeName || '')}</span></td>
                    <td class="col-time text-gray-600 text-xs font-mono">${e.time}</td>
                </tr>`;
            } else if (e.type === 'patch_submit') {
                html = `<tr class="bg-purple-900 bg-opacity-5 animate-pulse">
                    <td class="col-tag"><span class="tag" style="background: #a855f7; color: white;">PATCH</span></td>
                    <td><span class="text-purple-400 font-bold">ğŸ“¦ ${escapeHtml(e.teamName)}</span> <span class="text-gray-400">æäº¤è¡¥ä¸</span> <span class="text-gray-500">${escapeHtml(e.challengeName || '')}</span></td>
                    <td class="col-time text-gray-600 text-xs font-mono">${e.time}</td>
                </tr>`;
            } else if (e.type === 'patch_applied') {
                html = `<tr class="bg-green-900 bg-opacity-5 animate-pulse">
                    <td class="col-tag"><span class="tag" style="background: #16a34a; color: white;">OK</span></td>
                    <td><span class="text-green-400 font-bold">âœ… ${escapeHtml(e.teamName)}</span> <span class="text-gray-400">è¡¥ä¸ç”Ÿæ•ˆ</span> <span class="text-gray-500">${escapeHtml(e.challengeName || '')}</span></td>
                    <td class="col-time text-gray-600 text-xs font-mono">${e.time}</td>
                </tr>`;
            } else if (e.type === 'patch_rejected') {
                html = `<tr class="bg-red-900 bg-opacity-5 animate-pulse">
                    <td class="col-tag"><span class="tag" style="background: #dc2626; color: white;">FAIL</span></td>
                    <td><span class="text-red-400 font-bold">âŒ ${escapeHtml(e.teamName)}</span> <span class="text-gray-400">è¡¥ä¸å¤±è´¥</span> <span class="text-gray-500">${escapeHtml(e.challengeName || '')} ${e.userName ? '(' + escapeHtml(e.userName) + ')' : ''}</span></td>
                    <td class="col-time text-gray-600 text-xs font-mono">${e.time}</td>
                </tr>`;
            } else if (e.type === 'container_reset') {
                html = `<tr class="bg-yellow-900 bg-opacity-5 animate-pulse">
                    <td class="col-tag"><span class="tag" style="background: #eab308; color: black;">RESET</span></td>
                    <td><span class="text-yellow-400 font-bold">ğŸ”„ ${escapeHtml(e.teamName)}</span> <span class="text-gray-400">é‡ç½®å®¹å™¨</span> <span class="text-gray-500">${escapeHtml(e.challengeName || '')}</span></td>
                    <td class="col-time text-gray-600 text-xs font-mono">${e.time}</td>
                </tr>`;
            } else {
                // å…¶ä»–ç±»å‹äº‹ä»¶
                html = `<tr class="animate-pulse">
                    <td class="col-tag"><span class="tag tag-try">${e.type?.toUpperCase() || 'EVENT'}</span></td>
                    <td><span class="text-gray-400">${escapeHtml(e.teamName)}</span> ${escapeHtml(e.challengeName || '')}</td>
                    <td class="col-time text-gray-600 text-xs font-mono">${e.time}</td>
                </tr>`;
            }
            
            if (html) {
                // å¦‚æœæµæ°´åˆ—è¡¨æ˜¯ç©ºçš„æˆ–æ˜¾ç¤º"æš‚æ— è®°å½•"ï¼Œå…ˆæ¸…ç©º
                if (liveFeed.querySelector('.text-center')) {
                    liveFeed.innerHTML = '<table class="feed-table"><tbody></tbody></table>';
                }
                
                // ç¡®ä¿æœ‰ table ç»“æ„
                let table = liveFeed.querySelector('table');
                if (!table) {
                    liveFeed.innerHTML = '<table class="feed-table"><tbody></tbody></table>';
                    table = liveFeed.querySelector('table');
                }
                
                // æ’å…¥åˆ°æœ€å‰é¢
                const tbody = table.querySelector('tbody') || table;
                tbody.insertAdjacentHTML('afterbegin', html);
                
                // é™åˆ¶æœ€å¤šæ˜¾ç¤º 50 æ¡
                const rows = tbody.querySelectorAll('tr');
                if (rows.length > 50) {
                    rows[rows.length - 1].remove();
                }
                
                // 1ç§’åç§»é™¤é«˜äº®åŠ¨ç”»
                setTimeout(() => {
                    const firstRow = tbody.querySelector('tr');
                    if (firstRow) {
                        firstRow.classList.remove('animate-pulse');
                    }
                }, 1000);
            }
        }

        // è‡ªåŠ¨è°ƒæ•´æ ‡é¢˜å­—å· - åªæœ‰è¶…å‡ºå®¹å™¨æ—¶æ‰ç¼©å°
        function fitTitle() {
            const titleEl = document.getElementById('contest-name');
            
            // å…ˆé‡ç½®ä¸ºæœ€å¤§å­—å·
            titleEl.style.fontSize = '2.5rem';
            
            // ç­‰DOMæ›´æ–°åæ£€æµ‹
            setTimeout(() => {
                const container = titleEl.parentElement;
                let fontSize = 40;
                
                // åªæœ‰å½“å†…å®¹å®½åº¦è¶…å‡ºå®¹å™¨æ—¶æ‰ç¼©å°
                while (titleEl.scrollWidth > container.clientWidth && fontSize > 18) {
                    fontSize -= 2;
                    titleEl.style.fontSize = fontSize + 'px';
                }
            }, 0);
        }

        // === åˆå§‹åŒ– ===
        let pageInterval = null;
        let isPaused = false;

        function togglePause() {
            const btn = document.getElementById('pause-btn');
            const progressBar = document.getElementById('page-progress');
            
            if (isPaused) {
                // æ¢å¤è‡ªåŠ¨ç¿»é¡µ
                isPaused = false;
                btn.textContent = 'â–¶ AUTO';
                btn.classList.remove('text-[#ff6b00]', 'border-[#ff6b00]');
                btn.classList.add('text-gray-400', 'border-[#444]');
                pageInterval = setInterval(renderRankPage, 10000);
                // é‡æ–°å¯åŠ¨è¿›åº¦æ¡
                progressBar.style.transition = 'none';
                progressBar.style.width = '0%';
                setTimeout(() => {
                    progressBar.style.transition = 'width 10s linear';
                    progressBar.style.width = '100%';
                }, 50);
            } else {
                // æš‚åœè‡ªåŠ¨ç¿»é¡µ
                isPaused = true;
                btn.textContent = 'â–  PAUSE';
                btn.classList.remove('text-gray-400', 'border-[#444]');
                btn.classList.add('text-[#ff6b00]', 'border-[#ff6b00]');
                clearInterval(pageInterval);
                pageInterval = null;
                // æš‚åœè¿›åº¦æ¡
                const currentWidth = progressBar.offsetWidth / progressBar.parentElement.offsetWidth * 100;
                progressBar.style.transition = 'none';
                progressBar.style.width = currentWidth + '%';
            }
        }
        
        async function init() {
            initTrendChart();
            
            // å…ˆåŠ è½½æ•°æ®
            await loadMonitorData();
            
            // æ•°æ®åŠ è½½åç«‹å³æ¸²æŸ“ï¼ˆæ— è®ºæœ‰æ— æ•°æ®éƒ½è¦æ¸²æŸ“ï¼‰
            renderRankPage();
            
            // å¯åŠ¨è‡ªåŠ¨ç¿»é¡µ
            if (!pageInterval) {
                pageInterval = setInterval(renderRankPage, 10000);
            }
            
            await loadTrendData();
            
            // è¿æ¥WebSocketå®æ—¶æ›´æ–°
            connectWebSocket();
            
            // å¤‡ç”¨è½®è¯¢ï¼ˆWebSocketæ–­å¼€æ—¶ä¿è¯æ•°æ®æ›´æ–°ï¼‰
            setInterval(loadMonitorData, 60000);
            setInterval(loadTrendData, 60000);
        }

        if (contestId) {
            init();
        }
    </script>

</body>
</html>
