<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="author" content="tan91">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/fonts.css">
    <style>
        :root { --bg-dark: #121212; --bg-panel: #1e1e1e; --border-color: #333; --accent: #ff6b00; --danger: #ef4444; --success: #22c55e; --info: #3b82f6; --text-main: #e0e0e0; --text-dim: #737373; }
        body { background-color: var(--bg-dark); color: var(--text-main); font-family: 'Noto Sans SC', sans-serif; }
        .font-eng { font-family: 'Chakra Petch', sans-serif; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        .sidebar-item { border-left: 2px solid transparent; transition: all 0.2s; }
        .sidebar-item:hover, .sidebar-item.active { background: rgba(255, 107, 0, 0.05); border-left-color: var(--accent); color: white; }
        .sidebar-item.active .icon { color: var(--accent); }
        .admin-card { background: var(--bg-panel); border: 1px solid var(--border-color); position: relative; }
        .progress-bar { transition: width 0.5s ease-in-out; }
        .btn-icon { width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; border: 1px solid var(--border-color); color: var(--text-dim); border-radius: 2px; transition: 0.2s; cursor: pointer; }
        .btn-icon:hover { border-color: white; color: white; background: rgba(255,255,255,0.1); }
        .btn-danger-ghost { color: #888; border: 1px solid transparent; padding: 0.25rem 0.5rem; font-size: 0.75rem; transition: 0.2s; cursor: pointer; background: transparent; }
        .btn-danger-ghost:hover { color: var(--danger); border-color: var(--danger); background: rgba(239,68,68,0.1); }
        .container-id { background: #000; color: var(--info); padding: 2px 6px; border-radius: 2px; font-family: 'JetBrains Mono', monospace; font-size: 0.7rem; }
        .view-btn.active { background: #ff6b00; color: black; font-weight: bold; border-color: #ff6b00; }
        .tactical-table thead th { background: #151515; color: #666; font-family: 'JetBrains Mono', monospace; font-weight: normal; text-transform: uppercase; letter-spacing: 0.05em; padding: 1rem; border-bottom: 1px solid #333; text-align: left; font-size: 0.75rem; }
        .tactical-table tbody tr { border-bottom: 1px solid #252525; transition: background 0.2s; }
        .tactical-table tbody tr:hover { background: rgba(255,255,255,0.02); }
        .tactical-table td { padding: 1rem; vertical-align: middle; }
        .status-badge { display: inline-flex; align-items: center; font-size: 0.7rem; padding: 2px 8px; border-radius: 99px; border: 1px solid transparent; }
        .status-running { border-color: var(--success); color: var(--success); background: rgba(34, 197, 94, 0.1); }
        .status-expired { border-color: var(--danger); color: var(--danger); background: rgba(239, 68, 68, 0.1); }
        .grid-container-card { background: #1a1a1a; border: 1px solid #333; padding: 1rem; position: relative; transition: all 0.2s; }
        .grid-container-card:hover { border-color: var(--accent); transform: translateY(-2px); box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
        .grid-status-bar { height: 3px; width: 100%; position: absolute; top: 0; left: 0; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #111; }
        ::-webkit-scrollbar-thumb { background: #333; }
        .hidden { display: none !important; }
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 100; display: flex; align-items: center; justify-content: center; }
        .modal-content { background: #1e1e1e; border: 1px solid #333; padding: 1.5rem; max-width: 600px; width: 90%; max-height: 80vh; overflow: auto; }
        .log-viewer { background: #0a0a0a; border: 1px solid #333; padding: 1rem; font-family: 'JetBrains Mono', monospace; font-size: 0.75rem; white-space: pre-wrap; max-height: 400px; overflow: auto; color: #aaa; }
    </style>
</head>
<body class="flex h-screen overflow-hidden selection:bg-[#ff6b00] selection:text-black">

    <aside class="w-48 bg-[#161616] border-r border-[#333] flex flex-col z-20 shadow-xl">
        <div class="h-16 flex items-center px-6 border-b border-[#333]">
            <div class="bg-[#ff6b00] text-black font-black text-xl px-2 py-0.5 font-eng tracking-tighter mr-3">TG</div>
            <span class="font-bold text-gray-300 tracking-wider text-sm">ç®¡ç†ä¸­æ¢</span>
        </div>
        <nav class="flex-1 py-6 space-y-1 font-mono text-xs overflow-y-auto">
            <a href="/admin/admin.html" class="sidebar-item flex items-center px-6 py-3 text-gray-400"><span class="icon mr-3">âŒ‚</span> æ¦‚è§ˆ</a>
            <p class="px-6 text-[#555] mb-2 font-bold mt-4">èµ›äº‹æ ¸å¿ƒ</p>
            <a href="/admin/admin-contests.html" class="sidebar-item flex items-center px-6 py-3 text-gray-400"><span class="icon mr-3">âš‘</span> æ¯”èµ›ç®¡ç†</a>
            <a href="/admin/admin-question-bank.html" class="sidebar-item flex items-center px-6 py-3 text-gray-400"><span class="icon mr-3">â˜·</span> é¢˜åº“</a>
            <a href="/admin/admin-users.html" class="sidebar-item flex items-center px-6 py-3 text-gray-400"><span class="icon mr-3">ì›ƒ</span> ç”¨æˆ·ç®¡ç†</a>
            <a href="/admin/admin-teams.html" class="sidebar-item flex items-center px-6 py-3 text-gray-400"><span class="icon mr-3">â—ˆ</span> é˜Ÿä¼ç®¡ç†</a>
            <a href="/admin/admin-organizations.html" class="sidebar-item flex items-center px-6 py-3 text-gray-400"><span class="icon mr-3">ğŸ¢</span> ç»„ç»‡ç®¡ç†</a>
            <a href="/admin/admin-data-import.html" class="sidebar-item flex items-center px-6 py-3 text-gray-400"><span class="icon mr-3">ğŸ“¥</span> æ•°æ®å¯¼å…¥</a>
            <p class="px-6 text-[#555] mb-2 font-bold mt-6">è¿ç»´ç›‘æ§</p>
            <a href="/admin/admin-docker.html" class="sidebar-item active flex items-center px-6 py-3 text-gray-400"><span class="icon mr-3">ğŸ³</span> dockerå®ä¾‹ç®¡ç†</a>
            <a href="/admin/admin-anti-cheat.html" class="sidebar-item flex items-center px-6 py-3 text-gray-400"><span class="icon mr-3">ğŸ›¡ï¸</span> é˜²ä½œå¼Šç³»ç»Ÿ</a>
            <a href="/admin/admin-logs.html" class="sidebar-item flex items-center px-6 py-3 text-gray-400"><span class="icon mr-3">âš </span> ç³»ç»Ÿæ—¥å¿—</a>
            <a href="/admin/admin-settings.html" class="sidebar-item flex items-center px-6 py-3 text-gray-400"><span class="icon mr-3">âš™</span> ç³»ç»Ÿè®¾ç½®</a>
        </nav>
        <div class="p-4 border-t border-[#333]">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 bg-[#333] rounded-full flex items-center justify-center text-[#ff6b00] font-bold">A</div>
                <div><p class="text-xs text-white font-bold">è¶…çº§ç®¡ç†å‘˜</p><p class="text-[10px] text-green-500">â— è¿æ¥ç¨³å®š</p></div>
            </div>
        </div>
    </aside>

    <div class="flex-1 flex flex-col min-w-0 bg-[#121212]">
        <header class="h-16 bg-[#161616] border-b border-[#333] flex items-center justify-between px-8 z-10">
            <div class="flex items-center gap-4 text-xs font-mono">
                <span class="text-gray-500">ä½ç½®:</span><span class="text-[#ff6b00]">è¿ç»´ç›‘æ§</span><span class="text-gray-600">/</span><span class="text-white">Docker å®ä¾‹</span>
            </div>
            <div class="flex items-center gap-3">
                <a href="/home.html" class="font-mono text-xs font-bold border border-gray-500 text-gray-400 px-4 py-2 hover:border-white hover:text-white transition-all uppercase tracking-wider">â† è¿”å›å‰å°</a>
                <button id="logout-btn" class="font-mono text-xs font-bold border border-[#ff6b00] text-[#ff6b00] px-4 py-2 hover:bg-[#ff6b00] hover:text-black transition-all uppercase tracking-wider">Logout_ç¦»çº¿</button>
            </div>
        </header>

        <main class="flex-1 flex flex-col pt-8 px-8 relative overflow-hidden">
            <!-- ç»Ÿè®¡å¡ç‰‡ -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <div class="admin-card p-5">
                    <div class="flex justify-between items-end mb-2">
                        <span class="text-xs text-gray-500 font-mono uppercase">è¿è¡Œä¸­å®¹å™¨</span>
                        <span id="stat-running" class="text-xl font-eng font-bold text-green-500">-</span>
                    </div>
                    <div class="w-full bg-[#333] h-1.5 rounded-full overflow-hidden">
                        <div id="progress-running" class="bg-green-500 h-full progress-bar" style="width: 0%"></div>
                    </div>
                    <div id="stat-docker" class="mt-2 text-[10px] text-gray-600 font-mono">Docker å®é™…: -</div>
                </div>
                <div class="admin-card p-5">
                    <div class="flex justify-between items-end mb-2">
                        <span class="text-xs text-gray-500 font-mono uppercase">è¿‡æœŸå¾…æ¸…ç†</span>
                        <span id="stat-expired" class="text-xl font-eng font-bold text-red-400">-</span>
                    </div>
                    <div class="w-full bg-[#333] h-1.5 rounded-full overflow-hidden">
                        <div id="progress-expired" class="bg-red-500 h-full progress-bar" style="width: 0%"></div>
                    </div>
                    <div class="mt-2 text-[10px] text-gray-600 font-mono">å·²è¶…è¿‡æœ‰æ•ˆæœŸ</div>
                </div>
                <div class="admin-card p-5">
                    <div class="flex justify-between items-end mb-2">
                        <span class="text-xs text-gray-500 font-mono uppercase">ä»Šæ—¥åˆ›å»º</span>
                        <span id="stat-today-created" class="text-xl font-eng font-bold text-blue-400">-</span>
                    </div>
                    <div class="w-full bg-[#333] h-1.5 rounded-full overflow-hidden">
                        <div class="bg-blue-500 h-full progress-bar" style="width: 50%"></div>
                    </div>
                    <div class="mt-2 text-[10px] text-gray-600 font-mono">ä»Šæ—¥æ–°å»ºå®¹å™¨å®ä¾‹</div>
                </div>
                <div class="admin-card p-5">
                    <div class="flex justify-between items-end mb-2">
                        <span class="text-xs text-gray-500 font-mono uppercase">ä»Šæ—¥é”€æ¯</span>
                        <span id="stat-today-destroyed" class="text-xl font-eng font-bold text-gray-400">-</span>
                    </div>
                    <div class="w-full bg-[#333] h-1.5 rounded-full overflow-hidden">
                        <div class="bg-gray-500 h-full progress-bar" style="width: 30%"></div>
                    </div>
                    <div class="mt-2 text-[10px] text-gray-600 font-mono">ä»Šæ—¥é”€æ¯å®¹å™¨å®ä¾‹</div>
                </div>
            </div>

            <!-- å·¥å…·æ  -->
            <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4 bg-[#1a1a1a] p-4 border border-[#333]">
                <div class="flex items-center gap-4 w-full md:w-auto">
                    <h2 class="text-lg font-bold text-white font-eng tracking-wide">CONTAINER_POOL</h2>
                    <div class="h-6 w-px bg-[#333]"></div>
                    <div class="relative">
                        <input id="search-input" type="text" placeholder="æœç´¢å®¹å™¨ID / é˜Ÿä¼ / ç”¨æˆ·..." class="bg-[#111] border border-[#333] text-xs text-white px-4 py-2 w-72 focus:border-[#ff6b00] outline-none font-mono placeholder-gray-600">
                        <button onclick="loadInstances()" class="absolute right-2 top-1.5 text-gray-500 hover:text-white">ğŸ”</button>
                    </div>
                </div>
                <div class="flex gap-3">
                    <select id="contest-filter" onchange="loadInstances()" class="bg-[#111] border border-[#333] text-xs text-gray-400 px-3 py-2 outline-none hover:border-[#555] cursor-pointer">
                        <option value="">æ‰€æœ‰æ¯”èµ›</option>
                    </select>
                    <button onclick="batchDestroy()" class="btn-danger-ghost border-yellow-900 text-yellow-500">æ‰¹é‡é”€æ¯é€‰ä¸­</button>
                    <button onclick="cleanExpired()" class="btn-danger-ghost border-red-900 text-red-500 bg-red-900 bg-opacity-10">æ¸…ç†è¿‡æœŸå®ä¾‹</button>
                    <button onclick="loadInstances()" class="btn-danger-ghost border-blue-900 text-blue-400">åˆ·æ–°</button>
                </div>
            </div>

            <!-- å®ä¾‹åˆ—è¡¨ -->
            <div id="list-view" class="admin-card overflow-hidden flex-1">
                <div style="max-height: 550px; overflow-y: auto;">
                <table class="w-full tactical-table">
                    <thead>
                        <tr>
                            <th class="w-12 text-center"><input type="checkbox" id="select-all" class="accent-[#ff6b00]" onchange="toggleSelectAll()"></th>
                            <th>å®¹å™¨ ID</th>
                            <th>é˜Ÿä¼ / ç”¨æˆ·</th>
                            <th>æ¯”èµ›</th>
                            <th>é¢˜ç›®</th>
                            <th>ç«¯å£æ˜ å°„</th>
                            <th>åˆ›å»ºæ—¶é—´</th>
                            <th>è¿‡æœŸæ—¶é—´</th>
                            <th>çŠ¶æ€</th>
                            <th class="text-right pr-6">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="instances-tbody">
                        <tr><td colspan="10" class="text-center text-gray-500 py-8">åŠ è½½ä¸­...</td></tr>
                    </tbody>
                </table>
                </div>
            </div>

            <footer class="py-1 border-t border-[#333] flex items-center justify-center flex-shrink-0 mt-auto">
                <div class="flex items-center justify-center gap-4 text-xs flex-wrap">
                    <div class="flex items-center gap-1">
                        <div class="bg-[#ff6b00] text-black font-black px-1.5 py-0.5 font-eng tracking-tighter">TG</div>
                        <span class="text-gray-500">å¤©æ ¼åå°ç®¡ç†ç³»ç»Ÿ</span>
                    </div>
                    <span class="text-white font-mono">Copyright Â© 2021-present tan91. All Rights Reserved.</span>
                    <a href="https://github.com/NUDTTAN91" target="_blank" class="text-[#ff6b00] hover:text-white transition-colors"><svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor"><path d="M12 0C5.37 0 0 5.37 0 12c0 5.31 3.435 9.795 8.205 11.385.6.105.825-.255.825-.57 0-.285-.015-1.23-.015-2.235-3.015.555-3.795-.735-4.035-1.41-.135-.345-.72-1.41-1.23-1.695-.42-.225-1.02-.78-.015-.795.945-.015 1.62.87 1.845 1.23 1.08 1.815 2.805 1.305 3.495.99.105-.78.42-1.305.765-1.605-2.67-.3-5.46-1.335-5.46-5.925 0-1.305.465-2.385 1.23-3.225-.12-.3-.54-1.53.12-3.18 0 0 1.005-.315 3.3 1.23.96-.27 1.98-.405 3-.405s2.04.135 3 .405c2.295-1.56 3.3-1.23 3.3-1.23.66 1.65.24 2.88.12 3.18.765.84 1.23 1.905 1.23 3.225 0 4.605-2.805 5.625-5.475 5.925.435.375.81 1.095.81 2.22 0 1.605-.015 2.895-.015 3.3 0 .315.225.69.825.57A12.02 12.02 0 0024 12c0-6.63-5.37-12-12-12z"/></svg></a>
                    <a href="https://blog.csdn.net/ZXW_NUDT" target="_blank" class="text-[#ff6b00] hover:text-white transition-colors"><svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg></a>
                </div>
            </footer>
        </main>
    </div>

    <!-- æ—¥å¿—å¼¹çª— -->
    <div id="log-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-white font-bold">å®¹å™¨æ—¥å¿—</h3>
                <button onclick="closeLogModal()" class="text-gray-400 hover:text-white text-xl">&times;</button>
            </div>
            <div id="log-container-id" class="text-xs text-blue-400 font-mono mb-2">Container: -</div>
            <div id="log-content" class="log-viewer">åŠ è½½ä¸­...</div>
        </div>
    </div>

    <!-- ç¡®è®¤å¼¹çª— -->
    <div id="confirm-modal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width: 400px;">
            <h3 id="confirm-title" class="text-white font-bold mb-4">ç¡®è®¤æ“ä½œ</h3>
            <p id="confirm-message" class="text-gray-400 text-sm mb-6"></p>
            <div class="flex justify-end gap-3">
                <button onclick="closeConfirmModal()" class="px-4 py-2 text-sm text-gray-400 hover:text-white border border-gray-600 hover:border-white">å–æ¶ˆ</button>
                <button id="confirm-btn" class="px-4 py-2 text-sm bg-red-600 text-white hover:bg-red-700">ç¡®è®¤</button>
            </div>
        </div>
    </div>

    <script>
        function parseJwt(token) { try { const base64Url = token.split('.')[1]; const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/'); const jsonPayload = decodeURIComponent(atob(base64).split('').map(c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join('')); return JSON.parse(jsonPayload); } catch (e) { return null; } }
        const token = localStorage.getItem('tg_token');
        if (!token) { window.location.href = '/login.html'; } else { const payload = parseJwt(token); if (!payload || payload.role !== 'super') { showTip('æƒé™ä¸è¶³ï¼šä»…è¶…çº§ç®¡ç†å‘˜å¯è®¿é—®æ­¤é¡µé¢', 'error'); setTimeout(() => window.location.href = '/home.html', 1500); } }
        document.getElementById('logout-btn').addEventListener('click', () => { localStorage.removeItem('tg_token'); window.location.href = '/login.html'; });

        let selectedIds = new Set();

        function showTip(msg, type = 'info') {
            const colors = { success: '#22c55e', error: '#ef4444', warning: '#f59e0b', info: '#3b82f6' };
            const tip = document.createElement('div');
            tip.textContent = msg;
            tip.style.cssText = `position:fixed;top:20px;left:50%;transform:translateX(-50%);background:${colors[type]||colors.info};color:#fff;padding:12px 20px;border-radius:4px;z-index:9999;font-size:14px;`;
            document.body.appendChild(tip);
            setTimeout(() => tip.remove(), 3000);
        }

        async function loadStats() {
            try {
                const res = await fetch('/api/admin/docker/instances/stats', { headers: { Authorization: 'Bearer ' + token } });
                const data = await res.json();
                document.getElementById('stat-running').textContent = data.runningCount || 0;
                document.getElementById('stat-expired').textContent = data.expiredCount || 0;
                document.getElementById('stat-today-created').textContent = data.todayCreated || 0;
                document.getElementById('stat-today-destroyed').textContent = data.todayDestroyed || 0;
                document.getElementById('stat-docker').textContent = `Docker å®é™…: ${data.dockerCount || 0}`;
                const runningPct = Math.min((data.runningCount || 0) / 100 * 100, 100);
                document.getElementById('progress-running').style.width = runningPct + '%';
                const expiredPct = data.runningCount > 0 ? (data.expiredCount || 0) / data.runningCount * 100 : 0;
                document.getElementById('progress-expired').style.width = expiredPct + '%';
            } catch (e) { console.error('åŠ è½½ç»Ÿè®¡å¤±è´¥', e); }
        }

        async function loadContests() {
            try {
                const res = await fetch('/api/admin/docker/instances/contests', { headers: { Authorization: 'Bearer ' + token } });
                const data = await res.json();
                const select = document.getElementById('contest-filter');
                select.innerHTML = '<option value="">æ‰€æœ‰æ¯”èµ›</option>';
                (data.contests || []).forEach(c => {
                    select.innerHTML += `<option value="${c.id}">${c.title} (${c.instanceCount})</option>`;
                });
            } catch (e) { console.error('åŠ è½½æ¯”èµ›åˆ—è¡¨å¤±è´¥', e); }
        }

        async function loadInstances(keepSelection = false) {
            const tbody = document.getElementById('instances-tbody');
            tbody.innerHTML = '<tr><td colspan="10" class="text-center text-gray-500 py-8">åŠ è½½ä¸­...</td></tr>';
            if (!keepSelection) {
                selectedIds.clear();
                document.getElementById('select-all').checked = false;
            }

            const search = document.getElementById('search-input').value;
            const contestId = document.getElementById('contest-filter').value;
            const params = new URLSearchParams();
            if (search) params.append('search', search);
            if (contestId) params.append('contestId', contestId);

            try {
                const res = await fetch('/api/admin/docker/instances?' + params.toString(), { headers: { Authorization: 'Bearer ' + token } });
                const data = await res.json();
                const instances = data.instances || [];
                if (instances.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="10" class="text-center text-gray-500 py-8">æš‚æ— è¿è¡Œä¸­çš„å®¹å™¨å®ä¾‹</td></tr>';
                    return;
                }
                tbody.innerHTML = instances.map(inst => {
                    const ports = Object.entries(inst.ports || {}).map(([k, v]) => `${v}:${k}`).join(', ') || '-';
                    const statusClass = inst.isExpired ? 'status-expired' : 'status-running';
                    const statusText = inst.isExpired ? 'âš  å·²è¿‡æœŸ' : 'â— è¿è¡Œä¸­';
                    const isChecked = selectedIds.has(inst.id) ? 'checked' : '';
                    return `<tr class="${inst.isExpired ? 'bg-red-900 bg-opacity-5' : ''}">
                        <td class="text-center"><input type="checkbox" class="accent-[#ff6b00] row-checkbox" data-id="${inst.id}" ${isChecked} onchange="toggleSelect(${inst.id})"></td>
                        <td><div class="flex flex-col"><span class="container-id w-fit ${inst.isExpired ? 'bg-red-900 text-red-300' : ''}">${inst.containerId}</span><span class="text-[10px] text-gray-500 mt-1">${inst.containerName || '-'}</span></div></td>
                        <td><div class="text-sm font-bold text-white">${inst.teamName}</div><div class="text-[10px] text-gray-500 font-mono">${inst.userName}</div></td>
                        <td class="text-xs text-gray-400">${inst.contestName}</td>
                        <td class="text-xs text-gray-300">${inst.challengeName}</td>
                        <td class="text-xs text-blue-400 font-mono">${ports}</td>
                        <td class="text-xs text-gray-500 font-mono">${inst.createdAt}</td>
                        <td class="text-xs text-gray-500 font-mono">${inst.expiresAt}</td>
                        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                        <td class="text-right pr-4">
                            <div class="flex justify-end gap-2">
                                <div title="æŸ¥çœ‹æ—¥å¿—" class="btn-icon" onclick="viewLogs(${inst.id})">ğŸ“„</div>
                                <div title="å¼ºåˆ¶é”€æ¯" class="btn-icon text-red-500 hover:bg-red-900 border-red-900 hover:border-red-500" onclick="destroyInstance(${inst.id}, '${inst.containerName}')">âœ•</div>
                            </div>
                        </td>
                    </tr>`;
                }).join('');
            } catch (e) {
                console.error('åŠ è½½å®ä¾‹å¤±è´¥', e);
                tbody.innerHTML = '<tr><td colspan="10" class="text-center text-red-500 py-8">åŠ è½½å¤±è´¥</td></tr>';
            }
        }

        function toggleSelect(id) {
            if (selectedIds.has(id)) selectedIds.delete(id);
            else selectedIds.add(id);
        }

        function toggleSelectAll() {
            const checked = document.getElementById('select-all').checked;
            document.querySelectorAll('.row-checkbox').forEach(cb => {
                cb.checked = checked;
                const id = parseInt(cb.dataset.id);
                if (checked) selectedIds.add(id);
                else selectedIds.delete(id);
            });
        }

        let confirmCallback = null;
        function showConfirm(title, message, callback) {
            document.getElementById('confirm-title').textContent = title;
            document.getElementById('confirm-message').textContent = message;
            document.getElementById('confirm-modal').classList.remove('hidden');
            confirmCallback = callback;
        }
        function closeConfirmModal() { document.getElementById('confirm-modal').classList.add('hidden'); confirmCallback = null; }
        document.getElementById('confirm-btn').onclick = () => { if (confirmCallback) confirmCallback(); closeConfirmModal(); };

        async function destroyInstance(id, name) {
            showConfirm('ç¡®è®¤é”€æ¯', `ç¡®å®šè¦é”€æ¯å®¹å™¨ "${name}" å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚`, async () => {
                try {
                    const res = await fetch(`/api/admin/docker/instances/${id}`, { method: 'DELETE', headers: { Authorization: 'Bearer ' + token } });
                    const data = await res.json();
                    if (res.ok) { showTip(data.message || 'é”€æ¯æˆåŠŸ', 'success'); loadInstances(); loadStats(); }
                    else showTip(data.error || 'é”€æ¯å¤±è´¥', 'error');
                } catch (e) { showTip('é”€æ¯å¤±è´¥', 'error'); }
            });
        }

        async function batchDestroy() {
            if (selectedIds.size === 0) { showTip('è¯·å…ˆé€‰æ‹©è¦é”€æ¯çš„å®ä¾‹', 'warning'); return; }
            showConfirm('æ‰¹é‡é”€æ¯', `ç¡®å®šè¦é”€æ¯é€‰ä¸­çš„ ${selectedIds.size} ä¸ªå®¹å™¨å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚`, async () => {
                try {
                    const res = await fetch('/api/admin/docker/instances/batch-destroy', {
                        method: 'POST',
                        headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' },
                        body: JSON.stringify({ ids: Array.from(selectedIds) })
                    });
                    const data = await res.json();
                    showTip(data.message || 'æ‰¹é‡é”€æ¯å®Œæˆ', res.ok ? 'success' : 'warning');
                    loadInstances(); loadStats();
                } catch (e) { showTip('æ‰¹é‡é”€æ¯å¤±è´¥', 'error'); }
            });
        }

        async function cleanExpired() {
            showConfirm('æ¸…ç†è¿‡æœŸå®ä¾‹', 'ç¡®å®šè¦æ¸…ç†æ‰€æœ‰å·²è¿‡æœŸçš„å®¹å™¨å®ä¾‹å—ï¼Ÿ', async () => {
                try {
                    const res = await fetch('/api/admin/docker/instances/clean', { method: 'POST', headers: { Authorization: 'Bearer ' + token } });
                    const data = await res.json();
                    showTip(data.message || 'æ¸…ç†å®Œæˆ', res.ok ? 'success' : 'warning');
                    loadInstances(); loadStats();
                } catch (e) { showTip('æ¸…ç†å¤±è´¥', 'error'); }
            });
        }

        async function viewLogs(id) {
            document.getElementById('log-modal').classList.remove('hidden');
            document.getElementById('log-content').textContent = 'åŠ è½½ä¸­...';
            document.getElementById('log-container-id').textContent = 'Container: -';
            try {
                const res = await fetch(`/api/admin/docker/instances/${id}/logs?lines=200`, { headers: { Authorization: 'Bearer ' + token } });
                const data = await res.json();
                document.getElementById('log-container-id').textContent = 'Container: ' + (data.containerId || '-');
                document.getElementById('log-content').textContent = data.logs || 'æ— æ—¥å¿—';
            } catch (e) {
                document.getElementById('log-content').textContent = 'åŠ è½½æ—¥å¿—å¤±è´¥';
            }
        }
        function closeLogModal() { document.getElementById('log-modal').classList.add('hidden'); }

        // æœç´¢å›è½¦è§¦å‘
        document.getElementById('search-input').addEventListener('keyup', e => { if (e.key === 'Enter') loadInstances(); });

        // åˆå§‹åŒ–
        loadStats();
        loadContests();
        loadInstances();

        // è‡ªåŠ¨åˆ·æ–°ï¼ˆ30ç§’ï¼‰- ä¿æŒé€‰ä¸­çŠ¶æ€
        setInterval(() => { loadStats(); loadInstances(true); }, 30000);
    </script>
</body>
</html>
