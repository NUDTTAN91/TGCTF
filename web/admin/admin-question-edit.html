<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="author" content="tan91">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/fonts.css">
    <style>
        :root {
            --bg-dark: #121212;
            --bg-panel: #1e1e1e;
            --border-color: #333;
            --accent: #ff6b00;
            --danger: #ef4444;
            --success: #22c55e;
            --info: #3b82f6;
            --text-main: #e0e0e0;
            --text-dim: #737373;
        }
        body { background-color: var(--bg-dark); color: var(--text-main); font-family: 'Noto Sans SC', sans-serif; }
        .font-eng { font-family: 'Chakra Petch', sans-serif; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        .sidebar-item { border-left: 2px solid transparent; transition: all 0.2s; }
        .sidebar-item:hover, .sidebar-item.active { background: rgba(255, 107, 0, 0.05); border-left-color: var(--accent); color: white; }
        .sidebar-item.active .icon { color: var(--accent); }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #111; }
        ::-webkit-scrollbar-thumb { background: #333; }

        .form-section { background: #1a1a1a; border: 1px solid #333; padding: 16px; margin-bottom: 12px; }
        .form-section-title { font-size: 12px; font-weight: bold; color: white; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
        .form-section-title::before { content: ''; width: 3px; height: 14px; background: var(--accent); }

        .form-input { background: #111; border: 1px solid #333; color: white; padding: 8px 12px; width: 100%; outline: none; font-family: 'JetBrains Mono', monospace; transition: 0.2s; font-size: 12px; }
        .form-input:focus { border-color: var(--accent); }
        .form-input:disabled { opacity: 0.5; cursor: not-allowed; }
        .form-label { display: block; font-size: 12px; font-weight: bold; color: #888; margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.05em; }
        .form-hint { font-size: 10px; color: #555; margin-top: 4px; }
        .form-required { color: var(--danger); }

        .form-select { background: #111 url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23666' d='M6 8L1 3h10z'/%3E%3C/svg%3E") no-repeat right 12px center; appearance: none; }

        .type-card { background: #111; border: 2px solid #333; padding: 8px 12px; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 8px; }
        .type-card:hover { border-color: #666; }
        .type-card.selected { border-color: var(--accent); background: rgba(255, 107, 0, 0.05); }
        .type-card-icon { font-size: 18px; }
        .type-card-title { font-size: 11px; font-weight: bold; color: white; }
        .type-card-desc { font-size: 9px; color: #666; }

        .star-rating { display: flex; gap: 2px; }
        .star-rating .star { cursor: pointer; font-size: 16px; color: #333; transition: color 0.15s; }
        .star-rating .star:hover, .star-rating .star.active { color: var(--accent); }
        .star-rating .star.hover-preview { color: #666; }

        .toggle-switch { position: relative; display: inline-block; width: 44px; height: 24px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .toggle-slider { position: absolute; cursor: pointer; inset: 0; background: #333; transition: 0.3s; border-radius: 24px; }
        .toggle-slider:before { content: ''; position: absolute; height: 18px; width: 18px; left: 3px; bottom: 3px; background: #888; transition: 0.3s; border-radius: 50%; }
        input:checked + .toggle-slider { background: rgba(255, 107, 0, 0.3); }
        input:checked + .toggle-slider:before { transform: translateX(20px); background: var(--accent); }

        .port-item { display: flex; gap: 8px; margin-bottom: 8px; }
        .port-item .form-input { flex: 1; }
        .btn-remove-port { background: none; border: 1px solid #555; color: #888; padding: 8px 12px; cursor: pointer; }
        .btn-remove-port:hover { border-color: var(--danger); color: var(--danger); }

        .test-section { background: rgba(59, 130, 246, 0.05); border: 1px dashed rgba(59, 130, 246, 0.3); padding: 12px; margin-top: 12px; }
        .test-btn { padding: 6px 14px; font-size: 11px; font-family: 'JetBrains Mono', monospace; border: 1px solid; cursor: pointer; transition: all 0.2s; }
        .test-btn-check { border-color: var(--info); color: var(--info); }
        .test-btn-check:hover { background: var(--info); color: white; }
        .test-btn-create { border-color: var(--success); color: var(--success); }
        .test-btn-create:hover { background: var(--success); color: white; }
        .test-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .test-result { margin-top: 8px; padding: 8px; font-size: 11px; font-family: 'JetBrains Mono', monospace; }
        .test-result.success { background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.3); color: var(--success); }
        .test-result.error { background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); color: var(--danger); }

        .hidden { display: none !important; }
    </style>
</head>
<body class="flex h-screen overflow-hidden selection:bg-[#ff6b00] selection:text-black">

    <!-- å·¦ä¾§ä¾§è¾¹æ  -->
    <aside class="w-48 bg-[#161616] border-r border-[#333] flex flex-col z-20 shadow-xl">
        <div class="h-16 flex items-center px-6 border-b border-[#333]">
            <div class="bg-[#ff6b00] text-black font-black text-xl px-2 py-0.5 font-eng tracking-tighter mr-3">TG</div>
            <span class="font-bold text-gray-300 tracking-wider text-sm">ç®¡ç†ä¸­æ¢</span>
        </div>
        <nav class="flex-1 py-6 space-y-1 font-mono text-xs overflow-y-auto">
            <a href="/admin/admin.html" class="sidebar-item flex items-center px-6 py-3 text-gray-400"><span class="icon mr-3">âŒ‚</span> æ¦‚è§ˆ</a>
            <p class="px-6 text-[#555] mb-2 font-bold mt-4">èµ›äº‹æ ¸å¿ƒ</p>
            <a href="/admin/admin-contests.html" class="sidebar-item flex items-center px-6 py-3 text-gray-400"><span class="icon mr-3">âš‘</span> æ¯”èµ›ç®¡ç†</a>
            <a href="/admin/admin-question-bank.html" class="sidebar-item active flex items-center px-6 py-3 text-gray-400"><span class="icon mr-3">â˜·</span> é¢˜åº“</a>
            <a href="/admin/admin-users.html" class="sidebar-item flex items-center px-6 py-3 text-gray-400"><span class="icon mr-3">ì›ƒ</span> ç”¨æˆ·ç®¡ç†</a>
            <a href="/admin/admin-teams.html" class="sidebar-item flex items-center px-6 py-3 text-gray-400"><span class="icon mr-3">â—ˆ</span> é˜Ÿä¼ç®¡ç†</a>
            <a href="/admin/admin-organizations.html" class="sidebar-item flex items-center px-6 py-3 text-gray-400"><span class="icon mr-3">ğŸ¢</span> ç»„ç»‡ç®¡ç†</a>
            <a href="/admin/admin-data-import.html" class="sidebar-item flex items-center px-6 py-3 text-gray-400"><span class="icon mr-3">ğŸ“¥</span> æ•°æ®å¯¼å…¥</a>
            <p class="px-6 text-[#555] mb-2 font-bold mt-6">è¿ç»´ç›‘æ§</p>
            <a href="/admin/admin-docker.html" class="sidebar-item flex items-center px-6 py-3 text-gray-400"><span class="icon mr-3">ğŸ³</span> dockerå®ä¾‹ç®¡ç†</a>
            <a href="/admin/admin-anti-cheat.html" class="sidebar-item flex items-center px-6 py-3 text-gray-400"><span class="icon mr-3">ğŸ›¡ï¸</span> é˜²ä½œå¼Šç³»ç»Ÿ</a>
            <a href="/admin/admin-logs.html" class="sidebar-item flex items-center px-6 py-3 text-gray-400"><span class="icon mr-3">âš </span> ç³»ç»Ÿæ—¥å¿—</a>
            <a href="/admin/admin-settings.html" class="sidebar-item flex items-center px-6 py-3 text-gray-400"><span class="icon mr-3">âš™</span> ç³»ç»Ÿè®¾ç½®</a>
        </nav>
        <div class="p-4 border-t border-[#333]">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 bg-[#333] rounded-full flex items-center justify-center text-[#ff6b00] font-bold">A</div>
                <div><p class="text-xs text-white font-bold">è¶…çº§ç®¡ç†å‘˜</p><p class="text-[10px] text-green-500">â— è¿æ¥ç¨³å®š</p></div>
            </div>
        </div>
    </aside>

    <!-- å³ä¾§å†…å®¹åŒº -->
    <div class="flex-1 flex flex-col min-w-0 bg-[#121212]">
        <header class="h-16 bg-[#161616] border-b border-[#333] flex items-center justify-between px-8 z-10">
            <div class="flex items-center gap-4 text-xs font-mono">
                <span class="text-gray-500">ä½ç½®:</span>
                <a href="/admin/admin-question-bank.html" class="text-[#ff6b00] hover:text-white">é¢˜åº“</a>
                <span class="text-gray-600">/</span>
                <a href="/admin/admin-questions.html" class="text-[#ff6b00] hover:text-white">é¢˜ç›®åˆ—è¡¨</a>
                <span class="text-gray-600">/</span>
                <span class="text-white" id="page-title">æ–°å¢é¢˜ç›®</span>
            </div>
            <div class="flex items-center gap-3">
                <a href="/home.html" class="font-mono text-xs font-bold border border-gray-500 text-gray-400 px-4 py-2 hover:border-white hover:text-white transition-all uppercase tracking-wider">â† è¿”å›å‰å°</a>
                <button id="logout-btn" class="font-mono text-xs font-bold border border-[#ff6b00] text-[#ff6b00] px-4 py-2 hover:bg-[#ff6b00] hover:text-black transition-all uppercase tracking-wider">Logout_ç¦»çº¿</button>
            </div>
        </header>

        <main class="flex-1 flex flex-col pt-4 px-6 relative overflow-y-auto">
            <div class="absolute inset-0 z-0 opacity-10 pointer-events-none" style="background-image: radial-gradient(#333 1px, transparent 1px); background-size: 20px 20px;"></div>
            
            <div class="relative z-10 w-full max-w-[1200px] mx-auto">
                
                <form id="question-form">
                    <!-- ç¬¬ä¸€è¡Œï¼šæ ‡é¢˜ã€ç±»å‹ã€ç±»åˆ«ã€éš¾åº¦ -->
                    <div style="display: grid; grid-template-columns: repeat(4, minmax(0, 1fr)); gap: 12px;" class="mb-3 mt-4">
                        <div>
                            <label class="form-label">é¢˜ç›®æ ‡é¢˜ <span class="form-required">*</span></label>
                            <input type="text" id="form-title" class="form-input" placeholder="å¦‚ï¼šSQL Injection Lab" required>
                        </div>
                        <div>
                            <label class="form-label">é¢˜ç›®ç±»å‹ <span class="form-required">*</span></label>
                            <select id="form-type" class="form-input form-select" onchange="onTypeChange()" required>
                                <option value="">è¯·é€‰æ‹©ç±»å‹</option>
                                <option value="static_attachment">ğŸ“ é™æ€é™„ä»¶</option>
                                <option value="static_container">ğŸ³ é™æ€å®¹å™¨</option>
                                <option value="dynamic_attachment">ğŸ“¦ åŠ¨æ€é™„ä»¶</option>
                                <option value="dynamic_container">âš¡ åŠ¨æ€å®¹å™¨</option>
                            </select>
                        </div>
                        <div>
                            <label class="form-label">é¢˜ç›®ç±»åˆ« <span class="form-required">*</span></label>
                            <select id="form-category" class="form-input form-select" required>
                                <option value="">è¯·é€‰æ‹©ç±»åˆ«</option>
                            </select>
                        </div>
                        <div>
                            <label class="form-label">é¢˜ç›®éš¾åº¦ <span id="difficulty-value" class="text-[#ff6b00] ml-1">5</span></label>
                            <div class="star-rating" id="star-rating">
                                <span class="star" data-value="1">â˜…</span>
                                <span class="star" data-value="2">â˜…</span>
                                <span class="star" data-value="3">â˜…</span>
                                <span class="star" data-value="4">â˜…</span>
                                <span class="star" data-value="5">â˜…</span>
                                <span class="star" data-value="6">â˜…</span>
                                <span class="star" data-value="7">â˜…</span>
                                <span class="star" data-value="8">â˜…</span>
                                <span class="star" data-value="9">â˜…</span>
                                <span class="star" data-value="10">â˜…</span>
                            </div>
                            <input type="hidden" id="form-difficulty" value="5">
                        </div>
                    </div>

                    <!-- é¢˜ç›®æè¿°ï¼ˆæ”¯æŒMarkdownï¼‰ -->
                    <div class="mb-3">
                        <label class="form-label">é¢˜ç›®æè¿° <span class="text-gray-500 font-normal">(æ”¯æŒMarkdown)</span></label>
                        <textarea id="form-description" class="form-input" rows="5" placeholder="é¢˜ç›®æè¿°ã€è§£é¢˜æç¤ºç­‰..."></textarea>
                    </div>

                    <!-- Flagè®¾ç½® -->
                    <div class="flex items-center gap-3 mb-3" id="flag-section">
                        <label class="form-label whitespace-nowrap mb-0">Flagè®¾ç½® <span class="form-required" id="flag-required">*</span></label>
                        <input type="text" id="form-flag" class="form-input flex-1" placeholder="flag{...}">
                        <p class="form-hint mb-0 whitespace-nowrap" id="flag-hint">é™æ€é¢˜ç›®éœ€è®¾ç½®å›ºå®šFlag</p>
                    </div>

                    <!-- é™„ä»¶è®¾ç½®ï¼ˆæ‰€æœ‰é¢˜ç›®ç±»å‹éƒ½å¯æ·»åŠ é™„ä»¶ï¼‰ -->
                    <div class="form-section mb-3" id="attachment-section">
                        <h3 class="form-section-title">é™„ä»¶è®¾ç½® <span class="text-gray-500 font-normal text-xs">(å¯é€‰)</span></h3>
                        <div class="flex items-center gap-4 mb-3">
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="radio" name="attachment-type" value="url" checked onchange="onAttachmentTypeChange()" class="w-4 h-4 accent-[#ff6b00]">
                                <span class="text-sm text-gray-400">å¤–éƒ¨é“¾æ¥</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="radio" name="attachment-type" value="local" onchange="onAttachmentTypeChange()" class="w-4 h-4 accent-[#ff6b00]">
                                <span class="text-sm text-gray-400">æœ¬åœ°ä¸Šä¼ </span>
                            </label>
                        </div>
                        <!-- URLè¾“å…¥ -->
                        <div id="attachment-url-input">
                            <input type="text" id="form-attachment" class="form-input" placeholder="https://...">
                            <p class="form-hint">è¾“å…¥é™„ä»¶çš„å¤–éƒ¨ä¸‹è½½é“¾æ¥</p>
                        </div>
                        <!-- æœ¬åœ°ä¸Šä¼  -->
                        <div id="attachment-upload-input" class="hidden">
                            <div class="flex items-center gap-3">
                                <input type="file" id="form-attachment-file" class="hidden" onchange="handleAttachmentUpload(this)">
                                <button type="button" onclick="document.getElementById('form-attachment-file').click()" class="border border-[#ff6b00] text-[#ff6b00] px-4 py-2 text-sm font-mono hover:bg-[#ff6b00] hover:text-black transition-all">
                                    é€‰æ‹©æ–‡ä»¶
                                </button>
                                <span id="attachment-filename" class="text-gray-500 text-sm font-mono">æœªé€‰æ‹©æ–‡ä»¶</span>
                                <span id="attachment-upload-status" class="text-xs font-mono hidden"></span>
                            </div>
                            <p class="form-hint">ä¸Šä¼ é™„ä»¶åˆ°æœåŠ¡å™¨ï¼Œç”¨æˆ·å¯ç›´æ¥ä¸‹è½½</p>
                            <input type="hidden" id="form-attachment-path">
                        </div>
                    </div>

                    <!-- å®¹å™¨è®¾ç½® -->
                    <div class="form-section hidden" id="container-section">
                        <h3 class="form-section-title">å®¹å™¨è®¾ç½®</h3>
                        
                        <!-- Dockeré•œåƒåï¼ˆæ•´è¡Œï¼‰ -->
                        <div class="mb-3">
                            <label class="form-label">Dockeré•œåƒå <span class="form-required">*</span></label>
                            <input type="text" id="form-docker-image" class="form-input" placeholder="ctf/web-sqli:latest">
                        </div>

                        <!-- æœåŠ¡ç«¯å£ | Flagæ³¨å…¥æ–¹å¼ -->
                        <div style="display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 16px;" class="mb-3">
                            <div>
                                <label class="form-label">æœåŠ¡ç«¯å£</label>
                                <div id="ports-container">
                                    <div class="port-item">
                                        <input type="text" class="form-input port-input" placeholder="80">
                                        <button type="button" class="btn-remove-port" onclick="removePort(this)" style="display:none;">&times;</button>
                                    </div>
                                </div>
                                <button type="button" onclick="addPort()" class="text-[#ff6b00] text-xs font-mono hover:text-white">+ æ·»åŠ ç«¯å£</button>
                            </div>
                            <div>
                                <label class="form-label">Flagæ³¨å…¥æ–¹å¼ <span class="text-gray-500 font-normal">(å¯å¤šé€‰)</span></label>
                                <div id="flag-env-list" class="flex flex-wrap gap-2">
                                    <!-- åŠ¨æ€åŠ è½½ç¯å¢ƒå˜é‡åˆ—è¡¨ -->
                                </div>
                                <p id="flag-env-empty" class="form-hint text-yellow-500 hidden">æš‚æ— å¯é€‰ï¼Œè¯·å…ˆåœ¨ <a href="/admin/admin-flag-env.html" class="underline text-[#ff6b00]">ç¯å¢ƒå˜é‡ç®¡ç†</a> æ·»åŠ </p>
                                <!-- Flagè„šæœ¬æ³¨å…¥ -->
                                <div class="mt-3">
                                    <label class="flex items-center gap-2 cursor-pointer">
                                        <input type="checkbox" id="use-flag-script" class="w-4 h-4 accent-[#ff6b00]" onchange="toggleFlagScript()">
                                        <span class="text-xs text-gray-400">ä½¿ç”¨ flag.sh è„šæœ¬æ³¨å…¥</span>
                                    </label>
                                    <div id="flag-script-input" class="hidden mt-2">
                                        <input type="text" id="form-flag-script" class="form-input font-mono text-xs" placeholder="/flag.sh">
                                        <p class="form-hint">å®¹å™¨å¯åŠ¨åæ‰§è¡Œè¯¥è„šæœ¬ï¼ŒFlagä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°ä¼ å…¥</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- èµ„æºé™åˆ¶ | ç¯å¢ƒæµ‹è¯• -->
                        <div style="display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 16px;">
                            <!-- èµ„æºé™åˆ¶å— -->
                            <div class="bg-[#111] border border-[#333] p-3">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-xs font-bold text-white">èµ„æºé™åˆ¶</span>
                                    <div class="flex items-center gap-2">
                                        <label class="toggle-switch" style="width:36px;height:20px;">
                                            <input type="checkbox" id="form-no-limit" onchange="toggleResourceLimit()">
                                            <span class="toggle-slider" style="border-radius:20px;"></span>
                                        </label>
                                        <span class="text-gray-500 text-xs">ä¸é™åˆ¶</span>
                                    </div>
                                </div>
                                <div id="resource-limits" style="display: grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap: 8px;">
                                    <div>
                                        <label class="form-label">CPU</label>
                                        <input type="text" id="form-cpu" class="form-input" placeholder="1.0">
                                    </div>
                                    <div>
                                        <label class="form-label">å†…å­˜</label>
                                        <input type="text" id="form-memory" class="form-input" placeholder="512m">
                                    </div>
                                    <div>
                                        <label class="form-label">å­˜å‚¨</label>
                                        <input type="text" id="form-storage" class="form-input" placeholder="1g">
                                    </div>
                                </div>
                            </div>

                            <!-- ç¯å¢ƒæµ‹è¯•å— -->
                            <div class="test-section">
                                <div class="flex items-center gap-3 mb-2">
                                    <span class="text-xs font-bold text-white">ğŸ§ª ç¯å¢ƒæµ‹è¯•</span>
                                    <button type="button" id="btn-check-image" class="test-btn test-btn-check" onclick="checkImage()">æ£€æµ‹é•œåƒ</button>
                                    <button type="button" id="btn-create-test" class="test-btn test-btn-create" onclick="createTestContainer()" disabled>åˆ›å»ºæµ‹è¯•å®¹å™¨</button>
                                </div>
                                <div id="test-result" class="test-result hidden"></div>
                            </div>
                        </div>
                    </div>

                    <!-- ä¿å­˜æŒ‰é’® -->
                    <div class="flex gap-3 mt-4">
                        <button type="button" id="btn-prev" onclick="goToPrevQuestion()" class="border border-[#333] text-gray-400 px-4 py-3 hover:border-white hover:text-white transition-all font-mono text-sm disabled:opacity-30 disabled:cursor-not-allowed" disabled>â† ä¸Šä¸€é¢˜</button>
                        <a href="/admin/admin-questions.html" class="flex-1 border border-[#333] text-gray-400 py-3 text-center hover:border-white hover:text-white transition-all font-mono text-sm">è¿”å›åˆ—è¡¨</a>
                        <button type="submit" class="flex-1 bg-[#ff6b00] text-black py-3 font-bold hover:bg-white transition-all font-mono text-sm text-center">ä¿å­˜é¢˜ç›®</button>
                        <button type="button" id="btn-next" onclick="goToNextQuestion()" class="border border-[#333] text-gray-400 px-4 py-3 hover:border-white hover:text-white transition-all font-mono text-sm disabled:opacity-30 disabled:cursor-not-allowed" disabled>ä¸‹ä¸€é¢˜ â†’</button>
                    </div>
                </form>

            </div>
        </main>
    </div>

    <script>
        function parseJwt(token) {
            try {
                const base64Url = token.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const jsonPayload = decodeURIComponent(atob(base64).split('').map(c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join(''));
                return JSON.parse(jsonPayload);
            } catch (e) { return null; }
        }

        const token = localStorage.getItem('tg_token');
        if (!token) {
            window.location.href = '/login.html';
        } else {
            const payload = parseJwt(token);
            if (!payload || payload.role !== 'super') {
                alert('æƒé™ä¸è¶³');
                window.location.href = '/home.html';
            }
        }

        document.getElementById('logout-btn').addEventListener('click', () => {
            localStorage.removeItem('tg_token');
            window.location.href = '/login.html';
        });

        // å¤åˆ¶åˆ°å‰ªè´´æ¿
        function copyToClipboard(text) {
            // å°è¯•ç°ä»£API
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(text).then(() => {
                    showCopyToast(text);
                }).catch(() => {
                    fallbackCopy(text);
                });
            } else {
                fallbackCopy(text);
            }
        }
        
        function fallbackCopy(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'fixed';
            textarea.style.opacity = '0';
            document.body.appendChild(textarea);
            textarea.select();
            try {
                document.execCommand('copy');
                showCopyToast(text);
            } catch (e) {
                alert('å¤åˆ¶å¤±è´¥');
            }
            document.body.removeChild(textarea);
        }
        
        function showCopyToast(text) {
            const toast = document.createElement('div');
            toast.className = 'fixed top-4 right-4 bg-green-600 text-white px-4 py-2 text-sm z-50';
            toast.textContent = 'âœ“ å·²å¤åˆ¶: ' + text;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 2000);
        }

        // è·å–URLå‚æ•°
        const urlParams = new URLSearchParams(window.location.search);
        const editId = urlParams.get('id');
        let currentType = '';
        let imageExists = false;
        let currentDifficulty = 5;
        let currentTestContainer = null; // å½“å‰æµ‹è¯•å®¹å™¨ä¿¡æ¯

        // æ˜Ÿçº§è¯„åˆ†
        const starRating = document.getElementById('star-rating');
        const stars = starRating.querySelectorAll('.star');
        
        function setDifficulty(value) {
            currentDifficulty = value;
            document.getElementById('form-difficulty').value = value;
            document.getElementById('difficulty-value').textContent = value;
            stars.forEach((star, i) => {
                star.classList.toggle('active', i < value);
            });
        }
        
        stars.forEach(star => {
            star.addEventListener('click', () => {
                setDifficulty(parseInt(star.dataset.value));
            });
            star.addEventListener('mouseenter', () => {
                const val = parseInt(star.dataset.value);
                stars.forEach((s, i) => {
                    s.classList.toggle('hover-preview', i < val && i >= currentDifficulty);
                });
            });
            star.addEventListener('mouseleave', () => {
                stars.forEach(s => s.classList.remove('hover-preview'));
            });
        });
        setDifficulty(5); // é»˜è®¤éš¾åº¦

        // Flagæ³¨å…¥ç¯å¢ƒå˜é‡ - ä» localStorage è¯»å– (ä¸ admin-flag-env.html å…±äº«)
        const FLAG_ENV_STORAGE_KEY = 'tg_flag_envs';
        
        function getFlagEnvList() {
            const stored = localStorage.getItem(FLAG_ENV_STORAGE_KEY);
            if (!stored) return [];
            try {
                return JSON.parse(stored);
            } catch (e) {
                return [];
            }
        }

        function renderFlagEnvCheckboxes() {
            const container = document.getElementById('flag-env-list');
            const emptyHint = document.getElementById('flag-env-empty');
            const envList = getFlagEnvList();
            
            if (envList.length === 0) {
                container.innerHTML = '';
                emptyHint.classList.remove('hidden');
                return;
            }
            
            emptyHint.classList.add('hidden');
            container.innerHTML = envList.map(env => {
                // CMDARG æ˜¾ç¤ºä¸º $1
                const displayName = env.name === 'CMDARG' ? '$1' : '$' + env.name;
                return `
                <label class="flex items-center gap-2 px-3 py-2 bg-[#111] border border-[#333] cursor-pointer hover:border-[#ff6b00] transition-colors">
                    <input type="checkbox" name="flag-env" value="${env.name}" class="w-4 h-4 accent-[#ff6b00]" ${env.isDefault ? 'checked' : ''}>
                    <span class="font-mono text-xs text-[#ff6b00]">${displayName}</span>
                    <span class="text-xs text-gray-500">${env.desc || ''}</span>
                </label>
            `}).join('');
        }

        function getFlagEnv() {
            // è¿”å›é€‰ä¸­çš„ç¯å¢ƒå˜é‡ï¼Œç”¨é€—å·åˆ†éš”
            const checked = document.querySelectorAll('input[name="flag-env"]:checked');
            const values = Array.from(checked).map(cb => cb.value);
            return values.join(',') || 'FLAG'; // é»˜è®¤FLAG
        }

        function setFlagEnv(value) {
            if (!value) return;
            const values = value.split(',').map(v => v.trim());
            document.querySelectorAll('input[name="flag-env"]').forEach(cb => {
                cb.checked = values.includes(cb.value);
            });
        }

        // Flagè„šæœ¬æ³¨å…¥
        function toggleFlagScript() {
            const checkbox = document.getElementById('use-flag-script');
            const inputDiv = document.getElementById('flag-script-input');
            inputDiv.classList.toggle('hidden', !checkbox.checked);
            if (!checkbox.checked) {
                document.getElementById('form-flag-script').value = '';
            }
        }

        function setFlagScript(value) {
            const checkbox = document.getElementById('use-flag-script');
            const input = document.getElementById('form-flag-script');
            if (value) {
                checkbox.checked = true;
                input.value = value;
                document.getElementById('flag-script-input').classList.remove('hidden');
            } else {
                checkbox.checked = false;
                input.value = '';
                document.getElementById('flag-script-input').classList.add('hidden');
            }
        }

        function getFlagScript() {
            const checkbox = document.getElementById('use-flag-script');
            if (!checkbox.checked) return '';
            return document.getElementById('form-flag-script').value.trim();
        }

        // åŠ è½½ç±»åˆ«
        async function loadCategories() {
            try {
                const res = await fetch('/api/admin/categories', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                if (res.ok) {
                    const categories = await res.json();
                    const select = document.getElementById('form-category');
                    select.innerHTML = '<option value="">è¯·é€‰æ‹©ç±»åˆ«</option>' + 
                        categories.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
                }
            } catch (e) {
                console.error(e);
            }
        }

        // åŠ è½½ç¼–è¾‘æ•°æ®
        async function loadQuestion() {
            if (!editId) return;
            
            document.getElementById('page-title').textContent = 'ç¼–è¾‘é¢˜ç›®';
            
            try {
                const res = await fetch(`/api/admin/questions/${editId}`, {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                if (!res.ok) throw new Error('Failed');
                
                const q = await res.json();
                
                document.getElementById('form-title').value = q.title;
                document.getElementById('form-category').value = q.categoryId;
                document.getElementById('form-difficulty').value = q.difficulty;
                setDifficulty(parseInt(q.difficulty) || 5);
                document.getElementById('form-description').value = q.description || '';
                document.getElementById('form-flag').value = q.flag || '';
                document.getElementById('form-attachment').value = q.attachmentUrl || '';
                document.getElementById('form-docker-image').value = q.dockerImage || '';
                
                // åŠ è½½é™„ä»¶ç±»å‹
                const attachmentType = q.attachmentType || 'url';
                document.querySelector(`input[name="attachment-type"][value="${attachmentType}"]`).checked = true;
                onAttachmentTypeChange();
                if (attachmentType === 'local' && q.attachmentUrl) {
                    document.getElementById('form-attachment-path').value = q.attachmentUrl;
                    const filename = q.attachmentUrl.split('/').pop();
                    document.getElementById('attachment-filename').textContent = filename || 'å·²ä¸Šä¼ ';
                }
                
                document.getElementById('form-cpu').value = q.cpuLimit || '';
                document.getElementById('form-memory').value = q.memoryLimit || '';
                document.getElementById('form-storage').value = q.storageLimit || '';
                document.getElementById('form-no-limit').checked = q.noResourceLimit;
                setFlagEnv(q.flagEnv || 'FLAG');
                setFlagScript(q.flagScript || '');
                
                // åŠ è½½ç«¯å£
                if (q.ports) {
                    try {
                        const ports = JSON.parse(q.ports);
                        const container = document.getElementById('ports-container');
                        container.innerHTML = '';
                        ports.forEach((port, i) => {
                            const div = document.createElement('div');
                            div.className = 'port-item';
                            div.innerHTML = `
                                <input type="text" class="form-input port-input" value="${port}" placeholder="80">
                                <button type="button" class="btn-remove-port" onclick="removePort(this)" ${i === 0 ? 'style="display:none;"' : ''}>&times;</button>
                            `;
                            container.appendChild(div);
                        });
                    } catch (e) {}
                }
                
                selectType(q.type);
                toggleResourceLimit();
            } catch (e) {
                console.error(e);
                alert('åŠ è½½é¢˜ç›®å¤±è´¥');
            }
        }

        function selectType(type) {
            currentType = type;
            document.getElementById('form-type').value = type;
            updateTypeUI();
        }

        function onTypeChange() {
            const type = document.getElementById('form-type').value;
            selectType(type);
        }

        function updateTypeUI() {
            const type = currentType;
            
            document.querySelectorAll('.type-card').forEach(card => {
                card.classList.toggle('selected', card.dataset.type === type);
            });
            
            // æ˜¾ç¤º/éšè—ç›¸å…³åŒºåŸŸï¼ˆé™„ä»¶åŒºåŸŸå§‹ç»ˆæ˜¾ç¤ºï¼‰
            const isContainer = type.includes('container');
            const isDynamic = type.includes('dynamic');
            
            document.getElementById('container-section').classList.toggle('hidden', !isContainer);
            
            // Flagæç¤º
            if (isDynamic) {
                document.getElementById('flag-required').style.display = 'none';
                document.getElementById('flag-hint').textContent = 'åŠ¨æ€é¢˜ç›®çš„Flagç”±å®¹å™¨ç”Ÿæˆï¼Œæ­¤å¤„å¯ç•™ç©º';
                document.getElementById('form-flag').required = false;
            } else {
                document.getElementById('flag-required').style.display = '';
                document.getElementById('flag-hint').textContent = 'é™æ€é¢˜ç›®éœ€è¦è®¾ç½®å›ºå®šFlag';
                document.getElementById('form-flag').required = true;
            }
        }

        function addPort() {
            const container = document.getElementById('ports-container');
            const div = document.createElement('div');
            div.className = 'port-item';
            div.innerHTML = `
                <input type="text" class="form-input port-input" placeholder="8080">
                <button type="button" class="btn-remove-port" onclick="removePort(this)">&times;</button>
            `;
            container.appendChild(div);
        }

        function removePort(btn) {
            btn.parentElement.remove();
        }

        function toggleResourceLimit() {
            const noLimit = document.getElementById('form-no-limit').checked;
            const limits = document.getElementById('resource-limits');
            limits.style.display = noLimit ? 'none' : 'grid';
        }

        // ========== é™„ä»¶ç®¡ç† ==========
        let currentAttachmentType = 'url';
        let uploadedAttachmentPath = '';

        function onAttachmentTypeChange() {
            const type = document.querySelector('input[name="attachment-type"]:checked').value;
            currentAttachmentType = type;
            document.getElementById('attachment-url-input').classList.toggle('hidden', type !== 'url');
            document.getElementById('attachment-upload-input').classList.toggle('hidden', type !== 'local');
        }

        async function handleAttachmentUpload(input) {
            if (!input.files || !input.files[0]) return;
            
            const file = input.files[0];
            const filenameSpan = document.getElementById('attachment-filename');
            const statusSpan = document.getElementById('attachment-upload-status');
            
            filenameSpan.textContent = file.name;
            statusSpan.textContent = 'ä¸Šä¼ ä¸­...';
            statusSpan.className = 'text-xs font-mono text-yellow-500';
            statusSpan.classList.remove('hidden');
            
            try {
                const formData = new FormData();
                formData.append('file', file, file.name);
                
                const res = await fetch('/api/admin/attachments/upload', {
                    method: 'POST',
                    headers: { 'Authorization': 'Bearer ' + token },
                    body: formData
                });
                
                const data = await res.json();
                
                if (!res.ok) {
                    statusSpan.textContent = 'ä¸Šä¼ å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯');
                    statusSpan.className = 'text-xs font-mono text-red-500';
                    return;
                }
                
                uploadedAttachmentPath = data.url;
                document.getElementById('form-attachment-path').value = data.url;
                statusSpan.textContent = 'âœ“ ä¸Šä¼ æˆåŠŸ';
                statusSpan.className = 'text-xs font-mono text-green-500';
            } catch (e) {
                console.error(e);
                statusSpan.textContent = 'ä¸Šä¼ å¤±è´¥: ' + e.message;
                statusSpan.className = 'text-xs font-mono text-red-500';
            }
        }

        function getAttachmentData() {
            const type = currentAttachmentType;
            let url = '';
            if (type === 'url') {
                url = document.getElementById('form-attachment').value;
            } else {
                url = document.getElementById('form-attachment-path').value;
            }
            return { attachmentUrl: url, attachmentType: type };
        }

        async function checkImage() {
            const imageName = document.getElementById('form-docker-image').value;
            if (!imageName) {
                alert('è¯·å…ˆå¡«å†™Dockeré•œåƒå');
                return;
            }
            
            const resultDiv = document.getElementById('test-result');
            resultDiv.classList.remove('hidden', 'success', 'error');
            resultDiv.textContent = 'æ£€æµ‹ä¸­...';
            
            try {
                const res = await fetch('/api/admin/docker/check-image', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + token,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ image: imageName })
                });
                
                const data = await res.json();
                
                if (!res.ok) {
                    resultDiv.classList.add('error');
                    resultDiv.textContent = `Ã— ${data.message || data.error}`;
                    imageExists = false;
                    document.getElementById('btn-create-test').disabled = true;
                    return;
                }
                
                if (data.exists) {
                    imageExists = true;
                    resultDiv.classList.add('success');
                    resultDiv.textContent = `âœ“ é•œåƒ "${imageName}" å­˜åœ¨ (å¤§å°: ${data.size || 'N/A'})`;
                    document.getElementById('btn-create-test').disabled = false;
                } else {
                    imageExists = false;
                    resultDiv.classList.add('error');
                    resultDiv.innerHTML = `Ã— é•œåƒä¸å­˜åœ¨äºæœ¬åœ° <button type="button" onclick="pullImage()" class="ml-2 underline">æ‹‰å–é•œåƒ</button>`;
                    document.getElementById('btn-create-test').disabled = true;
                }
            } catch (e) {
                console.error(e);
                resultDiv.classList.add('error');
                resultDiv.textContent = 'Ã— æ£€æµ‹å¤±è´¥ï¼Œè¯·ç¡®è®¤DockeræœåŠ¡æ­£å¸¸è¿è¡Œ';
                imageExists = false;
            }
        }
        
        async function pullImage() {
            const imageName = document.getElementById('form-docker-image').value;
            if (!imageName) return;
            
            const resultDiv = document.getElementById('test-result');
            resultDiv.classList.remove('success', 'error');
            resultDiv.textContent = 'æ­£åœ¨æ‹‰å–é•œåƒï¼Œè¯·ç¨å€™...';
            
            try {
                const res = await fetch('/api/admin/docker/pull-image', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + token,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ image: imageName })
                });
                
                const data = await res.json();
                
                if (res.ok) {
                    imageExists = true;
                    resultDiv.classList.add('success');
                    resultDiv.textContent = `âœ“ é•œåƒæ‹‰å–æˆåŠŸ`;
                    document.getElementById('btn-create-test').disabled = false;
                } else {
                    resultDiv.classList.add('error');
                    resultDiv.textContent = `Ã— æ‹‰å–å¤±è´¥: ${data.message || data.error}`;
                }
            } catch (e) {
                console.error(e);
                resultDiv.classList.add('error');
                resultDiv.textContent = 'Ã— æ‹‰å–å¤±è´¥';
            }
        }

        async function createTestContainer() {
            if (!imageExists) {
                alert('è¯·å…ˆæ£€æµ‹é•œåƒæ˜¯å¦å­˜åœ¨');
                return;
            }
            
            // æ£€æŸ¥æ˜¯å¦å·²æœ‰è¿è¡Œä¸­çš„å®¹å™¨
            if (currentTestContainer) {
                alert('å·²æœ‰æµ‹è¯•å®¹å™¨è¿è¡Œä¸­ï¼Œè¯·å…ˆåœæ­¢å¹¶åˆ é™¤');
                return;
            }
            
            const resultDiv = document.getElementById('test-result');
            resultDiv.classList.remove('success', 'error', 'hidden');
            resultDiv.textContent = 'æ­£åœ¨åˆ›å»ºæµ‹è¯•å®¹å™¨...';
            
            // æ”¶é›†ç«¯å£
            const ports = [];
            document.querySelectorAll('.port-input').forEach(input => {
                if (input.value.trim()) ports.push(input.value.trim());
            });
            
            const questionId = editId ? parseInt(editId) : 0;
            
            // æ”¶é›†Flagç¯å¢ƒå˜é‡
            const flagEnvs = [];
            document.querySelectorAll('input[name="flag-env"]:checked').forEach(cb => {
                flagEnvs.push(cb.value);
            });
            // è·å–flagï¼ŒåŠ¨æ€å®¹å™¨è‡ªåŠ¨ç”Ÿæˆæµ‹è¯•flag
            let flag = document.getElementById('form-flag').value;
            if (!flag && currentType && currentType.includes('dynamic')) {
                // ç”ŸæˆUUIDæ ¼å¼çš„flag
                const uuid = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                    const r = Math.random() * 16 | 0;
                    const v = c === 'x' ? r : (r & 0x3 | 0x8);
                    return v.toString(16);
                });
                flag = 'flag{' + uuid + '}';
            }
            
            try {
                const res = await fetch('/api/admin/docker/test-container', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + token,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        questionId: questionId,
                        image: document.getElementById('form-docker-image').value,
                        ports: ports,
                        cpuLimit: document.getElementById('form-cpu').value,
                        memoryLimit: document.getElementById('form-memory').value,
                        flag: flag,
                        flagEnvs: flagEnvs,
                        flagScript: getFlagScript()
                    })
                });
                
                const data = await res.json();
                
                if (res.ok) {
                    // ä¿å­˜å®¹å™¨ä¿¡æ¯
                    currentTestContainer = {
                        id: data.containerId,
                        ports: data.ports,
                        questionId: questionId
                    };
                    // å­˜å‚¨åˆ°localStorage
                    localStorage.setItem(`tg_test_container_${questionId}`, JSON.stringify(currentTestContainer));
                    
                    showTestContainerInfo(data.containerId, data.ports);
                    document.getElementById('btn-create-test').disabled = true;
                } else {
                    resultDiv.classList.add('error');
                    resultDiv.textContent = `Ã— åˆ›å»ºå¤±è´¥: ${data.message || data.error}`;
                }
            } catch (e) {
                console.error(e);
                resultDiv.classList.add('error');
                resultDiv.textContent = 'Ã— åˆ›å»ºå¤±è´¥';
            }
        }
        
        function showTestContainerInfo(containerId, ports) {
            const resultDiv = document.getElementById('test-result');
            const hostIp = window.location.hostname;
            let portsHtml = '';
            if (ports && Object.keys(ports).length > 0) {
                portsHtml = '<div class="mt-2" style="display: flex; flex-direction: column; gap: 8px;">';
                for (const [containerPort, hostPort] of Object.entries(ports)) {
                    const addr = `${hostIp}:${hostPort}`;
                    portsHtml += `
                        <div style="display: inline-flex; align-items: center; gap: 4px;">
                            <code class="bg-black px-2 py-1 text-[#ff6b00] font-mono text-sm">${addr}</code>
                            <button type="button" onclick="copyToClipboard('${addr}')" class="px-2 py-1 border border-[#555] text-gray-400 text-xs hover:border-[#ff6b00] hover:text-[#ff6b00]">å¤åˆ¶</button>
                            <a href="http://${addr}" target="_blank" class="px-2 py-1 border border-[#555] text-gray-400 text-xs hover:border-[#ff6b00] hover:text-[#ff6b00]">è®¿é—®</a>
                        </div>
                    `;
                }
                portsHtml += '</div>';
            }
            resultDiv.classList.remove('hidden', 'error');
            resultDiv.classList.add('success');
            resultDiv.innerHTML = `
                âœ“ æµ‹è¯•å®¹å™¨è¿è¡Œä¸­ <span class="text-gray-500">(${containerId})</span>
                ${portsHtml}
                <button type="button" onclick="stopTestContainer('${containerId}')" class="mt-2 px-3 py-1 border border-red-500 text-red-500 text-xs hover:bg-red-500 hover:text-white">åœæ­¢å¹¶åˆ é™¤å®¹å™¨</button>
            `;
        }
        
        async function stopTestContainer(containerId) {
            try {
                const res = await fetch(`/api/admin/docker/test-container/${containerId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                
                const resultDiv = document.getElementById('test-result');
                if (res.ok) {
                    // æ¸…é™¤çŠ¶æ€
                    const questionId = editId ? parseInt(editId) : 0;
                    localStorage.removeItem(`tg_test_container_${questionId}`);
                    currentTestContainer = null;
                    
                    resultDiv.classList.remove('error');
                    resultDiv.classList.add('success');
                    resultDiv.textContent = 'âœ“ å®¹å™¨å·²åˆ é™¤';
                    document.getElementById('btn-create-test').disabled = false;
                } else {
                    const data = await res.json();
                    resultDiv.classList.remove('success');
                    resultDiv.classList.add('error');
                    resultDiv.textContent = `Ã— åˆ é™¤å¤±è´¥: ${data.message || data.error}`;
                }
            } catch (e) {
                console.error(e);
            }
        }
        
        // æ£€æŸ¥å¹¶æ¢å¤æµ‹è¯•å®¹å™¨çŠ¶æ€
        async function checkExistingTestContainer() {
            const questionId = editId ? parseInt(editId) : 0;
            const stored = localStorage.getItem(`tg_test_container_${questionId}`);
            if (!stored) return;
            
            try {
                const containerInfo = JSON.parse(stored);
                // éªŒè¯å®¹å™¨æ˜¯å¦è¿˜åœ¨è¿è¡Œ
                const res = await fetch('/api/admin/docker/test-containers', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                if (res.ok) {
                    const containers = await res.json();
                    const running = containers.find(c => c.id.startsWith(containerInfo.id) && c.status.includes('Up'));
                    if (running) {
                        currentTestContainer = containerInfo;
                        showTestContainerInfo(containerInfo.id, containerInfo.ports);
                        document.getElementById('btn-create-test').disabled = true;
                    } else {
                        // å®¹å™¨å·²ä¸å­˜åœ¨ï¼Œæ¸…é™¤å­˜å‚¨
                        localStorage.removeItem(`tg_test_container_${questionId}`);
                    }
                }
            } catch (e) {
                console.error(e);
            }
        }

        // è¡¨å•æäº¤
        document.getElementById('question-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!currentType) {
                alert('è¯·é€‰æ‹©é¢˜ç›®ç±»å‹');
                return;
            }
            
            // æ”¶é›†ç«¯å£
            const ports = [];
            document.querySelectorAll('.port-input').forEach(input => {
                if (input.value.trim()) ports.push(input.value.trim());
            });
            
            // è·å–é™„ä»¶æ•°æ®
            const attachmentData = getAttachmentData();
            
            const data = {
                title: document.getElementById('form-title').value,
                type: currentType,
                categoryId: parseInt(document.getElementById('form-category').value),
                difficulty: parseInt(document.getElementById('form-difficulty').value),
                description: document.getElementById('form-description').value,
                flag: document.getElementById('form-flag').value,
                flagType: currentType.includes('dynamic') ? 'dynamic' : 'static',
                attachmentUrl: attachmentData.attachmentUrl,
                attachmentType: attachmentData.attachmentType,
                dockerImage: document.getElementById('form-docker-image').value,
                ports: ports.length > 0 ? JSON.stringify(ports) : '',
                cpuLimit: document.getElementById('form-cpu').value,
                memoryLimit: document.getElementById('form-memory').value,
                storageLimit: document.getElementById('form-storage').value,
                noResourceLimit: document.getElementById('form-no-limit').checked,
                flagEnv: getFlagEnv(),
                flagScript: getFlagScript()
            };
            
            try {
                const res = await fetch(editId ? `/api/admin/questions/${editId}` : '/api/admin/questions', {
                    method: editId ? 'PUT' : 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + token,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                if (!res.ok) {
                    const err = await res.json();
                    alert('ä¿å­˜å¤±è´¥: ' + err.error);
                    return;
                }
                
                // æ˜¾ç¤ºä¿å­˜æˆåŠŸæç¤º
                const toast = document.createElement('div');
                toast.className = 'fixed top-4 right-4 bg-green-600 text-white px-6 py-3 font-mono text-sm z-50';
                toast.textContent = 'âœ“ ä¿å­˜æˆåŠŸ';
                document.body.appendChild(toast);
                setTimeout(() => toast.remove(), 2000);
                
                // å¦‚æœæ˜¯æ–°å¢é¢˜ç›®ï¼Œæ›´æ–°URLä¸ºç¼–è¾‘æ¨¡å¼
                if (!editId) {
                    const result = await res.json();
                    if (result.id) {
                        history.replaceState(null, '', `/admin/admin-question-edit.html?id=${result.id}`);
                        editId = result.id.toString();
                        document.getElementById('page-title').textContent = 'ç¼–è¾‘é¢˜ç›®';
                        loadQuestionList(); // é‡æ–°åŠ è½½åˆ—è¡¨ä»¥æ›´æ–°å¯¼èˆª
                    }
                }
            } catch (e) {
                console.error(e);
                alert('ä¿å­˜å¤±è´¥');
            }
        });

        // é¢˜ç›®å¯¼èˆªç›¸å…³
        let questionList = [];
        let currentIndex = -1;

        async function loadQuestionList() {
            try {
                const res = await fetch('/api/admin/questions', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                if (res.ok) {
                    questionList = await res.json();
                    updateNavButtons();
                }
            } catch (e) {
                console.error(e);
            }
        }

        function updateNavButtons() {
            if (!editId || questionList.length === 0) {
                document.getElementById('btn-prev').disabled = true;
                document.getElementById('btn-next').disabled = true;
                return;
            }
            currentIndex = questionList.findIndex(q => q.id == editId);
            document.getElementById('btn-prev').disabled = currentIndex <= 0;
            document.getElementById('btn-next').disabled = currentIndex < 0 || currentIndex >= questionList.length - 1;
        }

        function goToPrevQuestion() {
            if (currentIndex > 0) {
                window.location.href = `/admin/admin-question-edit.html?id=${questionList[currentIndex - 1].id}`;
            }
        }

        function goToNextQuestion() {
            if (currentIndex < questionList.length - 1) {
                window.location.href = `/admin/admin-question-edit.html?id=${questionList[currentIndex + 1].id}`;
            }
        }

        // åˆå§‹åŒ–
        renderFlagEnvCheckboxes(); // åŠ è½½ç¯å¢ƒå˜é‡checkboxåˆ—è¡¨
        loadCategories().then(() => {
            loadQuestion();
        });
        loadQuestionList(); // åŠ è½½é¢˜ç›®åˆ—è¡¨ç”¨äºå¯¼èˆª
        // æ£€æŸ¥ç°æœ‰æµ‹è¯•å®¹å™¨
        checkExistingTestContainer();
    </script>

</body>
</html>
