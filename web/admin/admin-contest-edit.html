<!DOCTYPE html>
<html lang="zh-CN" style="overflow: hidden; height: 100%; margin: 0;">
<head>
    <meta charset="UTF-8">
    <meta name="author" content="tan91">
    <title>ç¼–è¾‘èµ›äº‹ - TG ç®¡ç†åå°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@400;600;700&family=JetBrains+Mono:wght@400;700&family=Noto+Sans+SC:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #121212;
            --bg-panel: #1e1e1e;
            --border-color: #333;
            --accent: #ff6b00;
            --danger: #ef4444;
            --success: #22c55e;
            --pending: #eab308;
            --text-main: #e0e0e0;
            --text-dim: #737373;
        }
        body { background-color: var(--bg-dark); color: var(--text-main); font-family: 'Noto Sans SC', sans-serif; }
        html, body { overflow: hidden !important; height: 100% !important; margin: 0 !important; }
        .font-eng { font-family: 'Chakra Petch', sans-serif; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }

        .admin-card { background: var(--bg-panel); border: 1px solid var(--border-color); position: relative; display: flex; flex-direction: column; }
        
        .sidebar-item { border-left: 2px solid transparent; transition: all 0.2s; }
        .sidebar-item:hover, .sidebar-item.active { background: rgba(255, 107, 0, 0.05); border-left-color: var(--accent); color: white; }
        .sidebar-item.active .icon { color: var(--accent); }
        
        .tactical-input {
            background: #111; border: 1px solid #333; color: white; padding: 0 0.75rem; height: 42px; width: 100%; outline: none; transition: 0.2s; font-family: 'JetBrains Mono', monospace; font-size: 0.875rem;
        }
        .tactical-input:focus { border-color: var(--accent); }
        textarea.tactical-input { height: auto; padding-top: 0.75rem; line-height: 1.5; }

        .form-label { display: block; font-size: 0.75rem; color: #777; font-family: 'JetBrains Mono', monospace; margin-bottom: 0.4rem; text-transform: uppercase; letter-spacing: 0.05em; }

        .btn-primary { background: var(--accent); color: black; font-weight: bold; padding: 0 1.5rem; height: 38px; display: flex; align-items: center; justify-content: center; transition: 0.2s; font-family: 'Chakra Petch', sans-serif; font-size: 0.875rem; }
        .btn-primary:hover { background: white; }
        
        .btn-outline { border: 1px solid var(--border-color); color: #aaa; padding: 0 1rem; height: 38px; display: flex; align-items: center; justify-content: center; transition: 0.2s; font-size: 0.75rem; background: #1a1a1a; }
        .btn-outline:hover { border-color: white; color: white; }

        .tab-btn {
            padding: 0 1.5rem; height: 48px; display: flex; align-items: center; color: #666; font-family: 'Chakra Petch', sans-serif; font-weight: bold; cursor: pointer; border-bottom: 2px solid transparent; transition: 0.3s;
        }
        .tab-btn:hover { color: white; background: rgba(255,255,255,0.02); }
        .tab-btn.active { color: var(--accent); border-bottom-color: var(--accent); background: rgba(255, 107, 0, 0.05); }

        .upload-zone {
            border: 2px dashed #333; background: #151515; height: 100%; min-height: 140px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; transition: 0.3s;
        }
        .upload-zone:hover { border-color: var(--accent); background: rgba(255,107,0,0.05); }

        .status-running { color: var(--success); border: 1px solid var(--success); background: rgba(34, 197, 94, 0.1); }
        .status-pending { color: var(--pending); border: 1px solid var(--pending); background: rgba(234, 179, 8, 0.1); }
        .status-paused { color: #f97316; border: 1px solid #f97316; background: rgba(249, 115, 22, 0.1); }
        .status-ended { color: #666; border: 1px solid #444; background: rgba(255, 255, 255, 0.05); }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #111; }
        ::-webkit-scrollbar-thumb { background: #333; }

        .animate-fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* Toast æç¤ºæ¡† */
        .toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px; }
        .toast { padding: 12px 20px; border-radius: 4px; font-size: 13px; font-family: 'JetBrains Mono', monospace; animation: toastIn 0.3s ease; min-width: 200px; max-width: 400px; }
        .toast-success { background: rgba(34, 197, 94, 0.15); border: 1px solid #22c55e; color: #22c55e; }
        .toast-error { background: rgba(239, 68, 68, 0.15); border: 1px solid #ef4444; color: #ef4444; }
        .toast-warning { background: rgba(234, 179, 8, 0.15); border: 1px solid #eab308; color: #eab308; }
        .toast-info { background: rgba(59, 130, 246, 0.15); border: 1px solid #3b82f6; color: #3b82f6; }
        @keyframes toastIn { from { opacity: 0; transform: translateX(100px); } to { opacity: 1; transform: translateX(0); } }
        @keyframes toastOut { from { opacity: 1; transform: translateX(0); } to { opacity: 0; transform: translateX(100px); } }
    </style>
</head>
<body class="flex h-screen overflow-hidden selection:bg-[#ff6b00] selection:text-black">
    <!-- Toast å®¹å™¨ -->
    <div id="toast-container" class="toast-container"></div>

    <!-- ä¾§è¾¹æ  -->
    <aside class="w-64 bg-[#161616] border-r border-[#333] flex flex-col z-20 shadow-xl shrink-0">
        <div class="h-16 flex items-center px-6 border-b border-[#333]">
            <div class="bg-[#ff6b00] text-black font-black text-xl px-2 py-0.5 font-eng tracking-tighter mr-3">TG</div>
            <span class="font-bold text-gray-300 tracking-wider text-sm">ç®¡ç†ä¸­æ¢</span>
        </div>
        <nav class="flex-1 py-6 space-y-1 font-mono text-xs overflow-y-auto">
            <a href="/admin/admin.html" class="sidebar-item flex items-center px-6 py-3 text-gray-400"><span class="icon mr-3">âŒ‚</span> æ¦‚è§ˆ</a>
            <p class="px-6 text-[#555] mb-2 font-bold mt-4">èµ›äº‹æ ¸å¿ƒ</p>
            <a href="/admin/admin-contests.html" class="sidebar-item active flex items-center px-6 py-3 text-gray-400"><span class="icon mr-3">âš‘</span> æ¯”èµ›ç®¡ç†</a>
            <a href="/admin/admin-question-bank.html" class="sidebar-item flex items-center px-6 py-3 text-gray-400"><span class="icon mr-3">â˜·</span> é¢˜åº“</a>
            <a href="/admin/admin-users.html" class="sidebar-item flex items-center px-6 py-3 text-gray-400"><span class="icon mr-3">ì›ƒ</span> ç”¨æˆ·ç®¡ç†</a>
            <a href="/admin/admin-teams.html" class="sidebar-item flex items-center px-6 py-3 text-gray-400"><span class="icon mr-3">â—ˆ</span> é˜Ÿä¼ç®¡ç†</a>
            <a href="/admin/admin-organizations.html" class="sidebar-item flex items-center px-6 py-3 text-gray-400"><span class="icon mr-3">ğŸ¢</span> ç»„ç»‡ç®¡ç†</a>
            <a href="/admin/admin-data-import.html" class="sidebar-item flex items-center px-6 py-3 text-gray-400"><span class="icon mr-3">ğŸ“¥</span> æ•°æ®å¯¼å…¥</a>
            <p class="px-6 text-[#555] mb-2 font-bold mt-6">è¿ç»´ç›‘æ§</p>
            <a href="/admin/admin-docker.html" class="sidebar-item flex items-center px-6 py-3 text-gray-400"><span class="icon mr-3">ğŸ³</span> dockerå®ä¾‹ç®¡ç†</a>
            <a href="/admin/admin-anti-cheat.html" class="sidebar-item flex items-center px-6 py-3 text-gray-400"><span class="icon mr-3">ğŸ›¡ï¸</span> é˜²ä½œå¼Šç³»ç»Ÿ</a>
            <a href="/admin/admin-logs.html" class="sidebar-item flex items-center px-6 py-3 text-gray-400"><span class="icon mr-3">âš </span> ç³»ç»Ÿæ—¥å¿—</a>
            <a href="/admin/admin-settings.html" class="sidebar-item flex items-center px-6 py-3 text-gray-400"><span class="icon mr-3">âš™</span> ç³»ç»Ÿè®¾ç½®</a>
        </nav>
        <div class="p-4 border-t border-[#333]">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 bg-[#333] rounded-full flex items-center justify-center text-[#ff6b00] font-bold">A</div>
                <div><p class="text-xs text-white font-bold">è¶…çº§ç®¡ç†å‘˜</p><p class="text-[10px] text-green-500">â— è¿æ¥ç¨³å®š</p></div>
            </div>
        </div>
    </aside>

    <!-- ä¸»ä½“ -->
    <div class="flex-1 flex flex-col min-w-0 bg-[#121212] overflow-hidden">
        
        <!-- å¤´éƒ¨ -->
        <header class="h-16 bg-[#161616] border-b border-[#333] flex items-center justify-between px-8 z-10 shrink-0">
            <div class="flex items-center gap-4 text-xs font-mono">
                <span class="text-gray-500">ä½ç½®:</span><span class="text-[#ff6b00]">èµ›äº‹ç®¡ç†</span><span class="text-gray-600">/</span><span class="text-white">ç¼–è¾‘èµ›äº‹</span>
            </div>
            <div class="flex items-center gap-4">
                <span id="status-display" class="text-xs font-mono text-green-500 bg-green-900 bg-opacity-20 px-2 py-1 border border-green-800">â— çŠ¶æ€: è¿›è¡Œä¸­</span>
                <button id="toggle-status-btn" class="text-red-500 border border-red-900 bg-red-900 bg-opacity-10 px-3 py-1 text-xs hover:bg-opacity-30 transition">ç´§æ€¥æš‚åœ</button>
            </div>
        </header>

        <!-- å†…å®¹æ»šåŠ¨åŒº -->
        <main class="flex-1 overflow-hidden pt-8 px-8 relative flex flex-col">
            
            <div class="mb-6 border-b border-[#333] pb-4">
                <div class="flex items-center justify-between mb-2">
                    <h1 id="contest-title" class="text-3xl font-bold text-white font-eng tracking-wide">åŠ è½½ä¸­...</h1>
                    <!-- Tabs -->
                    <div class="flex bg-[#161616]">
                        <div class="tab-btn active" data-tab="config">åŸºç¡€è®¾ç½®</div>
                        <div class="tab-btn" data-tab="broadcast">æ¯”èµ›å…¬å‘Š</div>
                        <div class="tab-btn" data-tab="challenges">é¢˜ç›®ç¼–æ’</div>
                        <div class="tab-btn" data-tab="audit">é˜Ÿä¼å®¡æ ¸</div>
                    </div>
                </div>
                <div class="flex gap-6 text-xs font-mono text-gray-400">
                    <span>ID: <span id="contest-id">--</span></span>
                    <span>MODE: <span id="contest-mode">--</span></span>
                </div>
            </div>

            <!-- TAB 1: åŸºç¡€è®¾ç½® -->
            <div id="tab-config" class="tab-content max-w-7xl animate-fade-in w-full overflow-y-auto flex-1">
                <div class="grid grid-cols-12 gap-6 items-start">
                    
                    <!-- å·¦ä¾§ï¼šå†…å®¹é…ç½® -->
                    <div class="col-span-12 lg:col-span-8 flex flex-col gap-6">
                        
                        <div class="admin-card p-6">
                            <h3 class="text-sm font-bold text-white border-l-4 border-[#ff6b00] pl-3 mb-6">åŸºæœ¬ä¿¡æ¯é…ç½®</h3>
                            <div class="space-y-6">
                                <div>
                                    <label class="form-label">æ¯”èµ›æ ‡é¢˜</label>
                                    <input type="text" id="edit-name" class="tactical-input" placeholder="æ¯”èµ›åç§°">
                                </div>
                                <div class="grid grid-cols-2 gap-6">
                                    <div>
                                        <label class="form-label">å¼€å§‹æ—¶é—´</label>
                                        <input type="datetime-local" id="edit-start-time" class="tactical-input text-gray-400">
                                    </div>
                                    <div>
                                        <label class="form-label">ç»“æŸæ—¶é—´</label>
                                        <input type="datetime-local" id="edit-end-time" class="tactical-input text-gray-400">
                                    </div>
                                </div>
                                <div>
                                    <label class="form-label">æ¯”èµ›ç®€ä»‹ (Markdown)</label>
                                    <textarea id="edit-description" class="tactical-input h-32 resize-none p-3 text-sm leading-relaxed text-gray-300" placeholder="è¾“å…¥æ¯”èµ›ç®€ä»‹..."></textarea>
                                </div>
                            </div>
                        </div>

                        <div class="admin-card p-6">
                            <h3 class="text-sm font-bold text-white border-l-4 border-[#ff6b00] pl-3 mb-6">æµ·æŠ¥è®¾ç½®</h3>
                            <div class="grid grid-cols-12 gap-6">
                                <div class="col-span-8">
                                    <div class="upload-zone text-gray-500 h-32" id="upload-zone">
                                        <input type="file" id="cover-file" accept="image/*" class="hidden">
                                        <input type="text" id="edit-cover" class="hidden">
                                        <span class="text-2xl mb-2">ğŸ“·</span>
                                        <span class="text-xs">ç‚¹å‡»ä¸Šä¼ æµ·æŠ¥ (1920x600)</span>
                                    </div>
                                </div>
                                <div class="col-span-4 flex flex-col justify-center text-xs text-gray-500">
                                    <p class="mb-2">å½“å‰æµ·æŠ¥:</p>
                                    <div id="cover-preview" class="bg-[#111] h-20 w-full border border-[#333] flex items-center justify-center bg-cover bg-center">é¢„è§ˆå›¾</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- å³ä¾§ï¼šè§„åˆ™ä¸ä¿å­˜ -->
                    <div class="col-span-12 lg:col-span-4 flex flex-col gap-6">
                        <div class="admin-card p-6 h-full">
                            <h3 class="text-sm font-bold text-white border-l-4 border-[#ff6b00] pl-3 mb-6">è§„åˆ™ä¸æƒé™</h3>
                            <div class="space-y-6">
                                <div>
                                    <label class="form-label">é˜Ÿä¼äººæ•°é™åˆ¶</label>
                                    <div class="flex">
                                        <input type="number" id="edit-team-limit" value="4" class="tactical-input border-r-0 text-center rounded-l-sm">
                                        <div class="bg-[#222] border border-[#333] text-gray-400 text-xs px-4 flex items-center h-[42px] border-l-0">äºº</div>
                                    </div>
                                    <p class="text-[10px] text-gray-600 mt-1 ml-1">* 0 è¡¨ç¤ºä¸é™åˆ¶</p>
                                </div>

                                <div>
                                    <label class="form-label">é˜Ÿä¼å®¹å™¨é™åˆ¶</label>
                                    <div class="flex">
                                        <input type="number" id="edit-container-limit" value="2" class="tactical-input border-r-0 text-center rounded-l-sm">
                                        <div class="bg-[#222] border border-[#333] text-gray-400 text-xs px-4 flex items-center h-[42px] border-l-0">ä¸ª</div>
                                    </div>
                                    <p class="text-[10px] text-gray-600 mt-1 ml-1">* 0 è¡¨ç¤ºä¸é™åˆ¶</p>
                                </div>

                                <!-- AWD-F æ¨¡å¼ä¸“å±é…ç½® -->
                                <div id="awdf-config-section" class="hidden border-t border-[#333] pt-4">
                                    <div class="text-xs text-[#ff6b00] mb-3 flex items-center gap-2">
                                        <span>âš”ï¸</span>
                                        <span class="font-bold">AWD-F æ¨¡å¼é…ç½®</span>
                                    </div>
                                    <div class="space-y-4">
                                        <div>
                                            <label class="form-label">é˜²å®ˆé—´éš”ï¼ˆå…¨å±€å€’è®¡æ—¶ï¼‰</label>
                                            <div class="flex">
                                                <input type="number" id="edit-defense-interval" value="60" min="10" class="tactical-input border-r-0 text-center rounded-l-sm">
                                                <div class="bg-[#222] border border-[#333] text-gray-400 text-xs px-4 flex items-center h-[42px] border-l-0">ç§’</div>
                                            </div>
                                            <p class="text-[10px] text-gray-600 mt-1 ml-1">* æ¯è½®æ”»å‡»çš„æ—¶é—´é—´éš”ï¼Œæœ€å° 10 ç§’ï¼Œå»ºè®® 60~300 ç§’</p>
                                        </div>
                                        <div>
                                            <label class="form-label">å¹¶å‘åˆ¤é¢˜æ•°</label>
                                            <div class="flex">
                                                <input type="number" id="edit-judge-concurrency" value="5" min="1" max="50" class="tactical-input border-r-0 text-center rounded-l-sm">
                                                <div class="bg-[#222] border border-[#333] text-gray-400 text-xs px-4 flex items-center h-[42px] border-l-0">ä¸ª</div>
                                            </div>
                                            <p class="text-[10px] text-gray-600 mt-1 ml-1">* åŒæ—¶æ‰§è¡Œæ”»å‡»åˆ¤å®šçš„å®¹å™¨æ•°</p>
                                        </div>
                                        <div class="bg-[#111] p-3 border border-[#333] mt-2">
                                            <div class="text-xs text-gray-400 mb-2">è°ƒåº¦å™¨çŠ¶æ€</div>
                                            <div id="awdf-scheduler-status" class="text-xs font-mono text-gray-500">åŠ è½½ä¸­...</div>
                                            <div class="flex gap-2 mt-3">
                                                <button onclick="triggerNextRound()" class="btn-outline text-xs px-3 py-1 flex-1">â–¶ æ‰‹åŠ¨è§¦å‘ä¸‹ä¸€è½®</button>
                                                <button onclick="updateDefenseIntervalNow()" class="btn-outline text-xs px-3 py-1 flex-1">â†‘ ç«‹å³æ›´æ–°é—´éš”</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div>
                                    <label class="form-label">é‚€è¯·ç  (è®¿é—®æ§åˆ¶)</label>
                                    <div class="flex">
                                        <input id="edit-invite-code" type="text" placeholder="ç•™ç©ºåˆ™å…¬å¼€æŠ¥å" class="tactical-input border-r-0">
                                        <button onclick="generateCode()" class="bg-[#222] border border-[#333] text-gray-400 text-xs px-3 hover:text-white hover:bg-[#333] transition h-[42px] border-l-0">
                                            ğŸ²
                                        </button>
                                    </div>
                                </div>

                                <div>
                                    <label class="form-label">å‚ä¸ç»„ç»‡ <span class="text-gray-600">(å¯å¤šé€‰ï¼Œä¸é€‰åˆ™æ‰€æœ‰ç»„ç»‡å¯è§)</span></label>
                                    <div class="relative" id="org-select-container">
                                        <div id="org-select-trigger" onclick="toggleOrgDropdown()" class="bg-[#111] border border-[#333] px-3 py-2 cursor-pointer flex items-center justify-between hover:border-[#555] transition-colors h-[42px]">
                                            <span id="org-select-display" class="text-xs text-gray-400">è¯·é€‰æ‹©ç»„ç»‡...</span>
                                            <span class="text-gray-500">â–¼</span>
                                        </div>
                                        <div id="org-dropdown" class="hidden absolute top-full left-0 right-0 bg-[#1a1a1a] border border-[#444] mt-1 z-50 max-h-48 overflow-hidden shadow-lg">
                                            <div class="p-2 border-b border-[#333]">
                                                <input type="text" id="org-search" placeholder="æœç´¢ç»„ç»‡..." oninput="filterOrgOptions()" class="w-full bg-[#111] border border-[#333] text-xs text-white px-2 py-1.5 outline-none focus:border-[#ff6b00]">
                                            </div>
                                            <div id="org-options" class="overflow-y-auto max-h-32">
                                                <div class="text-gray-500 text-xs p-2">åŠ è½½ä¸­...</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div id="org-selected-tags" class="flex flex-wrap gap-1 mt-2"></div>
                                </div>

                                <div class="pt-8 mt-auto">
                                    <button onclick="saveConfig()" class="btn-primary w-full shadow-lg shadow-orange-900/20">ä¿å­˜é…ç½® // SAVE</button>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>

            <!-- TAB 2: æ¯”èµ›å…¬å‘Š -->
            <div id="tab-broadcast" class="tab-content hidden animate-fade-in w-full max-w-7xl overflow-y-auto flex-1">
                <div class="flex gap-6">
                    <!-- å·¦ä¾§ï¼šå…¬å‘Šåˆ—è¡¨ -->
                    <div class="flex-1 min-w-0">
                        <div class="admin-card overflow-hidden h-full flex flex-col">
                            <div class="bg-[#111] px-4 py-3 border-b border-[#333] flex justify-between items-center">
                                <h3 class="text-sm font-bold text-white">å…¬å‘Šåˆ—è¡¨</h3>
                                <span id="ann-count" class="text-xs text-gray-500 font-mono">å…± 0 æ¡å…¬å‘Š</span>
                            </div>
                            <div id="announcements-list" class="divide-y divide-[#222] flex-1 overflow-y-auto">
                                <div class="p-8 text-center text-gray-500 font-mono text-sm">åŠ è½½ä¸­...</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- å³ä¾§ï¼šå‘å¸ƒæ–°å…¬å‘Š + å¿«æ·å…¬å‘Š -->
                    <div class="w-[400px] shrink-0 space-y-6">
                        <!-- å‘å¸ƒæ–°å…¬å‘Š -->
                        <div class="admin-card p-6">
                            <h3 class="text-sm font-bold text-white border-l-4 border-[#ff6b00] pl-3 mb-4">å‘å¸ƒæ–°å…¬å‘Š</h3>
                            <div class="mb-4">
                                <label class="form-label">å…¬å‘Šæ ‡é¢˜</label>
                                <input type="text" id="ann-title" placeholder="è¾“å…¥å…¬å‘Šæ ‡é¢˜..." class="tactical-input mb-3">
                                <label class="form-label">å…¬å‘Šå†…å®¹</label>
                                <textarea id="ann-content" class="tactical-input h-32 resize-none" placeholder="è¾“å…¥å…¬å‘Šå†…å®¹..."></textarea>
                            </div>
                            <div class="flex justify-between items-center">
                                <label class="flex items-center gap-2 text-xs text-gray-400 cursor-pointer">
                                    <input type="checkbox" id="ann-pinned" class="w-4 h-4 accent-[#ff6b00]">
                                    <span>ğŸ“Œ ç½®é¡¶å…¬å‘Š</span>
                                </label>
                                <button onclick="publishAnnouncement()" class="btn-primary text-xs">ğŸ“¢ ç«‹å³å‘å¸ƒ</button>
                            </div>
                        </div>
                        
                        <!-- å¿«æ·å…¬å‘Š -->
                        <div class="admin-card p-4">
                            <h3 class="text-sm font-bold text-white border-l-4 border-[#ff6b00] pl-3 mb-3">å¿«æ·å…¬å‘Š</h3>
                            <div class="grid grid-cols-2 gap-2">
                                <button onclick="quickAnnounce('challenge_open')" class="text-xs px-3 py-2 bg-green-900 text-green-400 border border-green-700 hover:bg-green-800 transition-colors">âœ… é¢˜ç›®ä¸Šæ¶</button>
                                <button onclick="quickAnnounce('challenge_close')" class="text-xs px-3 py-2 bg-gray-800 text-gray-400 border border-gray-600 hover:bg-gray-700 transition-colors">âŒ é¢˜ç›®ä¸‹æ¶</button>
                                <button onclick="quickAnnounce('first_blood')" class="text-xs px-3 py-2 bg-yellow-900 text-yellow-400 border border-yellow-700 hover:bg-yellow-800 transition-colors">ğŸ¥‡ ä¸€è¡€å…¬å‘Š</button>
                                <button onclick="quickAnnounce('second_blood')" class="text-xs px-3 py-2 bg-gray-700 text-gray-300 border border-gray-500 hover:bg-gray-600 transition-colors">ğŸ¥ˆ äºŒè¡€å…¬å‘Š</button>
                                <button onclick="quickAnnounce('third_blood')" class="text-xs px-3 py-2 bg-orange-900 text-orange-400 border border-orange-700 hover:bg-orange-800 transition-colors">ğŸ¥‰ ä¸‰è¡€å…¬å‘Š</button>
                                <button onclick="quickAnnounce('hint')" class="text-xs px-3 py-2 bg-blue-900 text-blue-400 border border-blue-700 hover:bg-blue-800 transition-colors">ğŸ’¡ å‘å¸ƒæç¤º</button>
                                <button onclick="quickAnnounce('cheating')" class="text-xs px-3 py-2 bg-red-900 text-red-400 border border-red-700 hover:bg-red-800 transition-colors">âš ï¸ ä½œå¼Šå¤„ç½š</button>
                                <button onclick="quickAnnounce('ban')" class="text-xs px-3 py-2 bg-orange-900 text-orange-400 border border-orange-700 hover:bg-orange-800 transition-colors">ğŸš« å°ç¦å…¬å‘Š</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TAB 3: é¢˜ç›®ç¼–æ’ -->
            <div id="tab-challenges" class="tab-content hidden animate-fade-in w-full flex-1 flex flex-col min-h-0">
                <div class="flex justify-between mb-4 items-center flex-shrink-0">
                    <div class="flex gap-3">
                        <button onclick="showAddFromBankModal()" class="btn-primary text-xs shadow-lg">+ ä»é¢˜åº“æ·»åŠ é¢˜ç›®</button>
                        <button onclick="toggleBonusModal(true)" class="btn-outline text-xs bg-[#1a1a1a] text-[#ff6b00] border-[#333] hover:border-[#ff6b00]">â˜… é…ç½®ä¸‰è¡€å¥–åŠ±</button>
                        <button onclick="batchPublishChallenges()" class="btn-outline text-xs bg-[#1a1a1a] text-green-500 border-[#333] hover:border-green-500">â–¶ æ‰¹é‡æ”¾é¢˜</button>
                        <button onclick="batchHideChallenges()" class="btn-outline text-xs bg-[#1a1a1a] text-gray-400 border-[#333] hover:border-gray-400">â–  æ‰¹é‡éšè—</button>
                        <button onclick="batchRemoveChallenges()" class="btn-outline text-xs bg-[#1a1a1a] text-red-500 border-[#333] hover:border-red-500">âœ– æ‰¹é‡ç§»é™¤</button>
                        <button onclick="showBatchScoreModal()" class="btn-outline text-xs bg-[#1a1a1a] text-blue-400 border-[#333] hover:border-blue-400">âš™ æ‰¹é‡è°ƒåˆ†</button>
                        <button onclick="showBatchScheduleModal()" class="btn-outline text-xs bg-[#1a1a1a] text-purple-400 border-[#333] hover:border-purple-400">â° å®šæ—¶æ”¾é¢˜</button>
                        <button onclick="showBatchOrderModal()" class="btn-outline text-xs bg-[#1a1a1a] text-cyan-400 border-[#333] hover:border-cyan-400">â‡… è°ƒæ•´é¡ºåº</button>
                        <button onclick="showFlagFormatModal()" class="btn-outline text-xs bg-[#1a1a1a] text-yellow-400 border-[#333] hover:border-yellow-400">ğŸ Flagæ ¼å¼</button>
                    </div>
                    <div class="text-xs text-gray-500 font-mono bg-[#111] px-3 py-1 border border-[#333]">é¢˜ç›®æ•°: <span id="total-challenges" class="text-white">0</span></div>
                </div>
                
                <div class="admin-card overflow-hidden flex-1 flex flex-col min-h-0">
                    <div class="flex-1 overflow-y-auto">
                    <table class="w-full text-left text-xs font-mono">
                        <thead class="table-head bg-[#111] sticky top-0">
                            <tr>
                                <th class="p-4 w-10"><input type="checkbox" id="select-all-challenges" onchange="toggleSelectAllChallenges()"></th>
                                <th class="p-4 w-12">#</th>
                                <th class="p-4">é¢˜ç›®åç§°</th>
                                <th class="p-4">ç±»åˆ«</th>
                                <th class="p-4">åˆå§‹åˆ†æ•°</th>
                                <th class="p-4">æœ€ä½åˆ†æ•°</th>
                                <th class="p-4">çŠ¶æ€</th>
                                <th class="p-4 text-center">æç¤º</th>
                                <th class="p-4 text-right">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="challenges-tbody" class="divide-y divide-[#222]">
                            <tr><td colspan="9" class="p-8 text-center text-gray-500">åŠ è½½ä¸­...</td></tr>
                        </tbody>
                    </table>
                    </div>
                </div>
            </div>

            <!-- TAB 4: é˜Ÿä¼å®¡æ ¸ -->
            <div id="tab-audit" class="tab-content hidden animate-fade-in w-full flex-1 flex flex-col min-h-0">
                <!-- å®¡æ ¸æ“ä½œæ  -->
                <div class="flex items-center justify-between mb-4 flex-shrink-0">
                    <div class="flex items-center gap-4">
                        <select id="audit-status-filter" class="tactical-input w-32" onchange="loadContestTeams()">
                            <option value="">å…¨éƒ¨çŠ¶æ€</option>
                            <option value="pending">å¾…å®¡æ ¸</option>
                            <option value="approved">å·²é€šè¿‡</option>
                            <option value="rejected">å·²æ‹’ç»</option>
                            <option value="banned">å·²å°ç¦</option>
                            <option value="cheating_banned">ä½œå¼Šå°ç¦</option>
                        </select>
                        <span id="audit-count" class="text-xs text-gray-500">å…± 0 æ”¯é˜Ÿä¼</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <button onclick="allocatePorts()" class="bg-cyan-600 hover:bg-cyan-700 text-white text-xs px-3 py-1 transition-colors">é¢„åˆ†é…ç«¯å£</button>
                        <button onclick="batchApprove()" class="btn-primary text-xs px-3 py-1">æ‰¹é‡é€šè¿‡</button>
                        <button onclick="batchReject()" class="btn-outline text-xs px-3 py-1">æ‰¹é‡æ‹’ç»</button>
                        <button onclick="batchBan()" class="bg-orange-600 hover:bg-orange-700 text-white text-xs px-3 py-1 transition-colors">æ‰¹é‡å°ç¦</button>
                        <button onclick="batchCheatBan()" class="bg-red-700 hover:bg-red-800 text-white text-xs px-3 py-1 transition-colors">æ‰¹é‡ä½œå¼Š</button>
                    </div>
                </div>
                <!-- é˜Ÿä¼åˆ—è¡¨ -->
                <div class="border border-[#333] overflow-hidden flex-1 flex flex-col min-h-0">
                    <div class="flex-1 overflow-y-auto">
                    <table class="w-full text-left text-xs font-mono">
                        <thead class="bg-[#111] sticky top-0">
                            <tr>
                                <th class="p-3 w-10"><input type="checkbox" id="select-all-teams" onchange="toggleSelectAllTeams()"></th>
                                <th class="p-3">ID</th>
                                <th class="p-3">é˜Ÿä¼åç§°</th>
                                <th class="p-3">æ‰€å±ç»„ç»‡</th>
                                <th class="p-3">é¢„åˆ†é…ç«¯å£</th>
                                <th class="p-3">çŠ¶æ€</th>
                                <th class="p-3">ç”³è¯·æ—¶é—´</th>
                                <th class="p-3">å®¡æ ¸æ—¶é—´</th>
                                <th class="p-3 text-right">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="audit-teams-tbody" class="divide-y divide-[#222]">
                            <tr><td colspan="9" class="p-8 text-center text-gray-500">åŠ è½½ä¸­...</td></tr>
                        </tbody>
                    </table>
                    </div>
                </div>
            </div>

            <!-- åº•éƒ¨ç‰ˆæƒ -->
            <footer class="py-1 border-t border-[#333] flex items-center justify-center flex-shrink-0">
                <div class="flex items-center justify-center gap-4 text-xs flex-wrap">
                    <div class="flex items-center gap-1">
                        <div class="bg-[#ff6b00] text-black font-black px-1.5 py-0.5 font-eng tracking-tighter">TG</div>
                        <span class="text-gray-500">å¤©æ ¼åå°ç®¡ç†ç³»ç»Ÿ</span>
                    </div>
                    <span class="text-white font-mono">Copyright Â© 2021-present tan91. All Rights Reserved.</span>
                    <a href="https://github.com/NUDTTAN91" target="_blank" class="text-[#ff6b00] hover:text-white transition-colors"><svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor"><path d="M12 0C5.37 0 0 5.37 0 12c0 5.31 3.435 9.795 8.205 11.385.6.105.825-.255.825-.57 0-.285-.015-1.23-.015-2.235-3.015.555-3.795-.735-4.035-1.41-.135-.345-.72-1.41-1.23-1.695-.42-.225-1.02-.78-.015-.795.945-.015 1.62.87 1.845 1.23 1.08 1.815 2.805 1.305 3.495.99.105-.78.42-1.305.765-1.605-2.67-.3-5.46-1.335-5.46-5.925 0-1.305.465-2.385 1.23-3.225-.12-.3-.54-1.53.12-3.18 0 0 1.005-.315 3.3 1.23.96-.27 1.98-.405 3-.405s2.04.135 3 .405c2.295-1.56 3.3-1.23 3.3-1.23.66 1.65.24 2.88.12 3.18.765.84 1.23 1.905 1.23 3.225 0 4.605-2.805 5.625-5.475 5.925.435.375.81 1.095.81 2.22 0 1.605-.015 2.895-.015 3.3 0 .315.225.69.825.57A12.02 12.02 0 0024 12c0-6.63-5.37-12-12-12z"/></svg></a>
                </div>
            </footer>

        </main>
    </div>

    <!-- ä»é¢˜åº“æ·»åŠ é¢˜ç›®å¼¹çª— -->
    <div id="add-from-bank-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-80 backdrop-blur-sm hidden transition-opacity duration-200">
        <div class="bg-[#1e1e1e] border border-[#ff6b00] w-full max-w-6xl shadow-2xl relative p-6 max-h-[90vh] overflow-y-auto">
            <h3 class="text-lg font-bold text-white font-eng mb-4">ä»é¢˜åº“æ·»åŠ é¢˜ç›®</h3>
            
            <!-- ç­›é€‰ -->
            <div class="flex gap-4 mb-4 flex-wrap">
                <input type="text" id="bank-search" class="tactical-input w-64" placeholder="ğŸ” æœç´¢é¢˜ç›®åç§°..." oninput="filterQuestionBank()">
                <select id="bank-filter-category" class="tactical-input w-32" onchange="filterQuestionBank()">
                    <option value="">æ‰€æœ‰ç±»åˆ«</option>
                </select>
                <select id="bank-filter-difficulty" class="tactical-input w-32" onchange="filterQuestionBank()">
                    <option value="">æ‰€æœ‰éš¾åº¦</option>
                    <option value="easy">ç®€å•</option>
                    <option value="medium">ä¸­ç­‰</option>
                    <option value="hard">å›°éš¾</option>
                </select>
            </div>
            
            <!-- é¢˜åº“åˆ—è¡¨ -->
            <div class="border border-[#333] max-h-96 overflow-y-auto mb-4">
                <table class="w-full text-left text-xs font-mono">
                    <thead class="bg-[#111] sticky top-0">
                        <tr>
                            <th class="p-3 w-10"><input type="checkbox" id="select-all-bank" class="accent-[#ff6b00]" onchange="toggleSelectAll(this.checked)"></th>
                            <th class="p-3">é¢˜ç›®åç§°</th>
                            <th class="p-3">ç±»åˆ«</th>
                            <th class="p-3">éš¾åº¦</th>
                            <th class="p-3">ç±»å‹</th>
                        </tr>
                    </thead>
                    <tbody id="question-bank-list" class="divide-y divide-[#222]">
                        <tr><td colspan="5" class="p-4 text-center text-gray-500">åŠ è½½ä¸­...</td></tr>
                    </tbody>
                </table>
            </div>
            
            <!-- åˆ†æ•°è®¾ç½® -->
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="form-label">åˆå§‹åˆ†æ•°</label>
                    <input type="number" id="bank-initial-score" class="tactical-input" value="500" min="0">
                    <p class="text-[10px] text-gray-600 mt-1">é¢˜ç›®åˆå§‹åˆ†å€¼</p>
                </div>
                <div>
                    <label class="form-label">æœ€ä½åˆ†æ•°</label>
                    <input type="number" id="bank-min-score" class="tactical-input" value="17" min="0">
                    <p class="text-[10px] text-gray-600 mt-1">åŠ¨æ€è®¡åˆ†çš„æœ€ä½åˆ†å€¼</p>
                </div>
            </div>
            
            <div class="flex justify-between items-center mt-6">
                <span id="selected-count" class="text-xs text-gray-500">å·²é€‰æ‹©: 0 é“é¢˜ç›®</span>
                <div class="flex gap-3">
                    <button onclick="hideAddFromBankModal()" class="btn-outline">å–æ¶ˆ</button>
                    <button onclick="addSelectedQuestions()" class="btn-primary">æ·»åŠ åˆ°æ¯”èµ›</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ç¼–è¾‘æ¯”èµ›é¢˜ç›®å¼¹çª— -->
    <div id="edit-challenge-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-80 backdrop-blur-sm hidden transition-opacity duration-200">
        <div class="bg-[#1e1e1e] border border-[#ff6b00] w-full max-w-2xl shadow-2xl relative p-6 max-h-[90vh] overflow-y-auto">
            <h3 class="text-lg font-bold text-white font-eng mb-4">ç¼–è¾‘é¢˜ç›®é…ç½®</h3>
            <input type="hidden" id="edit-cc-id">
            <div class="space-y-4">
                <div>
                    <label class="form-label">é¢˜ç›®åç§°</label>
                    <input type="text" id="edit-cc-title" class="tactical-input" disabled>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="form-label">åˆå§‹åˆ†æ•°</label>
                        <input type="number" id="edit-cc-initial" class="tactical-input" value="500" min="0">
                    </div>
                    <div>
                        <label class="form-label">æœ€ä½åˆ†æ•°</label>
                        <input type="number" id="edit-cc-min" class="tactical-input" value="17" min="0">
                    </div>
                </div>
                <div>
                    <label class="form-label">çŠ¶æ€</label>
                    <select id="edit-cc-status" class="tactical-input">
                        <option value="hidden">éšè—</option>
                        <option value="public">å…¬å¼€</option>
                    </select>
                </div>
                <!-- å®šæ—¶æ”¾é¢˜ -->
                <div class="border border-[#333] p-4 bg-[#161616]">
                    <div class="flex justify-between items-center mb-2">
                        <label class="form-label mb-0">â° å®šæ—¶æ”¾é¢˜</label>
                        <span id="release-time-status" class="text-xs text-gray-500">æœªè®¾ç½®</span>
                    </div>
                    <input type="datetime-local" id="edit-cc-release-time" class="tactical-input w-full cursor-pointer" onclick="this.showPicker()">
                    <div class="flex justify-between items-center mt-2">
                        <p class="text-[10px] text-gray-600">è®¾ç½®åï¼Œé¢˜ç›®å°†åœ¨æŒ‡å®šæ—¶é—´è‡ªåŠ¨ä¸Šæ¶</p>
                        <button type="button" onclick="clearReleaseTime()" class="text-[10px] text-red-500 hover:text-red-400">æ¸…é™¤å®šæ—¶</button>
                    </div>
                </div>
                <!-- å¤šæç¤ºç®¡ç† -->
                <div class="border border-[#333] p-4 bg-[#161616]">
                    <div class="flex justify-between items-center mb-3">
                        <label class="form-label mb-0">ğŸ’¡ é¢˜ç›®æç¤ºç®¡ç†</label>
                        <span id="hints-count" class="text-xs text-gray-500">0 æ¡æç¤º</span>
                    </div>
                    <!-- æç¤ºåˆ—è¡¨ -->
                    <div id="hints-list-container" class="space-y-2 mb-3 max-h-48 overflow-y-auto">
                        <div class="text-xs text-gray-500 text-center py-2">åŠ è½½ä¸­...</div>
                    </div>
                    <!-- æ·»åŠ æ–°æç¤º -->
                    <div class="flex gap-2">
                        <input type="text" id="new-hint-content" class="tactical-input flex-1" placeholder="è¾“å…¥æ–°æç¤ºå†…å®¹...">
                        <button onclick="addNewHint()" class="btn-primary text-xs px-4">+ æ·»åŠ </button>
                    </div>
                    <p class="text-[10px] text-gray-600 mt-2">æç¤ºæ·»åŠ åéœ€å•ç‹¬å‘å¸ƒï¼Œå‘å¸ƒåä¼šè‡ªåŠ¨ç”Ÿæˆå…¬å‘Šå¹¶åœ¨ç”¨æˆ·ç«¯æ˜¾ç¤º</p>
                </div>
            </div>
            <div class="flex justify-end gap-3 mt-6">
                <button onclick="hideEditChallengeModal()" class="btn-outline">å–æ¶ˆ</button>
                <button onclick="saveContestChallenge()" class="btn-primary">ä¿å­˜åˆ†æ•°é…ç½®</button>
            </div>
        </div>
    </div>

    <!-- ä¸‰è¡€å¥–åŠ±é…ç½®å¼¹çª— -->
    <div id="bonus-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-80 backdrop-blur-sm hidden transition-opacity duration-200">
        <div class="bg-[#1e1e1e] border border-[#ff6b00] w-full max-w-md shadow-2xl relative p-6">
            <h3 class="text-lg font-bold text-white font-eng mb-4">â˜… é…ç½®ä¸‰è¡€å¥–åŠ±</h3>
            
            <div class="text-xs text-gray-500 mb-6 font-mono bg-[#111] p-3 border border-[#333]">
                ä¸‰è¡€å¥–åŠ±æ˜¯æŒ‡å‰ä¸‰ä¸ªè§£å‡ºé¢˜ç›®çš„é˜Ÿä¼è·å¾—çš„é¢å¤–åˆ†æ•°åŠ æˆã€‚<br>
                ä¾‹å¦‚ï¼šä¸€è¡€ 5% è¡¨ç¤ºé¢å¤–åŠ  5% çš„é¢˜ç›®åˆ†æ•°ã€‚
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="form-label">ğŸ¥‡ ä¸€è¡€å¥–åŠ± (%)</label>
                    <div class="flex">
                        <input type="number" id="bonus-first" class="tactical-input border-r-0 text-center" value="5" min="0" max="100">
                        <div class="bg-[#222] border border-[#333] text-gray-400 text-xs px-4 flex items-center h-[42px] border-l-0">%</div>
                    </div>
                    <p class="text-[10px] text-yellow-500 mt-1 ml-1">ç¬¬ä¸€ä¸ªè§£å‡ºé¢˜ç›®çš„é˜Ÿä¼</p>
                </div>
                <div>
                    <label class="form-label">ğŸ¥ˆ äºŒè¡€å¥–åŠ± (%)</label>
                    <div class="flex">
                        <input type="number" id="bonus-second" class="tactical-input border-r-0 text-center" value="3" min="0" max="100">
                        <div class="bg-[#222] border border-[#333] text-gray-400 text-xs px-4 flex items-center h-[42px] border-l-0">%</div>
                    </div>
                    <p class="text-[10px] text-gray-400 mt-1 ml-1">ç¬¬äºŒä¸ªè§£å‡ºé¢˜ç›®çš„é˜Ÿä¼</p>
                </div>
                <div>
                    <label class="form-label">ğŸ¥‰ ä¸‰è¡€å¥–åŠ± (%)</label>
                    <div class="flex">
                        <input type="number" id="bonus-third" class="tactical-input border-r-0 text-center" value="1" min="0" max="100">
                        <div class="bg-[#222] border border-[#333] text-gray-400 text-xs px-4 flex items-center h-[42px] border-l-0">%</div>
                    </div>
                    <p class="text-[10px] text-orange-700 mt-1 ml-1">ç¬¬ä¸‰ä¸ªè§£å‡ºé¢˜ç›®çš„é˜Ÿä¼</p>
                </div>
            </div>
            
            <div class="flex justify-end gap-3 mt-6">
                <button onclick="toggleBonusModal(false)" class="btn-outline">å–æ¶ˆ</button>
                <button onclick="saveBonusConfig()" class="btn-primary">ä¿å­˜é…ç½®</button>
            </div>
        </div>
    </div>

    <!-- æ‰¹é‡è°ƒåˆ†å¼¹çª— -->
    <div id="batch-score-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-80 backdrop-blur-sm hidden transition-opacity duration-200">
        <div class="bg-[#1e1e1e] border border-[#ff6b00] w-full max-w-md shadow-2xl relative p-6">
            <h3 class="text-lg font-bold text-white font-eng mb-4">âš™ æ‰¹é‡è°ƒæ•´åˆ†æ•°</h3>
            
            <div class="text-xs text-gray-500 mb-6 font-mono bg-[#111] p-3 border border-[#333]">
                æ‰¹é‡è®¾ç½®å·²é€‰ä¸­é¢˜ç›®çš„åˆå§‹åˆ†æ•°å’Œæœ€ä½åˆ†æ•°ã€‚<br>
                ç•™ç©ºè¡¨ç¤ºä¸ä¿®æ”¹è¯¥é¡¹ã€‚
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="form-label">å·²é€‰é¢˜ç›®</label>
                    <div id="batch-score-selected" class="text-xs text-[#ff6b00] bg-[#111] p-2 border border-[#333]">0 é“é¢˜ç›®</div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="form-label">åˆå§‹åˆ†æ•°</label>
                        <input type="number" id="batch-initial-score" class="tactical-input" placeholder="ç•™ç©ºä¸ä¿®æ”¹" min="0">
                        <p class="text-[10px] text-gray-600 mt-1">é¢˜ç›®åˆå§‹åˆ†å€¼</p>
                    </div>
                    <div>
                        <label class="form-label">æœ€ä½åˆ†æ•°</label>
                        <input type="number" id="batch-min-score" class="tactical-input" placeholder="ç•™ç©ºä¸ä¿®æ”¹" min="0">
                        <p class="text-[10px] text-gray-600 mt-1">åŠ¨æ€è®¡åˆ†æœ€ä½åˆ†</p>
                    </div>
                </div>
                <div>
                    <label class="form-label">éš¾åº¦ç³»æ•° (1-10)</label>
                    <input type="number" id="batch-difficulty" class="tactical-input" placeholder="ç•™ç©ºä¸ä¿®æ”¹" min="1" max="10">
                    <p class="text-[10px] text-gray-600 mt-1">å½±å“åˆ†æ•°è¡°å‡é€Ÿåº¦ï¼Œå€¼è¶Šå¤§è¡°å‡è¶Šæ…¢</p>
                </div>
            </div>
            
            <div class="flex justify-end gap-3 mt-6">
                <button onclick="hideBatchScoreModal()" class="btn-outline">å–æ¶ˆ</button>
                <button onclick="batchUpdateScores()" class="btn-primary">åº”ç”¨ä¿®æ”¹</button>
            </div>
        </div>
    </div>

    <!-- æ‰¹é‡å®šæ—¶æ”¾é¢˜å¼¹çª— -->
    <div id="batch-schedule-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-80 backdrop-blur-sm hidden transition-opacity duration-200">
        <div class="bg-[#1e1e1e] border border-[#ff6b00] w-full max-w-md shadow-2xl relative p-6">
            <h3 class="text-lg font-bold text-white font-eng mb-4">â° æ‰¹é‡å®šæ—¶æ”¾é¢˜</h3>
            
            <div class="text-xs text-gray-500 mb-6 font-mono bg-[#111] p-3 border border-[#333]">
                ä¸ºå·²é€‰ä¸­çš„é¢˜ç›®è®¾ç½®ç»Ÿä¸€çš„å®šæ—¶æ”¾é¢˜æ—¶é—´ã€‚<br>
                é¢˜ç›®å°†åœ¨æŒ‡å®šæ—¶é—´è‡ªåŠ¨ä¸Šæ¶ã€‚
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="form-label">å·²é€‰é¢˜ç›®</label>
                    <div id="batch-schedule-selected" class="text-xs text-[#ff6b00] bg-[#111] p-2 border border-[#333]">0 é“é¢˜ç›®</div>
                </div>
                <div>
                    <label class="form-label">æ”¾é¢˜æ—¶é—´</label>
                    <input type="datetime-local" id="batch-release-time" class="tactical-input w-full cursor-pointer" onclick="this.showPicker()">
                    <p class="text-[10px] text-gray-600 mt-1">é€‰æ‹©é¢˜ç›®è‡ªåŠ¨ä¸Šæ¶çš„æ—¶é—´</p>
                </div>
            </div>
            
            <div class="flex justify-end gap-3 mt-6">
                <button onclick="hideBatchScheduleModal()" class="btn-outline">å–æ¶ˆ</button>
                <button onclick="clearBatchSchedule()" class="btn-outline text-red-500 border-red-500 hover:border-red-400">æ¸…é™¤å®šæ—¶</button>
                <button onclick="batchSetSchedule()" class="btn-primary">è®¾ç½®å®šæ—¶</button>
            </div>
        </div>
    </div>

    <!-- Flagæ ¼å¼è®¾ç½®å¼¹çª— -->
    <div id="flag-format-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-80 backdrop-blur-sm hidden transition-opacity duration-200">
        <div class="bg-[#1e1e1e] border border-[#ff6b00] w-full max-w-3xl shadow-2xl relative p-6">
            <h3 class="text-lg font-bold text-white font-eng mb-4">ğŸ è®¾ç½®Flagæ ¼å¼</h3>
            
            <div class="text-xs text-gray-500 mb-4 font-mono bg-[#111] p-3 border border-[#333]">
                Flagæ ¼å¼ä½¿ç”¨ <code class="text-[#ff6b00]">[GUID]</code> ä½œä¸ºå ä½ç¬¦ï¼Œç”Ÿæˆæ—¶ä¼šæ›¿æ¢ä¸ºUUIDã€‚<br>
                ä¾‹å¦‚ï¼š<code class="text-yellow-400">TGCTF{[GUID]}</code> â†’ <code class="text-green-400">TGCTF{a1b2c3d4-5678-4abc-8def-123456789abc}</code>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="form-label">Flagæ ¼å¼</label>
                    <input type="text" id="flag-format-input" class="tactical-input w-full" placeholder="flag{[GUID]}" value="flag{[GUID]}" oninput="updateFlagPreview()">
                    <p class="text-[10px] text-gray-600 mt-1">ä½¿ç”¨ [GUID] ä½œä¸ºUUIDå ä½ç¬¦</p>
                </div>
                <div>
                    <label class="form-label">é¢„è§ˆ</label>
                    <div id="flag-format-preview" class="text-sm text-green-400 bg-[#111] p-2 border border-[#333] font-mono break-all">flag{a1b2c3d4-5678-4abc-8def-123456789abc}</div>
                </div>
                <div class="bg-red-900/20 border border-red-500/50 p-3">
                    <p class="text-xs text-red-400"><strong>âš  è­¦å‘Šï¼š</strong>ä¿®æ”¹Flagæ ¼å¼åï¼Œæ‰€æœ‰å·²ç”Ÿæˆçš„Flagå°†è¢«åˆ é™¤ï¼Œé‡å¯å®¹å™¨æ—¶ä¼šè‡ªåŠ¨é‡æ–°ç”Ÿæˆã€‚</p>
                </div>
            </div>
            
            <div class="flex justify-end gap-3 mt-6">
                <button onclick="hideFlagFormatModal()" class="btn-outline">å–æ¶ˆ</button>
                <button onclick="saveFlagFormat()" class="btn-primary">ä¿å­˜æ ¼å¼</button>
            </div>
        </div>
    </div>

    <!-- æ‹–æ‹½è°ƒæ•´é¡ºåºå¼¹çª— -->
    <div id="batch-order-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-80 backdrop-blur-sm hidden transition-opacity duration-200">
        <div class="bg-[#1e1e1e] border border-[#ff6b00] w-full max-w-4xl shadow-2xl relative p-6 max-h-[90vh] overflow-y-auto">
            <h3 class="text-lg font-bold text-white font-eng mb-4">â‡… è°ƒæ•´é¢˜ç›®æ˜¾ç¤ºé¡ºåº</h3>
            
            <div class="text-xs text-gray-500 mb-4 font-mono bg-[#111] p-3 border border-[#333]">
                æ‹–æ‹½é¢˜ç›®è°ƒæ•´é¡ºåºï¼Œä¸Šä¸‹æ‹–åŠ¨å³å¯æ’åºã€‚ä¿å­˜åç”¨æˆ·çœ‹åˆ°çš„é¢˜ç›®å°†æŒ‰æ­¤é¡ºåºæ’åˆ—ã€‚
            </div>
            
            <div id="order-list-container" class="border border-[#333] max-h-[60vh] overflow-y-auto mb-4">
                <div class="p-4 text-center text-gray-500">åŠ è½½ä¸­...</div>
            </div>
            
            <div class="flex gap-2 mb-4">
                <button onclick="resetOrderToDefault()" class="btn-outline text-xs text-gray-400 border-gray-600">è¿˜åŸé»˜è®¤é¡ºåº</button>
            </div>
            
            <div class="flex justify-end gap-3">
                <button onclick="hideBatchOrderModal()" class="btn-outline">å–æ¶ˆ</button>
                <button onclick="saveBatchOrder()" class="btn-primary">ä¿å­˜é¡ºåº</button>
            </div>
        </div>
    </div>

    <!-- æŸ¥çœ‹é˜Ÿä¼Flagå¼¹çª— -->
    <div id="view-flags-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-80 backdrop-blur-sm hidden transition-opacity duration-200">
        <div class="bg-[#1e1e1e] border border-[#ff6b00] w-full max-w-2xl shadow-2xl relative p-6 max-h-[90vh] overflow-y-auto">
            <h3 class="text-lg font-bold text-white font-eng mb-4">é˜Ÿä¼Flagåˆ—è¡¨ - <span id="flags-challenge-title" class="text-[#ff6b00]"></span></h3>
            
            <div class="text-xs text-gray-500 mb-4 font-mono">åŠ¨æ€å®¹å™¨é¢˜ç›®ä¼šä¸ºæ¯ä¸ªé˜Ÿä¼ç”Ÿæˆå”¯ä¸€Flagï¼Œåœ¨é˜Ÿä¼é¦–æ¬¡åˆ›å»ºå®¹å™¨æ—¶ç”Ÿæˆ</div>
            
            <!-- Flagåˆ—è¡¨ -->
            <div class="border border-[#333] max-h-96 overflow-y-auto">
                <table class="w-full text-left text-xs font-mono">
                    <thead class="bg-[#111] sticky top-0">
                        <tr>
                            <th class="p-3">é˜Ÿä¼åç§°</th>
                            <th class="p-3">Flag</th>
                            <th class="p-3">ç”Ÿæˆæ—¶é—´</th>
                        </tr>
                    </thead>
                    <tbody id="flags-list-tbody" class="divide-y divide-[#222]">
                        <tr><td colspan="3" class="p-4 text-center text-gray-500">åŠ è½½ä¸­...</td></tr>
                    </tbody>
                </table>
            </div>
            
            <div class="flex justify-between items-center mt-6">
                <span id="flags-count" class="text-xs text-gray-500">å…± 0 æ¡è®°å½•</span>
                <button onclick="hideFlagsModal()" class="btn-outline">å…³é—­</button>
            </div>
        </div>
    </div>

    <script>
        // Toast æç¤ºå‡½æ•°
        function showToast(message, type = 'info', duration = 3000) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            container.appendChild(toast);
            setTimeout(() => {
                toast.style.animation = 'toastOut 0.3s ease forwards';
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }

        const token = localStorage.getItem('tg_token');
        let contestId = null;
        let contestData = null;
        let allOrganizations = [];
        let selectedOrgIds = [];
        // é¢„å…ˆå£°æ˜æ‰€æœ‰æ¨¡å—å˜é‡ï¼ˆé¿å…æš‚æ—¶æ€§æ­»åŒºé—®é¢˜ï¼‰
        let challenges = [];
        let questionBank = [];
        let selectedQuestions = new Set();
        let categories = [];
        let selectedChallenges = new Set();
        let contestTeams = [];
        let selectedTeamIds = new Set();
        let auditWs = null;
        let announcements = [];

        function parseJwt(token) {
            try {
                const base64Url = token.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const jsonPayload = decodeURIComponent(atob(base64).split('').map(c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join(''));
                return JSON.parse(jsonPayload);
            } catch (e) { return null; }
        }

        // æƒé™æ£€æŸ¥
        if (!token) {
            window.location.href = '/login.html';
        } else {
            const payload = parseJwt(token);
            if (!payload || payload.role !== 'super') {
                showToast('æƒé™ä¸è¶³ï¼šä»…è¶…çº§ç®¡ç†å‘˜å¯è®¿é—®æ­¤é¡µé¢', 'error');
                window.location.href = '/home.html';
            }
        }

        // è·å– URL å‚æ•°ä¸­çš„æ¯”èµ› ID
        const urlParams = new URLSearchParams(window.location.search);
        contestId = urlParams.get('id');
        if (!contestId) {
            showToast('æœªæŒ‡å®šæ¯”èµ›ID', 'error');
            window.location.href = '/admin/admin-contests.html';
        }

        // Tab åˆ‡æ¢
        function switchToTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
            const tabBtn = document.querySelector(`.tab-btn[data-tab="${tabName}"]`);
            const tabContent = document.getElementById('tab-' + tabName);
            if (tabBtn && tabContent) {
                tabBtn.classList.add('active');
                tabContent.classList.remove('hidden');
            }
        }
        
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const tabName = btn.dataset.tab;
                switchToTab(tabName);
                // ä¿å­˜å½“å‰Tabåˆ°URLå‚æ•°
                const url = new URL(window.location);
                url.searchParams.set('tab', tabName);
                window.history.replaceState({}, '', url);
            });
        });
        
        // ä»URLå‚æ•°æ¢å¤TabçŠ¶æ€
        const savedTab = urlParams.get('tab');
        if (savedTab && ['config', 'broadcast', 'challenges', 'audit'].includes(savedTab)) {
            switchToTab(savedTab);
        }

        // æ›´æ–°æµ·æŠ¥é¢„è§ˆ
        function updateCoverPreview(url) {
            const preview = document.getElementById('cover-preview');
            if (url) {
                preview.style.backgroundImage = `url('${url}')`;
                preview.textContent = '';
            } else {
                preview.style.backgroundImage = '';
                preview.textContent = 'é¢„è§ˆå›¾';
            }
        }

        // åŠ è½½æ¯”èµ›æ•°æ®
        async function loadContest() {
            try {
                const res = await fetch(`/api/admin/contests/${contestId}`, {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                if (!res.ok) throw new Error('Failed to load');
                contestData = await res.json();
                
                // å¡«å……æ•°æ®
                document.getElementById('contest-title').textContent = contestData.name;
                document.getElementById('contest-id').textContent = contestData.id;
                document.getElementById('contest-mode').textContent = contestData.mode.toUpperCase();
                
                document.getElementById('edit-name').value = contestData.name;
                document.getElementById('edit-description').value = contestData.description || '';
                document.getElementById('edit-start-time').value = contestData.startTime.replace(' ', 'T');
                document.getElementById('edit-end-time').value = contestData.endTime.replace(' ', 'T');
                document.getElementById('edit-cover').value = contestData.coverImage || '';
                
                // é¢„è§ˆèƒŒæ™¯å›¾
                updateCoverPreview(contestData.coverImage || '');
                
                // é˜Ÿä¼é™åˆ¶
                document.getElementById('edit-team-limit').value = contestData.teamLimit || 4;
                document.getElementById('edit-container-limit').value = contestData.containerLimit || 1;
                
                // AWD-F æ¨¡å¼é…ç½®
                if (contestData.mode === 'awd-f') {
                    document.getElementById('awdf-config-section').classList.remove('hidden');
                    document.getElementById('edit-defense-interval').value = contestData.defenseInterval || 60;
                    document.getElementById('edit-judge-concurrency').value = contestData.judgeConcurrency || 5;
                    // åŠ è½½è°ƒåº¦å™¨çŠ¶æ€
                    loadSchedulerStatus();
                } else {
                    document.getElementById('awdf-config-section').classList.add('hidden');
                }
                
                // çŠ¶æ€æ˜¾ç¤º
                updateStatusDisplay(contestData.status);
                
                // åŠ è½½æ¯”èµ›å·²å…³è”çš„ç»„ç»‡
                try {
                    const orgRes = await fetch(`/api/admin/contests/${contestId}/organizations`, {
                        headers: { 'Authorization': 'Bearer ' + token }
                    });
                    if (orgRes.ok) {
                        const orgs = await orgRes.json();
                        selectedOrgIds = orgs.map(o => o.id);
                        renderOrgOptions();
                        updateOrgDisplay();
                    }
                } catch (orgErr) {
                    console.error('åŠ è½½ç»„ç»‡å¤±è´¥', orgErr);
                }
                
            } catch (e) {
                console.error(e);
                showToast('åŠ è½½æ¯”èµ›ä¿¡æ¯å¤±è´¥', 'error');
            }
        }

        function updateStatusDisplay(status) {
            const statusEl = document.getElementById('status-display');
            const toggleBtn = document.getElementById('toggle-status-btn');
            
            const statusConfig = {
                running: { 
                    text: 'â— çŠ¶æ€: è¿›è¡Œä¸­', 
                    class: 'text-xs font-mono text-green-500 bg-green-900 bg-opacity-20 px-2 py-1 border border-green-800', 
                    btnText: 'ç´§æ€¥æš‚åœ', 
                    btnAction: 'paused' 
                },
                pending: { 
                    text: 'â—‹ çŠ¶æ€: ç­¹å¤‡ä¸­', 
                    class: 'text-xs font-mono text-yellow-500 bg-yellow-900 bg-opacity-20 px-2 py-1 border border-yellow-800', 
                    btnText: 'ç«‹å³å¼€å§‹', 
                    btnAction: 'running' 
                },
                paused: { 
                    text: 'â–  çŠ¶æ€: å·²æš‚åœ', 
                    class: 'text-xs font-mono text-orange-500 bg-orange-900 bg-opacity-20 px-2 py-1 border border-orange-800', 
                    btnText: 'æ¢å¤æ¯”èµ›', 
                    btnAction: 'running' 
                },
                ended: { 
                    text: 'â— çŠ¶æ€: å·²ç»“æŸ', 
                    class: 'text-xs font-mono text-gray-500 bg-gray-900 bg-opacity-20 px-2 py-1 border border-gray-700', 
                    btnText: '--', 
                    btnAction: null 
                }
            };
            
            const cfg = statusConfig[status] || statusConfig.pending;
            statusEl.textContent = cfg.text;
            statusEl.className = cfg.class;
            toggleBtn.textContent = cfg.btnText;
            toggleBtn.dataset.action = cfg.btnAction || '';
            toggleBtn.disabled = !cfg.btnAction;
            toggleBtn.style.opacity = cfg.btnAction ? '1' : '0.5';
        }

        // åˆ‡æ¢çŠ¶æ€æŒ‰é’®
        document.getElementById('toggle-status-btn').addEventListener('click', async () => {
            const newStatus = document.getElementById('toggle-status-btn').dataset.action;
            if (!newStatus) return;
            
            try {
                const res = await fetch(`/api/admin/contests/${contestId}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': 'Bearer ' + token,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ status: newStatus })
                });
                if (!res.ok) throw new Error('Failed');
                contestData.status = newStatus;
                updateStatusDisplay(newStatus);
            } catch (e) {
                showToast('çŠ¶æ€åˆ‡æ¢å¤±è´¥', 'error');
            }
        });

        // ä¿å­˜é…ç½®
        async function saveConfig() {
            const name = document.getElementById('edit-name').value.trim();
            const description = document.getElementById('edit-description').value.trim();
            const startTime = document.getElementById('edit-start-time').value;
            const endTime = document.getElementById('edit-end-time').value;
            const coverImage = document.getElementById('edit-cover').value.trim();
            const teamLimit = parseInt(document.getElementById('edit-team-limit').value) || 4;
            const containerLimit = parseInt(document.getElementById('edit-container-limit').value) || 1;

            if (!name || !startTime || !endTime) {
                showToast('è¯·å¡«å†™å¿…å¡«å­—æ®µ', 'warning');
                return;
            }

            // AWD-F é…ç½®
            let awdfConfig = {};
            if (contestData && contestData.mode === 'awd-f') {
                awdfConfig = {
                    defenseInterval: parseInt(document.getElementById('edit-defense-interval').value) || 300,
                    judgeConcurrency: parseInt(document.getElementById('edit-judge-concurrency').value) || 5
                };
            }

            try {
                // ä¿å­˜åŸºç¡€é…ç½®
                const res = await fetch(`/api/admin/contests/${contestId}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': 'Bearer ' + token,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ name, description, startTime, endTime, coverImage, teamLimit, containerLimit, ...awdfConfig })
                });
                if (!res.ok) throw new Error('Failed');
                
                // ä¿å­˜ç»„ç»‡å…³è”
                const orgRes = await fetch(`/api/admin/contests/${contestId}/organizations`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': 'Bearer ' + token,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ organizationIds: selectedOrgIds })
                });
                if (!orgRes.ok) {
                    console.error('ä¿å­˜ç»„ç»‡å…³è”å¤±è´¥');
                }
                
                // ç»„ç»‡å˜æ›´åä¸»åŠ¨åˆ·æ–°é˜Ÿä¼å®¡æ ¸åˆ—è¡¨ï¼ˆå…ˆåˆ·æ–°å†æç¤ºï¼‰
                await loadContestTeams();
                loadContest();
                showToast('ä¿å­˜æˆåŠŸ', 'success');
            } catch (e) {
                showToast('ä¿å­˜å¤±è´¥', 'error');
            }
        }

        // ç”Ÿæˆéšæœºé‚€è¯·ç ï¼ˆå¿…é¡»åŒ…å«å¤§å°å†™å­—æ¯ã€æ•°å­—ã€ç‰¹æ®Šå­—ç¬¦ï¼‰
        function generateCode() {
            const upper = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
            const lower = 'abcdefghijklmnopqrstuvwxyz';
            const digits = '0123456789';
            const special = '!@#$%^&*';
            const all = upper + lower + digits + special;
            
            // ç¡®ä¿æ¯ç§å­—ç¬¦è‡³å°‘æœ‰ä¸€ä¸ª
            let result = '';
            result += upper.charAt(Math.floor(Math.random() * upper.length));
            result += lower.charAt(Math.floor(Math.random() * lower.length));
            result += digits.charAt(Math.floor(Math.random() * digits.length));
            result += special.charAt(Math.floor(Math.random() * special.length));
            
            // å¡«å……å‰©ä½™12ä½
            for (let i = 0; i < 12; i++) {
                result += all.charAt(Math.floor(Math.random() * all.length));
            }
            
            // æ‰“ä¹±é¡ºåº
            result = result.split('').sort(() => Math.random() - 0.5).join('');
            document.getElementById('edit-invite-code').value = result;
        }

        // ========== AWD-F æ¨¡å¼ç®¡ç†åŠŸèƒ½ ==========
        
        // åŠ è½½è°ƒåº¦å™¨çŠ¶æ€
        async function loadSchedulerStatus() {
            if (!contestData || contestData.mode !== 'awd-f') return;
            try {
                const res = await fetch(`/api/admin/contests/${contestId}/awdf/scheduler-status`, {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                if (res.ok) {
                    const status = await res.json();
                    const statusEl = document.getElementById('awdf-scheduler-status');
                    if (status.running) {
                        const nextSec = status.nextAttackSeconds || 0;
                        statusEl.innerHTML = `
                            <div class="text-green-500">â— è°ƒåº¦å™¨è¿è¡Œä¸­</div>
                            <div class="text-gray-400 mt-1">å½“å‰è½®æ¬¡: ${status.currentRound || 0}</div>
                            <div class="text-gray-400">ä¸‹æ¬¡æ”»å‡»: ${nextSec > 0 ? formatTime(nextSec) : 'ç­‰å¾…ä¸­...'}</div>
                            ${status.judging ? '<div class="text-yellow-500 mt-1">âš  æ­£åœ¨åˆ¤é¢˜ä¸­...</div>' : ''}
                        `;
                    } else {
                        statusEl.innerHTML = '<div class="text-gray-500">â—‹ è°ƒåº¦å™¨æœªè¿è¡Œ</div><div class="text-gray-600 text-[10px] mt-1">æ¯”èµ›å¼€å§‹åè‡ªåŠ¨å¯åŠ¨</div>';
                    }
                }
            } catch (e) {
                document.getElementById('awdf-scheduler-status').innerHTML = '<div class="text-red-500">åŠ è½½å¤±è´¥</div>';
            }
        }

        function formatTime(seconds) {
            const min = Math.floor(seconds / 60);
            const sec = seconds % 60;
            return min > 0 ? `${min}åˆ†${sec}ç§’` : `${sec}ç§’`;
        }

        // æ‰‹åŠ¨è§¦å‘ä¸‹ä¸€è½®æ”»å‡»
        async function triggerNextRound() {
            if (!confirm('ç¡®å®šè¦ç«‹å³è§¦å‘ä¸‹ä¸€è½®æ”»å‡»å—ï¼Ÿ')) return;
            try {
                const res = await fetch(`/api/admin/contests/${contestId}/awdf/trigger-next-round`, {
                    method: 'POST',
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                const data = await res.json();
                if (res.ok) {
                    showToast(data.message || 'å·²è§¦å‘ä¸‹ä¸€è½®æ”»å‡»', 'success');
                    loadSchedulerStatus();
                } else {
                    showToast(data.error || 'è§¦å‘å¤±è´¥', 'error');
                }
            } catch (e) {
                showToast('è§¦å‘å¤±è´¥', 'error');
            }
        }

        // ç«‹å³æ›´æ–°é˜²å®ˆé—´éš”
        async function updateDefenseIntervalNow() {
            const interval = parseInt(document.getElementById('edit-defense-interval').value) || 60;
            if (interval < 10) {
                showToast('é˜²å®ˆé—´éš”ä¸èƒ½å°äº 10 ç§’', 'warning');
                return;
            }
            try {
                const res = await fetch(`/api/admin/contests/${contestId}/awdf/defense-interval`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': 'Bearer ' + token,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ interval })
                });
                const data = await res.json();
                if (res.ok) {
                    showToast('é˜²å®ˆé—´éš”å·²æ›´æ–°', 'success');
                    loadSchedulerStatus();
                } else {
                    showToast(data.error || 'æ›´æ–°å¤±è´¥', 'error');
                }
            } catch (e) {
                showToast('æ›´æ–°å¤±è´¥', 'error');
            }
        }

        // å®šæ—¶åˆ·æ–° AWD-F è°ƒåº¦å™¨çŠ¶æ€
        setInterval(() => {
            if (contestData && contestData.mode === 'awd-f' && contestData.status === 'running') {
                loadSchedulerStatus();
            }
        }, 5000); // æ¯ 5 ç§’åˆ·æ–°ä¸€æ¬¡

        // æ–‡ä»¶ä¸Šä¼ åŒºåŸŸç‚¹å‡»
        document.getElementById('upload-zone').addEventListener('click', () => {
            document.getElementById('cover-file').click();
        });

        // æ–‡ä»¶é€‰æ‹©åé¢„è§ˆå¹¶å­˜å‚¨
        document.getElementById('cover-file').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    const dataUrl = event.target.result;
                    updateCoverPreview(dataUrl);
                    // å°† base64 å­˜å‚¨åˆ°éšè—å­—æ®µï¼Œä¿å­˜æ—¶æäº¤
                    document.getElementById('edit-cover').value = dataUrl;
                };
                reader.readAsDataURL(file);
            }
        });

        // åˆå§‹åŒ–ï¼šç¡®ä¿æ¯”èµ›æ•°æ®å…ˆåŠ è½½å®Œæˆ
        loadContest().then(() => {
            loadCategories().then(() => {
                loadChallenges();
            });
        });
        loadOrganizations();
        loadContestTeams();
        loadAnnouncements(); // åˆå§‹åŒ–æ—¶åŠ è½½å…¬å‘Š
        connectAuditWebSocket(); // è¿æ¥é˜Ÿä¼å®¡æ ¸WebSocket

        // ========== ç»„ç»‡é€‰æ‹©åŠŸèƒ½ ==========
        function escapeHtml(str) {
            if (!str) return '';
            return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
        }

        async function loadOrganizations() {
            try {
                const res = await fetch('/api/admin/organizations', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                if (!res.ok) throw new Error('Failed');
                const data = await res.json();
                allOrganizations = (Array.isArray(data) ? data : []).filter(o => o.name !== 'TG_AdminX' && o.status === 'active');
                renderOrgOptions();
            } catch (e) {
                console.error(e);
                document.getElementById('org-options').innerHTML = '<div class="text-red-500 text-xs p-2">åŠ è½½å¤±è´¥</div>';
            }
        }

        function toggleOrgDropdown() {
            const dropdown = document.getElementById('org-dropdown');
            dropdown.classList.toggle('hidden');
            if (!dropdown.classList.contains('hidden')) {
                document.getElementById('org-search').focus();
            }
        }

        // ç‚¹å‡»å¤–éƒ¨å…³é—­ä¸‹æ‹‰èœå•
        document.addEventListener('click', (e) => {
            const container = document.getElementById('org-select-container');
            if (container && !container.contains(e.target)) {
                document.getElementById('org-dropdown').classList.add('hidden');
            }
        });

        function filterOrgOptions() {
            const searchTerm = document.getElementById('org-search').value.toLowerCase();
            const options = document.querySelectorAll('.org-option');
            options.forEach(opt => {
                const name = opt.dataset.name.toLowerCase();
                opt.style.display = name.includes(searchTerm) ? '' : 'none';
            });
        }

        function renderOrgOptions() {
            const container = document.getElementById('org-options');
            if (allOrganizations.length === 0) {
                container.innerHTML = '<div class="text-gray-500 text-xs p-2">æš‚æ— å¯é€‰ç»„ç»‡</div>';
                return;
            }
            container.innerHTML = allOrganizations.map(o => `
                <div class="org-option flex items-center gap-2 px-3 py-2 hover:bg-[#252525] cursor-pointer transition-colors ${selectedOrgIds.includes(o.id) ? 'bg-[#ff6b00] bg-opacity-10' : ''}"
                     data-id="${o.id}" data-name="${escapeHtml(o.name)}" onclick="toggleOrgSelection(${o.id}, event)">
                    <span class="w-4 h-4 border ${selectedOrgIds.includes(o.id) ? 'border-[#ff6b00] bg-[#ff6b00]' : 'border-gray-500'} flex items-center justify-center text-xs">
                        ${selectedOrgIds.includes(o.id) ? 'âœ“' : ''}
                    </span>
                    <span class="text-xs ${selectedOrgIds.includes(o.id) ? 'text-[#ff6b00]' : 'text-gray-300'}">${escapeHtml(o.name)}</span>
                </div>
            `).join('');
        }

        function toggleOrgSelection(id, event) {
            if (event) event.stopPropagation();
            const idx = selectedOrgIds.indexOf(id);
            if (idx > -1) {
                selectedOrgIds.splice(idx, 1);
            } else {
                selectedOrgIds.push(id);
            }
            renderOrgOptions();
            updateOrgDisplay();
        }

        function removeOrgSelection(id) {
            selectedOrgIds = selectedOrgIds.filter(i => i !== id);
            renderOrgOptions();
            updateOrgDisplay();
        }

        function updateOrgDisplay() {
            const display = document.getElementById('org-select-display');
            const tagsContainer = document.getElementById('org-selected-tags');
            
            if (selectedOrgIds.length === 0) {
                display.textContent = 'è¯·é€‰æ‹©ç»„ç»‡...';
                display.className = 'text-xs text-gray-400';
                tagsContainer.innerHTML = '';
            } else {
                display.textContent = `å·²é€‰æ‹© ${selectedOrgIds.length} ä¸ªç»„ç»‡`;
                display.className = 'text-xs text-[#ff6b00]';
                tagsContainer.innerHTML = selectedOrgIds.map(id => {
                    const org = allOrganizations.find(o => o.id === id);
                    if (!org) return '';
                    return `<span class="inline-flex items-center gap-1 bg-[#ff6b00] text-white text-[10px] px-2 py-0.5 font-bold">
                        ${escapeHtml(org.name)}
                        <span onclick="removeOrgSelection(${id})" class="cursor-pointer hover:text-white">Ã—</span>
                    </span>`;
                }).join('');
            }
        }

        // ========== é¢˜ç›®ç®¡ç†ï¼ˆæ–°ç‰ˆï¼Œä»é¢˜åº“æ·»åŠ ï¼‰ ==========

        // æ ¹æ®ç±»åˆ«IDè·å–å‘å…‰é¢œè‰²
        function getCategoryColor(categoryId) {
            const cat = categories.find(c => c.id === categoryId);
            return cat && cat.glowColor ? cat.glowColor : '#ff6b00';
        }

        // åŠ è½½ç±»åˆ«åˆ—è¡¨
        async function loadCategories() {
            try {
                const res = await fetch('/api/admin/categories', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                if (res.ok) {
                    categories = await res.json();
                    const select = document.getElementById('bank-filter-category');
                    categories.forEach(cat => {
                        const opt = document.createElement('option');
                        opt.value = cat.id;
                        opt.textContent = cat.name;
                        select.appendChild(opt);
                    });
                }
            } catch (e) {
                console.error(e);
            }
        }

        // åŠ è½½æ¯”èµ›é¢˜ç›®åˆ—è¡¨ï¼ˆæ–°ç‰ˆAPIï¼Œæ”¯æŒ AWD-Fï¼‰
        async function loadChallenges() {
            try {
                // æ ¹æ®æ¯”èµ›æ¨¡å¼é€‰æ‹©ä¸åŒçš„ API
                const isAWDF = contestData && contestData.mode === 'awd-f';
                const apiUrl = isAWDF 
                    ? `/api/admin/contests/${contestId}/awdf-challenges`
                    : `/api/admin/contests/${contestId}/contest-challenges`;
                
                const res = await fetch(apiUrl, {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                if (!res.ok) throw new Error('Failed');
                challenges = await res.json() || [];
                renderChallenges();
            } catch (e) {
                console.error(e);
                document.getElementById('challenges-tbody').innerHTML = '<tr><td colspan="9" class="p-8 text-center text-gray-500">åŠ è½½å¤±è´¥</td></tr>';
            }
        }

        // æ¸²æŸ“é¢˜ç›®åˆ—è¡¨
                
        function renderChallenges() {
            const tbody = document.getElementById('challenges-tbody');
            if (challenges.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="p-8 text-center text-gray-500">æš‚æ— é¢˜ç›®ï¼Œè¯·ä»é¢˜åº“æ·»åŠ </td></tr>';
                document.getElementById('total-challenges').textContent = '0';
                return;
            }
                    
            // æŒ‰æ˜¾ç¤ºé¡ºåºæ’åºï¼ˆé¡ºåºå·ä¸º0çš„æŒ‰æ·»åŠ é¡ºåºIDæ’ï¼Œå¦åˆ™æŒ‰é¡ºåºå·å‡åºï¼‰
            challenges.sort((a, b) => {
                const orderA = a.displayOrder || 999999;
                const orderB = b.displayOrder || 999999;
                if (orderA !== orderB) return orderA - orderB;
                return (a.id || 0) - (b.id || 0);
            });
                        
            document.getElementById('total-challenges').textContent = challenges.length;
            tbody.innerHTML = challenges.map((ch, idx) => {
                // æ”¯æŒæ‰å¹³å’ŒåµŒå¥—ä¸¤ç§æ•°æ®ç»“æ„
                const title = ch.title || (ch.question && ch.question.title) || 'N/A';
                const categoryId = ch.categoryId || (ch.question && ch.question.categoryId);
                // categoryName å¯èƒ½æ˜¯ sql.NullString æ ¼å¼
                let catName = ch.categoryName;
                if (catName && typeof catName === 'object') catName = catName.String || 'N/A';
                if (!catName) catName = (ch.question && ch.question.categoryName) || 'N/A';
                const color = getCategoryColor(categoryId);
                const statusText = ch.status === 'public' ? 'â— å…¬å¼€' : 'â—‹ éšè—';
                const statusClass = ch.status === 'public' ? 'text-green-500' : 'text-gray-500';
                // æ˜¾ç¤ºåºå·
                const orderDisplay = `<span class="text-gray-500">${idx + 1}</span>`;
                // æç¤ºçŠ¶æ€ - æ˜¾ç¤ºæ•°é‡
                const hintTotal = ch.hintCount || 0;
                const hintReleased = ch.hintReleasedCount || 0;
                let hintDisplay = '';
                if (hintTotal > 0) {
                    if (hintReleased > 0) {
                        hintDisplay = `<span class="text-green-500">${hintReleased}/${hintTotal} å·²å‘å¸ƒ</span>`;
                    } else {
                        hintDisplay = `<span class="text-yellow-500">${hintTotal} æœªå‘å¸ƒ</span>`;
                    }
                } else {
                    hintDisplay = '<span class="text-gray-600">-</span>';
                }
                // å®šæ—¶æ”¾é¢˜æ˜¾ç¤º
                let releaseTimeDisplay = '';
                if (ch.releaseTime && ch.status === 'hidden') {
                    const rt = new Date(ch.releaseTime);
                    releaseTimeDisplay = `<span class="text-purple-400 text-xs">â° ${rt.toLocaleString('zh-CN', {month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'})}</span>`;
                }
                return `
                    <tr class="table-row hover:bg-[#1a1a1a]">
                        <td class="p-4"><input type="checkbox" class="challenge-checkbox accent-[#ff6b00]" data-id="${ch.id}" ${selectedChallenges.has(ch.id) ? 'checked' : ''} onchange="toggleChallengeSelection(${ch.id}, this)"></td>
                        <td class="p-4">${orderDisplay}</td>
                        <td class="p-4 text-white font-bold">${title}</td>
                        <td class="p-4"><span class="px-2 py-0.5 border bg-opacity-10" style="color:${color};border-color:${color};background-color:${color}20">${catName}</span></td>
                        <td class="p-4 text-white">${ch.initialScore}</td>
                        <td class="p-4 text-gray-400">${ch.minScore}</td>
                        <td class="p-4 ${statusClass}">${statusText}${releaseTimeDisplay ? '<br>' + releaseTimeDisplay : ''}</td>
                        <td class="p-4 text-center">${hintDisplay}</td>
                        <td class="p-4 text-right">
                            <button onclick="viewChallengeFlags(${ch.id}, '${title.replace(/'/g, "\\'")}')" class="text-[#ff6b00] hover:text-white mr-3">Flag</button>
                            <button onclick="editContestChallenge(${ch.id})" class="text-gray-400 hover:text-white mr-3">ç¼–è¾‘</button>
                            <button onclick="toggleChallengeStatus(${ch.id}, '${ch.status}')" class="text-gray-400 hover:text-white mr-3">${ch.status === 'public' ? 'ä¸‹æ¶' : 'ä¸Šæ¶'}</button>
                            <button onclick="removeContestChallenge(${ch.id})" class="text-red-500 hover:underline">ç§»é™¤</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        // é¢˜ç›®å¤šé€‰æ“ä½œ
        function toggleSelectAllChallenges() {
            const selectAll = document.getElementById('select-all-challenges').checked;
            document.querySelectorAll('.challenge-checkbox').forEach(cb => {
                cb.checked = selectAll;
                const id = parseInt(cb.dataset.id);
                if (selectAll) selectedChallenges.add(id);
                else selectedChallenges.delete(id);
            });
        }
        
        function toggleChallengeSelection(id, checkbox) {
            if (checkbox.checked) selectedChallenges.add(id);
            else selectedChallenges.delete(id);
        }
        
        // æ‰¹é‡æ”¾é¢˜
        async function batchPublishChallenges() {
            if (selectedChallenges.size === 0) {
                showToast('è¯·å…ˆé€‰æ‹©è¦æ”¾é¢˜çš„é¢˜ç›®', 'warning');
                return;
            }
            let successCount = 0;
            let publishedTitles = [];
            for (const id of selectedChallenges) {
                try {
                    const res = await fetch(`/api/admin/contest-challenges/${id}`, {
                        method: 'PUT',
                        headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' },
                        body: JSON.stringify({ status: 'public' })
                    });
                    if (res.ok) {
                        successCount++;
                        // è·å–é¢˜ç›®åç§°
                        const ch = challenges.find(c => c.id === id);
                        if (ch) publishedTitles.push(ch.title || (ch.question && ch.question.title) || 'æœªçŸ¥é¢˜ç›®');
                    }
                } catch (e) { console.error(e); }
            }
            selectedChallenges.clear();
            document.getElementById('select-all-challenges').checked = false;
            loadChallenges();
            
            // è‡ªåŠ¨å‘å¸ƒä¸Šæ¶å…¬å‘Š
            if (successCount > 0 && publishedTitles.length > 0) {
                try {
                    const annTitle = 'é¢˜ç›®ä¸Šæ¶é€šçŸ¥';
                    const annContent = `ä»¥ä¸‹é¢˜ç›®å·²ä¸Šæ¶ï¼Œå¿«å»æŒ‘æˆ˜å§ï¼\n${publishedTitles.map(t => `ã€${t}ã€‘`).join('ã€')}`;
                    await fetch(`/api/admin/contests/${contestId}/announcements`, {
                        method: 'POST',
                        headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' },
                        body: JSON.stringify({ title: annTitle, content: annContent, pinned: false })
                    });
                } catch (e) { console.error('å‘å¸ƒå…¬å‘Šå¤±è´¥', e); }
            }
            showToast(`æˆåŠŸæ”¾é¢˜ ${successCount} é“é¢˜ç›®`, 'success');
        }
        
        // æ‰¹é‡éšè—
        async function batchHideChallenges() {
            if (selectedChallenges.size === 0) {
                showToast('è¯·å…ˆé€‰æ‹©è¦éšè—çš„é¢˜ç›®', 'warning');
                return;
            }
            let successCount = 0;
            for (const id of selectedChallenges) {
                try {
                    const res = await fetch(`/api/admin/contest-challenges/${id}`, {
                        method: 'PUT',
                        headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' },
                        body: JSON.stringify({ status: 'hidden' })
                    });
                    if (res.ok) successCount++;
                } catch (e) { console.error(e); }
            }
            selectedChallenges.clear();
            document.getElementById('select-all-challenges').checked = false;
            loadChallenges();
            showToast(`æˆåŠŸéšè— ${successCount} é“é¢˜ç›®`, 'success');
        }
        
        // æ‰¹é‡ç§»é™¤
        async function batchRemoveChallenges() {
            if (selectedChallenges.size === 0) {
                showToast('è¯·å…ˆé€‰æ‹©è¦ç§»é™¤çš„é¢˜ç›®', 'warning');
                return;
            }
            if (!confirm(`ç¡®å®šè¦ä»æ¯”èµ›ä¸­ç§»é™¤ ${selectedChallenges.size} é“é¢˜ç›®å—ï¼Ÿ`)) return;
            
            let successCount = 0;
            for (const id of selectedChallenges) {
                try {
                    const res = await fetch(`/api/admin/contest-challenges/${id}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': 'Bearer ' + token }
                    });
                    if (res.ok) successCount++;
                } catch (e) { console.error(e); }
            }
            selectedChallenges.clear();
            document.getElementById('select-all-challenges').checked = false;
            loadChallenges();
            showToast(`æˆåŠŸç§»é™¤ ${successCount} é“é¢˜ç›®`, 'success');
        }

        // æ˜¾ç¤ºæ‰¹é‡è°ƒåˆ†å¼¹çª—
        function showBatchScoreModal() {
            if (selectedChallenges.size === 0) {
                showToast('è¯·å…ˆé€‰æ‹©è¦è°ƒæ•´åˆ†æ•°çš„é¢˜ç›®', 'warning');
                return;
            }
            document.getElementById('batch-score-selected').textContent = `${selectedChallenges.size} é“é¢˜ç›®`;
            document.getElementById('batch-initial-score').value = '';
            document.getElementById('batch-min-score').value = '';
            document.getElementById('batch-difficulty').value = '';
            document.getElementById('batch-score-modal').classList.remove('hidden');
        }
        
        function hideBatchScoreModal() {
            document.getElementById('batch-score-modal').classList.add('hidden');
        }
        
        // æ‰¹é‡æ›´æ–°åˆ†æ•°
        async function batchUpdateScores() {
            const initialScore = document.getElementById('batch-initial-score').value;
            const minScore = document.getElementById('batch-min-score').value;
            const difficulty = document.getElementById('batch-difficulty').value;
            
            if (!initialScore && !minScore && !difficulty) {
                showToast('è¯·è‡³å°‘å¡«å†™ä¸€ä¸ªè¦ä¿®æ”¹çš„å€¼', 'warning');
                return;
            }
            
            const updateData = {};
            if (initialScore) updateData.initialScore = parseInt(initialScore);
            if (minScore) updateData.minScore = parseInt(minScore);
            if (difficulty) updateData.difficulty = parseInt(difficulty);
            
            let successCount = 0;
            for (const id of selectedChallenges) {
                try {
                    const res = await fetch(`/api/admin/contest-challenges/${id}`, {
                        method: 'PUT',
                        headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' },
                        body: JSON.stringify(updateData)
                    });
                    if (res.ok) successCount++;
                } catch (e) { console.error(e); }
            }
            
            hideBatchScoreModal();
            selectedChallenges.clear();
            document.getElementById('select-all-challenges').checked = false;
            loadChallenges();
            showToast(`æˆåŠŸä¿®æ”¹ ${successCount} é“é¢˜ç›®çš„åˆ†æ•°é…ç½®`, 'success');
        }

        // ========== æ‰¹é‡å®šæ—¶æ”¾é¢˜ ==========
        function showBatchScheduleModal() {
            if (selectedChallenges.size === 0) {
                showToast('è¯·å…ˆé€‰æ‹©è¦è®¾ç½®å®šæ—¶æ”¾é¢˜çš„é¢˜ç›®', 'warning');
                return;
            }
            document.getElementById('batch-schedule-selected').textContent = `${selectedChallenges.size} é“é¢˜ç›®`;
            document.getElementById('batch-release-time').value = '';
            document.getElementById('batch-schedule-modal').classList.remove('hidden');
        }
        
        function hideBatchScheduleModal() {
            document.getElementById('batch-schedule-modal').classList.add('hidden');
        }
        
        // æ‰¹é‡è®¾ç½®å®šæ—¶æ”¾é¢˜
        async function batchSetSchedule() {
            const releaseTimeValue = document.getElementById('batch-release-time').value;
            
            if (!releaseTimeValue) {
                showToast('è¯·é€‰æ‹©æ”¾é¢˜æ—¶é—´', 'warning');
                return;
            }
            
            // ç›´æ¥å‘é€æœ¬åœ°æ—¶é—´æ ¼å¼
            const releaseTime = releaseTimeValue + ':00';
            
            let successCount = 0;
            for (const id of selectedChallenges) {
                try {
                    const res = await fetch(`/api/admin/contest-challenges/${id}`, {
                        method: 'PUT',
                        headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' },
                        body: JSON.stringify({ releaseTime })
                    });
                    if (res.ok) successCount++;
                } catch (e) { console.error(e); }
            }
            
            hideBatchScheduleModal();
            selectedChallenges.clear();
            document.getElementById('select-all-challenges').checked = false;
            loadChallenges();
            showToast(`æˆåŠŸä¸º ${successCount} é“é¢˜ç›®è®¾ç½®å®šæ—¶æ”¾é¢˜`, 'success');
        }
        
        // æ‰¹é‡æ¸…é™¤å®šæ—¶æ”¾é¢˜
        async function clearBatchSchedule() {
            let successCount = 0;
            for (const id of selectedChallenges) {
                try {
                    const res = await fetch(`/api/admin/contest-challenges/${id}`, {
                        method: 'PUT',
                        headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' },
                        body: JSON.stringify({ releaseTime: null })
                    });
                    if (res.ok) successCount++;
                } catch (e) { console.error(e); }
            }
            
            hideBatchScheduleModal();
            selectedChallenges.clear();
            document.getElementById('select-all-challenges').checked = false;
            loadChallenges();
            showToast(`æˆåŠŸæ¸…é™¤ ${successCount} é“é¢˜ç›®çš„å®šæ—¶æ”¾é¢˜`, 'success');
        }

        // æ˜¾ç¤ºä»é¢˜åº“æ·»åŠ å¼¹çª—
        function showAddFromBankModal() {
            selectedQuestions.clear();
            updateSelectedCount();
            document.getElementById('bank-search').value = '';
            document.getElementById('bank-filter-category').value = '';
            document.getElementById('bank-filter-difficulty').value = '';
            document.getElementById('bank-initial-score').value = '500';
            document.getElementById('bank-min-score').value = '17';
            
            // æ ¹æ®æ¯”èµ›æ¨¡å¼æ›´æ–°å¼¹çª—æ ‡é¢˜
            const isAWDF = contestData && contestData.mode === 'awd-f';
            const modalTitle = document.querySelector('#add-from-bank-modal h3');
            if (modalTitle) {
                modalTitle.innerHTML = isAWDF 
                    ? 'ä» <span class="text-purple-400">AWD-F é¢˜åº“</span> æ·»åŠ é¢˜ç›®'
                    : 'ä» <span class="text-[#ff6b00]">Jeopardy é¢˜åº“</span> æ·»åŠ é¢˜ç›®';
            }
            
            document.getElementById('add-from-bank-modal').classList.remove('hidden');
            loadQuestionBank();
        }

        function hideAddFromBankModal() {
            document.getElementById('add-from-bank-modal').classList.add('hidden');
        }

        // åŠ è½½é¢˜åº“åˆ—è¡¨ï¼ˆå…¨é‡åŠ è½½ï¼Œæ”¯æŒ AWD-Fï¼‰
        let allQuestionBank = [];
        async function loadQuestionBank() {
            try {
                // æ ¹æ®æ¯”èµ›æ¨¡å¼é€‰æ‹©ä¸åŒçš„é¢˜åº“ API
                const isAWDF = contestData && contestData.mode === 'awd-f';
                const apiUrl = isAWDF ? '/api/admin/awdf/questions' : '/api/admin/questions';
                
                const res = await fetch(apiUrl, {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                if (!res.ok) throw new Error('Failed');
                allQuestionBank = await res.json() || [];
                
                // è¿‡æ»¤å·²æ·»åŠ çš„é¢˜ç›®
                const addedIds = new Set(challenges.map(c => c.questionId));
                allQuestionBank = allQuestionBank.filter(q => !addedIds.has(q.id));
                
                filterQuestionBank();
            } catch (e) {
                console.error(e);
                document.getElementById('question-bank-list').innerHTML = '<tr><td colspan="5" class="p-4 text-center text-red-500">åŠ è½½å¤±è´¥</td></tr>';
            }
        }

        // å‰ç«¯ç­›é€‰é¢˜åº“
        function filterQuestionBank() {
            const searchTerm = (document.getElementById('bank-search').value || '').toLowerCase().trim();
            const categoryId = document.getElementById('bank-filter-category').value;
            const difficulty = document.getElementById('bank-filter-difficulty').value;
            
            questionBank = allQuestionBank.filter(q => {
                // æœç´¢åç§°
                if (searchTerm && !q.title.toLowerCase().includes(searchTerm)) return false;
                // ç­›é€‰ç±»åˆ«
                if (categoryId && q.categoryId != categoryId) return false;
                // ç­›é€‰éš¾åº¦
                if (difficulty && q.difficulty !== difficulty) return false;
                return true;
            });
            
            renderQuestionBank();
        }

        function renderQuestionBank() {
            const tbody = document.getElementById('question-bank-list');
            if (questionBank.length === 0) {
                const searchTerm = (document.getElementById('bank-search').value || '').trim();
                if (searchTerm) {
                    tbody.innerHTML = '<tr><td colspan="5" class="p-4 text-center text-gray-500">æœªæ‰¾åˆ°åŒ¹é…çš„é¢˜ç›®</td></tr>';
                } else {
                    tbody.innerHTML = '<tr><td colspan="5" class="p-4 text-center text-gray-500">æš‚æ— å¯æ·»åŠ çš„é¢˜ç›®</td></tr>';
                }
                return;
            }
            
            const difficultyNames = { 'easy': 'ç®€å•', 'medium': 'ä¸­ç­‰', 'hard': 'å›°éš¾' };
            const typeNames = { 'static_attachment': 'é™æ€é™„ä»¶', 'static_container': 'é™æ€å®¹å™¨', 'dynamic_attachment': 'åŠ¨æ€é™„ä»¶', 'dynamic_container': 'åŠ¨æ€å®¹å™¨' };
            
            tbody.innerHTML = questionBank.map(q => {
                const color = getCategoryColor(q.categoryId);
                return `
                <tr class="hover:bg-[#1a1a1a] cursor-pointer" onclick="toggleQuestionSelection(${q.id}, this)">
                    <td class="p-3 text-center">
                        <input type="checkbox" ${selectedQuestions.has(q.id) ? 'checked' : ''} class="accent-[#ff6b00]" onclick="event.stopPropagation(); toggleQuestionSelection(${q.id}, this.closest('tr'))">
                    </td>
                    <td class="p-3 text-white">${q.title}</td>
                    <td class="p-3"><span class="px-2 py-0.5 border bg-opacity-10" style="color:${color};border-color:${color};background-color:${color}20">${q.categoryName || 'N/A'}</span></td>
                    <td class="p-3 text-gray-400">${difficultyNames[q.difficulty] || q.difficulty}</td>
                    <td class="p-3 text-gray-400">${typeNames[q.type] || q.type}</td>
                </tr>
            `}).join('');
        }

        function toggleQuestionSelection(id, row) {
            if (selectedQuestions.has(id)) {
                selectedQuestions.delete(id);
                row.querySelector('input[type="checkbox"]').checked = false;
            } else {
                selectedQuestions.add(id);
                row.querySelector('input[type="checkbox"]').checked = true;
            }
            updateSelectedCount();
            updateSelectAllState();
        }

        function toggleSelectAll(checked) {
            // åªå¯¹å½“å‰ç­›é€‰åæ˜¾ç¤ºçš„é¢˜ç›®è¿›è¡Œå…¨é€‰/å–æ¶ˆ
            questionBank.forEach(q => {
                if (checked) {
                    selectedQuestions.add(q.id);
                } else {
                    selectedQuestions.delete(q.id);
                }
            });
            renderQuestionBank();
            updateSelectedCount();
        }

        function updateSelectAllState() {
            const selectAllCheckbox = document.getElementById('select-all-bank');
            if (selectAllCheckbox && questionBank.length > 0) {
                selectAllCheckbox.checked = questionBank.every(q => selectedQuestions.has(q.id));
            }
        }

        function updateSelectedCount() {
            document.getElementById('selected-count').textContent = `å·²é€‰æ‹©: ${selectedQuestions.size} é“é¢˜ç›®`;
        }

        // æ·»åŠ é€‰ä¸­çš„é¢˜ç›®åˆ°æ¯”èµ›ï¼ˆæ”¯æŒ AWD-Fï¼‰
        async function addSelectedQuestions() {
            if (selectedQuestions.size === 0) {
                showToast('è¯·é€‰æ‹©è‡³å°‘ä¸€é“é¢˜ç›®', 'warning');
                return;
            }
            
            const initialScore = parseInt(document.getElementById('bank-initial-score').value) || 500;
            const minScore = parseInt(document.getElementById('bank-min-score').value) || 17;
            const questionIds = Array.from(selectedQuestions);
            
            // æ ¹æ®æ¯”èµ›æ¨¡å¼é€‰æ‹©ä¸åŒçš„ API
            const isAWDF = contestData && contestData.mode === 'awd-f';
            const apiUrl = isAWDF 
                ? `/api/admin/contests/${contestId}/awdf-challenges`
                : `/api/admin/contests/${contestId}/contest-challenges`;
            
            try {
                // AWD-F æ¨¡å¼éœ€è¦é€ä¸ªæ·»åŠ ï¼ˆå› ä¸º API è®¾è®¡ä¸åŒï¼‰
                if (isAWDF) {
                    let addedCount = 0;
                    for (const qid of questionIds) {
                        try {
                            const res = await fetch(apiUrl, {
                                method: 'POST',
                                headers: {
                                    'Authorization': 'Bearer ' + token,
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({ questionId: qid, initialScore, minScore })
                            });
                            if (res.ok) addedCount++;
                        } catch (e) { console.error(e); }
                    }
                    hideAddFromBankModal();
                    loadChallenges();
                    showToast(`æˆåŠŸæ·»åŠ  ${addedCount} é“ AWD-F é¢˜ç›®`, 'success');
                } else {
                    const res = await fetch(apiUrl, {
                        method: 'POST',
                        headers: {
                            'Authorization': 'Bearer ' + token,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ questionIds, initialScore, minScore })
                    });
                    const data = await res.json();
                    hideAddFromBankModal();
                    loadChallenges();
                    if (res.ok) {
                        showToast(`æˆåŠŸæ·»åŠ  ${data.added || 0} é“é¢˜ç›®`, 'success');
                    } else {
                        showToast(data.error || 'æ·»åŠ å¤±è´¥', 'error');
                    }
                }
            } catch (e) {
                console.error(e);
                showToast('æ·»åŠ å¤±è´¥', 'error');
            }
        }

        // ç¼–è¾‘æ¯”èµ›é¢˜ç›®
        function editContestChallenge(id) {
            const ch = challenges.find(c => c.id === id);
            if (!ch) return;
            
            const title = ch.title || (ch.question && ch.question.title) || 'N/A';
            document.getElementById('edit-cc-id').value = id;
            document.getElementById('edit-cc-title').value = title;
            document.getElementById('edit-cc-initial').value = ch.initialScore;
            document.getElementById('edit-cc-min').value = ch.minScore;
            document.getElementById('edit-cc-status').value = ch.status;
            
            // å®šæ—¶æ”¾é¢˜æ—¶é—´
            const releaseTimeInput = document.getElementById('edit-cc-release-time');
            const releaseTimeStatus = document.getElementById('release-time-status');
            if (ch.releaseTime) {
                const rt = new Date(ch.releaseTime);
                // è½¬æ¢ä¸ºæœ¬åœ°æ—¶é—´æ ¼å¼ (datetime-local éœ€è¦ YYYY-MM-DDTHH:mm)
                const localDT = rt.toISOString().slice(0, 16);
                releaseTimeInput.value = localDT;
                releaseTimeStatus.textContent = `å·²è®¾ç½®: ${rt.toLocaleString('zh-CN')}`;
                releaseTimeStatus.className = 'text-xs text-purple-400';
            } else {
                releaseTimeInput.value = '';
                releaseTimeStatus.textContent = 'æœªè®¾ç½®';
                releaseTimeStatus.className = 'text-xs text-gray-500';
            }
            
            // åŠ è½½æç¤ºåˆ—è¡¨
            loadChallengeHints(id);
            
            document.getElementById('edit-challenge-modal').classList.remove('hidden');
        }

        // æ¸…é™¤å®šæ—¶æ”¾é¢˜
        function clearReleaseTime() {
            document.getElementById('edit-cc-release-time').value = '';
            const releaseTimeStatus = document.getElementById('release-time-status');
            releaseTimeStatus.textContent = 'æœªè®¾ç½®';
            releaseTimeStatus.className = 'text-xs text-gray-500';
        }

        // åŠ è½½é¢˜ç›®æç¤ºåˆ—è¡¨
        let currentHints = [];
        async function loadChallengeHints(challengeId) {
            const container = document.getElementById('hints-list-container');
            container.innerHTML = '<div class="text-xs text-gray-500 text-center py-2">åŠ è½½ä¸­...</div>';
            
            try {
                const res = await fetch(`/api/admin/contest-challenges/${challengeId}/hints`, {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                if (!res.ok) throw new Error('Failed');
                currentHints = await res.json() || [];
                renderHintsList();
            } catch (e) {
                console.error(e);
                container.innerHTML = '<div class="text-xs text-red-500 text-center py-2">åŠ è½½å¤±è´¥</div>';
            }
        }

        function renderHintsList() {
            const container = document.getElementById('hints-list-container');
            const countEl = document.getElementById('hints-count');
            const releasedCount = currentHints.filter(h => h.released).length;
            countEl.textContent = `${currentHints.length} æ¡æç¤º (${releasedCount} å·²å‘å¸ƒ)`;
            
            if (currentHints.length === 0) {
                container.innerHTML = '<div class="text-xs text-gray-500 text-center py-4">æš‚æ— æç¤ºï¼Œè¯·åœ¨ä¸‹æ–¹æ·»åŠ </div>';
                return;
            }
            
            container.innerHTML = currentHints.map((hint, idx) => `
                <div class="flex items-start gap-2 p-2 bg-[#111] border border-[#333] ${hint.released ? 'border-l-2 border-l-green-500' : ''}">
                    <span class="text-xs text-gray-500 w-6 shrink-0">#${idx + 1}</span>
                    <div class="flex-1 min-w-0">
                        <p class="text-sm text-white break-all">${escapeHtml(hint.content)}</p>
                        <p class="text-[10px] text-gray-500 mt-1">
                            ${hint.released ? '<span class="text-green-500">âœ“ å·²å‘å¸ƒ</span>' : '<span class="text-yellow-500">â—‹ æœªå‘å¸ƒ</span>'}
                            ${hint.releasedAt ? ' Â· ' + formatTime(hint.releasedAt) : ''}
                        </p>
                    </div>
                    <div class="flex gap-2 shrink-0">
                        ${!hint.released ? `<button onclick="releaseHint(${hint.id})" class="text-xs text-[#ff6b00] hover:text-white">å‘å¸ƒ</button>` : ''}
                        <button onclick="deleteHint(${hint.id})" class="text-xs text-red-500 hover:text-white">åˆ é™¤</button>
                    </div>
                </div>
            `).join('');
        }

        function formatTime(isoString) {
            if (!isoString) return '';
            const d = new Date(isoString);
            return d.toLocaleString('zh-CN', { month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
        }

        // æ·»åŠ æ–°æç¤º
        async function addNewHint() {
            const content = document.getElementById('new-hint-content').value.trim();
            if (!content) {
                showToast('è¯·è¾“å…¥æç¤ºå†…å®¹', 'warning');
                return;
            }
            
            const challengeId = document.getElementById('edit-cc-id').value;
            
            try {
                const res = await fetch(`/api/admin/contest-challenges/${challengeId}/hints`, {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + token,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ content })
                });
                if (!res.ok) throw new Error('Failed');
                
                document.getElementById('new-hint-content').value = '';
                showToast('æç¤ºæ·»åŠ æˆåŠŸ', 'success');
                loadChallengeHints(challengeId);
                loadChallenges(); // åˆ·æ–°åˆ—è¡¨
            } catch (e) {
                showToast('æ·»åŠ å¤±è´¥', 'error');
            }
        }

        // å‘å¸ƒæç¤º
        async function releaseHint(hintId) {
            if (!confirm('ç¡®å®šè¦å‘å¸ƒè¿™æ¡æç¤ºå—ï¼Ÿå‘å¸ƒåå°†è‡ªåŠ¨ç”Ÿæˆå…¬å‘Šã€‚')) return;
            
            const challengeId = document.getElementById('edit-cc-id').value;
            
            try {
                const res = await fetch(`/api/admin/contest-challenges/${challengeId}/hints/${hintId}/release`, {
                    method: 'POST',
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                
                if (!res.ok) {
                    const data = await res.json();
                    showToast(data.message || 'å‘å¸ƒå¤±è´¥', 'error');
                    return;
                }
                
                showToast('æç¤ºå·²å‘å¸ƒå¹¶ç”Ÿæˆå…¬å‘Š', 'success');
                loadChallengeHints(challengeId);
                loadChallenges();
            } catch (e) {
                showToast('å‘å¸ƒå¤±è´¥', 'error');
            }
        }

        // åˆ é™¤æç¤º
        async function deleteHint(hintId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡æç¤ºå—ï¼Ÿ')) return;
            
            const challengeId = document.getElementById('edit-cc-id').value;
            
            try {
                const res = await fetch(`/api/admin/contest-challenges/${challengeId}/hints/${hintId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                if (!res.ok) throw new Error('Failed');
                
                showToast('æç¤ºå·²åˆ é™¤', 'success');
                loadChallengeHints(challengeId);
                loadChallenges();
            } catch (e) {
                showToast('åˆ é™¤å¤±è´¥', 'error');
            }
        }

        function hideEditChallengeModal() {
            document.getElementById('edit-challenge-modal').classList.add('hidden');
        }

        async function saveContestChallenge() {
            const id = document.getElementById('edit-cc-id').value;
            const initialScore = parseInt(document.getElementById('edit-cc-initial').value) || 500;
            const minScore = parseInt(document.getElementById('edit-cc-min').value) || 100;
            const status = document.getElementById('edit-cc-status').value;
            const releaseTimeValue = document.getElementById('edit-cc-release-time').value;
            
            // æ„å»ºè¯·æ±‚æ•°æ®
            const requestData = { initialScore, minScore, status };
            
            // å¤„ç†å®šæ—¶æ”¾é¢˜æ—¶é—´
            if (releaseTimeValue) {
                // ç›´æ¥å‘é€æœ¬åœ°æ—¶é—´æ ¼å¼ï¼Œé¿å…æ—¶åŒºé—®é¢˜
                requestData.releaseTime = releaseTimeValue + ':00';
            } else {
                // æ˜ç¡®ä¼ é€’ null æ¸…é™¤å®šæ—¶
                requestData.releaseTime = null;
            }
            
            try {
                const res = await fetch(`/api/admin/contest-challenges/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': 'Bearer ' + token,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });
                if (!res.ok) throw new Error('Failed');
                
                showToast('ä¿å­˜æˆåŠŸ', 'success');
                hideEditChallengeModal();
                loadChallenges();
            } catch (e) {
                showToast('ä¿å­˜å¤±è´¥', 'error');
            }
        }

        async function toggleChallengeStatus(id, currentStatus) {
            const newStatus = currentStatus === 'public' ? 'hidden' : 'public';
            try {
                // æ ¹æ®æ¯”èµ›æ¨¡å¼é€‰æ‹©ä¸åŒçš„ API
                const isAWDF = contestData && contestData.mode === 'awd-f';
                const apiUrl = isAWDF 
                    ? `/api/admin/awdf-challenges/${id}`
                    : `/api/admin/contest-challenges/${id}`;
                
                const res = await fetch(apiUrl, {
                    method: 'PUT',
                    headers: {
                        'Authorization': 'Bearer ' + token,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ status: newStatus })
                });
                if (!res.ok) throw new Error('Failed');
                loadChallenges();
            } catch (e) {
                showToast('æ“ä½œå¤±è´¥', 'error');
            }
        }

        async function removeContestChallenge(id) {
            if (!confirm('ç¡®å®šè¦ä»æ¯”èµ›ä¸­ç§»é™¤è¿™é“é¢˜ç›®å—ï¼Ÿ')) return;
            try {
                // æ ¹æ®æ¯”èµ›æ¨¡å¼é€‰æ‹©ä¸åŒçš„ API
                const isAWDF = contestData && contestData.mode === 'awd-f';
                const apiUrl = isAWDF 
                    ? `/api/admin/awdf-challenges/${id}`
                    : `/api/admin/contest-challenges/${id}`;
                
                const res = await fetch(apiUrl, {
                    method: 'DELETE',
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                if (!res.ok) throw new Error('Failed');
                loadChallenges();
            } catch (e) {
                showToast('ç§»é™¤å¤±è´¥', 'error');
            }
        }

        // ========== æŸ¥çœ‹é˜Ÿä¼FlagåŠŸèƒ½ ==========
        async function viewChallengeFlags(challengeId, title) {
            document.getElementById('flags-challenge-title').textContent = title;
            document.getElementById('view-flags-modal').classList.remove('hidden');
            document.getElementById('flags-list-tbody').innerHTML = '<tr><td colspan="3" class="p-4 text-center text-gray-500">åŠ è½½ä¸­...</td></tr>';
            document.getElementById('flags-count').textContent = 'å…± 0 æ¡è®°å½•';
            
            try {
                // ä¼ é€’æ¯”èµ›æ¨¡å¼å‚æ•°ï¼Œç”¨äºåç«¯åŒºåˆ† jeopardy å’Œ awdf è¡¨
                const mode = contestData && contestData.mode ? contestData.mode : 'jeopardy';
                const res = await fetch(`/api/admin/contest-challenges/${challengeId}/flags?mode=${mode}`, {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                if (!res.ok) throw new Error('Failed');
                const flags = await res.json() || [];
                renderFlagsList(flags);
            } catch (e) {
                console.error(e);
                document.getElementById('flags-list-tbody').innerHTML = '<tr><td colspan="3" class="p-4 text-center text-red-500">åŠ è½½å¤±è´¥</td></tr>';
            }
        }

        function renderFlagsList(flags) {
            const tbody = document.getElementById('flags-list-tbody');
            document.getElementById('flags-count').textContent = `å…± ${flags.length} æ¡è®°å½•`;
            
            if (flags.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" class="p-4 text-center text-gray-500">æš‚æ— Flagè®°å½•ï¼ˆé˜Ÿä¼æœªåˆ›å»ºè¿‡å®¹å™¨ï¼‰</td></tr>';
                return;
            }
            
            tbody.innerHTML = flags.map(f => `
                <tr class="table-row hover:bg-[#1a1a1a]">
                    <td class="p-3 text-white">${f.teamName}</td>
                    <td class="p-3 text-[#ff6b00] select-all cursor-pointer" onclick="copyFlag(this)" title="ç‚¹å‡»å¤åˆ¶">${f.flag}</td>
                    <td class="p-3 text-gray-400">${f.createdAt || '-'}</td>
                </tr>
            `).join('');
        }

        function hideFlagsModal() {
            document.getElementById('view-flags-modal').classList.add('hidden');
        }

        function copyFlag(el) {
            const text = el.textContent;
            navigator.clipboard.writeText(text).then(() => {
                const original = el.textContent;
                el.textContent = 'âœ“ å·²å¤åˆ¶';
                el.classList.add('text-green-500');
                setTimeout(() => {
                    el.textContent = original;
                    el.classList.remove('text-green-500');
                }, 1000);
            });
        }

        // ========== ä¸‰è¡€å¥–åŠ±é…ç½® ==========
        function toggleBonusModal(show) {
            const modal = document.getElementById('bonus-modal');
            if (show) {
                // åŠ è½½å½“å‰é…ç½®
                loadBonusConfig();
                modal.classList.remove('hidden');
            } else {
                modal.classList.add('hidden');
            }
        }

        async function loadBonusConfig() {
            try {
                const res = await fetch(`/api/admin/contests/${contestId}/bonus`, {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                if (res.ok) {
                    const data = await res.json();
                    document.getElementById('bonus-first').value = data.firstBlood || 5;
                    document.getElementById('bonus-second').value = data.secondBlood || 3;
                    document.getElementById('bonus-third').value = data.thirdBlood || 1;
                }
            } catch (e) {
                console.log('åŠ è½½ä¸‰è¡€é…ç½®å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å€¼');
            }
        }

        async function saveBonusConfig() {
            const firstBlood = parseInt(document.getElementById('bonus-first').value) || 0;
            const secondBlood = parseInt(document.getElementById('bonus-second').value) || 0;
            const thirdBlood = parseInt(document.getElementById('bonus-third').value) || 0;
            
            try {
                const res = await fetch(`/api/admin/contests/${contestId}/bonus`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': 'Bearer ' + token,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ firstBlood, secondBlood, thirdBlood })
                });
                if (!res.ok) throw new Error('Failed');
                toggleBonusModal(false);
                showToast('ä¸‰è¡€å¥–åŠ±é…ç½®å·²ä¿å­˜', 'success');
            } catch (e) {
                showToast('ä¿å­˜å¤±è´¥', 'error');
            }
        }

        // ========== é˜Ÿä¼å®¡æ ¸åŠŸèƒ½ ==========

        // WebSocket å®æ—¶æ¨é€é˜Ÿä¼å®¡æ ¸
        function connectAuditWebSocket() {
            if (!contestId) return;
            const wsProtocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
            auditWs = new WebSocket(`${wsProtocol}//${location.host}/api/admin/contests/${contestId}/teams/ws?token=${encodeURIComponent(token)}`);
            
            auditWs.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    if (data.type === 'new_teams' && data.teams) {
                        // æœ‰æ–°çš„å¾…å®¡æ ¸é˜Ÿä¼ï¼Œæ›´æ–°åˆ—è¡¨
                        const currentFilter = document.getElementById('audit-status-filter').value;
                        // å¦‚æœå½“å‰ç­›é€‰ä¸ºå…¨éƒ¨æˆ–å¾…å®¡æ ¸ï¼Œæ·»åŠ æ–°é˜Ÿä¼
                        if (!currentFilter || currentFilter === 'pending') {
                            data.teams.forEach(newTeam => {
                                // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
                                if (!contestTeams.find(t => t.teamId === newTeam.teamId)) {
                                    contestTeams.unshift(newTeam);
                                }
                            });
                            renderContestTeams();
                        }
                    } else if (data.type === 'teams_removed' && data.teamIds) {
                        // ç§»é™¤è¢«åˆ é™¤çš„é˜Ÿä¼
                        contestTeams = contestTeams.filter(t => !data.teamIds.includes(t.teamId));
                        renderContestTeams();
                    } else if (data.type === 'full_refresh') {
                        // ç»„ç»‡å˜æ›´åéœ€è¦å®Œå…¨é‡æ–°åŠ è½½é˜Ÿä¼åˆ—è¡¨
                        loadContestTeams();
                    }
                } catch (e) {
                    console.error('Parse audit ws message error:', e);
                }
            };
            
            auditWs.onclose = () => {
                // æ–­çº¿é‡è¿
                setTimeout(connectAuditWebSocket, 3000);
            };
            
            auditWs.onerror = () => {
                auditWs.close();
            };
        }

        async function loadContestTeams() {
            const status = document.getElementById('audit-status-filter').value;
            let url = `/api/admin/contests/${contestId}/teams`;
            if (status) url += `?status=${status}`;

            try {
                const res = await fetch(url, {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                if (!res.ok) throw new Error('Failed');
                contestTeams = await res.json() || [];
                selectedTeamIds.clear();
                document.getElementById('select-all-teams').checked = false;
                renderContestTeams();
            } catch (e) {
                console.error(e);
                document.getElementById('audit-teams-tbody').innerHTML = '<tr><td colspan="9" class="p-8 text-center text-gray-500">åŠ è½½å¤±è´¥</td></tr>';
            }
        }

        function renderContestTeams() {
            const tbody = document.getElementById('audit-teams-tbody');
            document.getElementById('audit-count').textContent = `å…± ${contestTeams.length} æ”¯é˜Ÿä¼`;

            if (contestTeams.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="p-8 text-center text-gray-500">æš‚æ— é˜Ÿä¼ç”³è¯·</td></tr>';
                return;
            }
            
            // IDå‡åºæ’åº
            contestTeams.sort((a, b) => (a.teamId || 0) - (b.teamId || 0));

            const statusConfig = {
                'pending': { text: 'â—‹ å¾…å®¡æ ¸', class: 'text-yellow-500' },
                'approved': { text: 'â— å·²é€šè¿‡', class: 'text-green-500' },
                'rejected': { text: 'â–  å·²æ‹’ç»', class: 'text-red-500' },
                'banned': { text: 'âœ— å·²å°ç¦', class: 'text-orange-500' },
                'cheating_banned': { text: 'â˜  ä½œå¼Šå°ç¦', class: 'text-red-600' }
            };

            // æ ¹æ®çŠ¶æ€ç”Ÿæˆæ“ä½œæŒ‰é’®
            function getActions(team) {
                const status = team.status;
                const id = team.id;
                
                if (status === 'pending') {
                    return `
                        <button onclick="reviewTeam(${id}, 'approve')" class="text-green-500 hover:underline mr-2">é€šè¿‡</button>
                        <button onclick="reviewTeam(${id}, 'reject')" class="text-red-500 hover:underline">æ‹’ç»</button>
                    `;
                } else if (status === 'approved') {
                    return `
                        <button onclick="reviewTeam(${id}, 'revoke')" class="text-yellow-500 hover:underline mr-2">æ’¤é”€</button>
                        <button onclick="reviewTeam(${id}, 'ban')" class="text-orange-500 hover:underline mr-2">å°ç¦</button>
                        <button onclick="reviewTeam(${id}, 'cheating_ban')" class="text-red-600 hover:underline">ä½œå¼Š</button>
                    `;
                } else if (status === 'rejected') {
                    return `
                        <button onclick="reviewTeam(${id}, 'approve')" class="text-green-500 hover:underline">é‡æ–°é€šè¿‡</button>
                    `;
                } else if (status === 'banned' || status === 'cheating_banned') {
                    return `
                        <button onclick="reviewTeam(${id}, 'revoke')" class="text-yellow-500 hover:underline">è§£å°</button>
                    `;
                }
                return '<span class="text-gray-600">-</span>';
            }

            tbody.innerHTML = contestTeams.map(team => {
                const cfg = statusConfig[team.status] || statusConfig.pending;
                // æ ¼å¼åŒ–é¢„åˆ†é…ç«¯å£æ˜¾ç¤º
                const portsDisplay = team.allocatedPorts && team.allocatedPorts.length > 0 
                    ? `<span class="text-cyan-400">${team.allocatedPorts.join(', ')}</span>` 
                    : '<span class="text-gray-600">-</span>';
                return `
                    <tr class="table-row hover:bg-[#1a1a1a]">
                        <td class="p-3">
                            <input type="checkbox" class="team-checkbox" data-id="${team.teamId}" onchange="toggleTeamSelection(${team.teamId})" ${selectedTeamIds.has(team.teamId) ? 'checked' : ''}>
                        </td>
                        <td class="p-3 text-gray-500">${team.teamId}</td>
                        <td class="p-3 text-white font-bold">${team.teamName || 'N/A'}</td>
                        <td class="p-3 text-gray-400">${team.orgName || '-'}</td>
                        <td class="p-3">${portsDisplay}</td>
                        <td class="p-3 ${cfg.class}">${cfg.text}</td>
                        <td class="p-3 text-gray-400">${team.createdAt || '-'}</td>
                        <td class="p-3 text-gray-400">${team.reviewedAt || '-'}</td>
                        <td class="p-3 text-left">${getActions(team)}</td>
                    </tr>
                `;
            }).join('');
        }

        function toggleTeamSelection(teamId) {
            if (selectedTeamIds.has(teamId)) {
                selectedTeamIds.delete(teamId);
            } else {
                selectedTeamIds.add(teamId);
            }
            updateTeamSelectAllState();
        }

        function toggleSelectAllTeams() {
            const checked = document.getElementById('select-all-teams').checked;
            // æ”¯æŒé€‰æ‹©ä»»ä½•çŠ¶æ€çš„é˜Ÿä¼
            if (checked) {
                contestTeams.forEach(t => selectedTeamIds.add(t.teamId));
            } else {
                selectedTeamIds.clear();
            }
            renderContestTeams();
        }

        function updateTeamSelectAllState() {
            // æ”¯æŒé€‰æ‹©ä»»ä½•çŠ¶æ€çš„é˜Ÿä¼
            const allSelected = contestTeams.length > 0 && contestTeams.every(t => selectedTeamIds.has(t.teamId));
            document.getElementById('select-all-teams').checked = allSelected;
        }

        async function reviewTeam(id, action) {
            const confirmMsgs = {
                'approve': 'ç¡®å®šé€šè¿‡è¯¥é˜Ÿä¼çš„ç”³è¯·ï¼Ÿ',
                'reject': 'ç¡®å®šæ‹’ç»è¯¥é˜Ÿä¼çš„ç”³è¯·ï¼Ÿ',
                'revoke': 'ç¡®å®šæ’¤é”€/è§£å°è¯¥é˜Ÿä¼ï¼Ÿ',
                'ban': 'ç¡®å®šå°ç¦è¯¥é˜Ÿä¼ï¼Ÿ',
                'cheating_ban': 'ç¡®å®šå°†è¯¥é˜Ÿä¼æ ‡è®°ä¸ºä½œå¼Šå°ç¦ï¼Ÿ'
            };
            
            if (!confirm(confirmMsgs[action] || 'ç¡®å®šæ‰§è¡Œæ­¤æ“ä½œï¼Ÿ')) return;

            // å°ç¦å’Œä½œå¼Šå°ç¦å¯ä»¥è¾“å…¥åŸå› 
            let reason = '';
            if (action === 'reject' || action === 'ban' || action === 'cheating_ban') {
                reason = prompt('è¯·è¾“å…¥åŸå› ï¼ˆå¯ä¸å¡«ï¼‰ï¼š') || '';
                if (reason === null) return; // ç”¨æˆ·å–æ¶ˆ
            }

            try {
                const res = await fetch(`/api/admin/contests/${contestId}/teams/${id}/review`, {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + token,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ action, reason })
                });
                if (!res.ok) throw new Error('Failed');
                loadContestTeams();
            } catch (e) {
                showToast('æ“ä½œå¤±è´¥', 'error');
            }
        }

        async function batchApprove() {
            if (selectedTeamIds.size === 0) {
                showToast('è¯·å…ˆé€‰æ‹©é˜Ÿä¼', 'warning');
                return;
            }
            if (!confirm(`ç¡®å®šæ‰¹é‡é€šè¿‡ ${selectedTeamIds.size} æ”¯é˜Ÿä¼çš„ç”³è¯·ï¼Ÿ`)) return;

            try {
                const res = await fetch(`/api/admin/contests/${contestId}/teams/batch-review`, {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + token,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ teamIds: Array.from(selectedTeamIds), action: 'approve' })
                });
                if (!res.ok) throw new Error('Failed');
                const result = await res.json();
                showToast(`æˆåŠŸé€šè¿‡ ${result.count} æ”¯é˜Ÿä¼`, 'success');
                loadContestTeams();
            } catch (e) {
                showToast('æ‰¹é‡å®¡æ ¸å¤±è´¥', 'error');
            }
        }

        async function batchReject() {
            if (selectedTeamIds.size === 0) {
                showToast('è¯·å…ˆé€‰æ‹©é˜Ÿä¼', 'warning');
                return;
            }
            const reason = prompt('è¯·è¾“å…¥æ‹’ç»åŸå› ï¼ˆå¯ä¸å¡«ï¼‰ï¼š');
            if (reason === null) return; // ç”¨æˆ·å–æ¶ˆ

            try {
                const res = await fetch(`/api/admin/contests/${contestId}/teams/batch-review`, {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + token,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ teamIds: Array.from(selectedTeamIds), action: 'reject', reason: reason })
                });
                if (!res.ok) throw new Error('Failed');
                const result = await res.json();
                showToast(`æˆåŠŸæ‹’ç» ${result.count} æ”¯é˜Ÿä¼`, 'success');
                loadContestTeams();
            } catch (e) {
                showToast('æ‰¹é‡å®¡æ ¸å¤±è´¥', 'error');
            }
        }

        async function batchBan() {
            if (selectedTeamIds.size === 0) {
                showToast('è¯·å…ˆé€‰æ‹©é˜Ÿä¼', 'warning');
                return;
            }
            if (!confirm(`ç¡®å®šæ‰¹é‡å°ç¦ ${selectedTeamIds.size} æ”¯é˜Ÿä¼ï¼Ÿ`)) return;
            const reason = prompt('è¯·è¾“å…¥å°ç¦åŸå› ï¼ˆå¯ä¸å¡«ï¼‰ï¼š');
            if (reason === null) return;

            try {
                const res = await fetch(`/api/admin/contests/${contestId}/teams/batch-review`, {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + token,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ teamIds: Array.from(selectedTeamIds), action: 'ban', reason: reason })
                });
                if (!res.ok) throw new Error('Failed');
                const result = await res.json();
                showToast(`æˆåŠŸå°ç¦ ${result.count} æ”¯é˜Ÿä¼`, 'success');
                loadContestTeams();
            } catch (e) {
                showToast('æ‰¹é‡å°ç¦å¤±è´¥', 'error');
            }
        }

        async function batchCheatBan() {
            if (selectedTeamIds.size === 0) {
                showToast('è¯·å…ˆé€‰æ‹©é˜Ÿä¼', 'warning');
                return;
            }
            if (!confirm(`ç¡®å®šå°† ${selectedTeamIds.size} æ”¯é˜Ÿä¼æ ‡è®°ä¸ºä½œå¼Šå°ç¦ï¼Ÿ`)) return;
            const reason = prompt('è¯·è¾“å…¥ä½œå¼ŠåŸå› ï¼ˆå¯ä¸å¡«ï¼‰ï¼š');
            if (reason === null) return;

            try {
                const res = await fetch(`/api/admin/contests/${contestId}/teams/batch-review`, {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + token,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ teamIds: Array.from(selectedTeamIds), action: 'cheating_ban', reason: reason })
                });
                if (!res.ok) throw new Error('Failed');
                const result = await res.json();
                showToast(`æˆåŠŸæ ‡è®° ${result.count} æ”¯é˜Ÿä¼ä¸ºä½œå¼Šå°ç¦`, 'success');
                loadContestTeams();
            } catch (e) {
                showToast('æ‰¹é‡ä½œå¼Šå°ç¦å¤±è´¥', 'error');
            }
        }

        // é¢„åˆ†é…ç«¯å£
        async function allocatePorts() {
            if (!confirm('ç¡®å®šä¸ºæ‰€æœ‰å·²å®¡æ ¸é˜Ÿä¼é¢„åˆ†é…ç«¯å£ï¼Ÿ\n\nç«¯å£å°†æ ¹æ®ç³»ç»Ÿè®¾ç½®çš„ç«¯å£èŒƒå›´è‡ªåŠ¨åˆ†é…ï¼Œå·²åˆ†é…ç«¯å£çš„é˜Ÿä¼ä¼šè·³è¿‡ã€‚')) return;

            try {
                const res = await fetch(`/api/admin/contests/${contestId}/allocate-ports`, {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + token,
                        'Content-Type': 'application/json'
                    }
                });
                const result = await res.json();
                if (!res.ok) {
                    showToast(result.message || 'ç«¯å£åˆ†é…å¤±è´¥', 'error');
                    return;
                }
                showToast(`${result.message}ï¼ˆæ¯é˜Ÿ ${result.portsPerTeam} ä¸ªç«¯å£ï¼‰`, 'success');
                loadContestTeams();
            } catch (e) {
                showToast('ç«¯å£åˆ†é…å¤±è´¥', 'error');
            }
        }

        // ========== å…¬å‘Šç®¡ç† ===========

        async function loadAnnouncements() {
            try {
                const res = await fetch(`/api/admin/contests/${contestId}/announcements`, {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                if (!res.ok) throw new Error('Failed');
                announcements = await res.json() || [];
                renderAnnouncements();
            } catch (e) {
                console.error('åŠ è½½å…¬å‘Šå¤±è´¥', e);
                document.getElementById('announcements-list').innerHTML = '<div class="p-8 text-center text-red-500 font-mono text-sm">åŠ è½½å¤±è´¥</div>';
            }
        }

        function renderAnnouncements() {
            const container = document.getElementById('announcements-list');
            document.getElementById('ann-count').textContent = `å…± ${announcements.length} æ¡å…¬å‘Š`;

            if (announcements.length === 0) {
                container.innerHTML = '<div class="p-8 text-center text-gray-500 font-mono text-sm">æš‚æ— å…¬å‘Š</div>';
                return;
            }

            const typeConfig = {
                'manual': { icon: 'ğŸ“¢', label: 'æ‰‹åŠ¨å‘å¸ƒ', color: 'text-blue-400' },
                'challenge_open': { icon: 'âœ…', label: 'é¢˜ç›®å¼€æ”¾', color: 'text-green-400' },
                'challenge_close': { icon: 'âŒ', label: 'é¢˜ç›®ä¸‹æ¶', color: 'text-gray-400' },
                'first_blood': { icon: 'ğŸ¥‡', label: 'ä¸€è¡€', color: 'text-yellow-400' },
                'second_blood': { icon: 'ğŸ¥ˆ', label: 'äºŒè¡€', color: 'text-gray-300' },
                'third_blood': { icon: 'ğŸ¥‰', label: 'ä¸‰è¡€', color: 'text-orange-400' },
                'cheating': { icon: 'âš ï¸', label: 'è¿è§„å¤„ç½š', color: 'text-red-500' }
            };

            container.innerHTML = announcements.map(ann => {
                const cfg = typeConfig[ann.type] || { icon: 'ğŸ“£', label: ann.type, color: 'text-gray-400' };
                return `
                    <div class="p-4 hover:bg-[#1a1a1a] transition-colors">
                        <div class="flex items-start justify-between gap-4">
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center gap-2 mb-2">
                                    ${ann.isPinned ? '<span class="text-[#ff6b00] text-xs">ğŸ“Œ</span>' : ''}
                                    <span class="text-lg">${cfg.icon}</span>
                                    <span class="text-xs px-2 py-0.5 border border-[#333] ${cfg.color}">${cfg.label}</span>
                                    <span class="text-xs text-gray-500 font-mono">${ann.createdAt}</span>
                                </div>
                                <h4 class="text-white font-bold mb-1 truncate">${escapeHtml(ann.title)}</h4>
                                <p class="text-gray-400 text-sm line-clamp-2">${escapeHtml(ann.content || '')}</p>
                            </div>
                            <div class="flex gap-2 shrink-0">
                                ${ann.type === 'manual' ? `
                                    <button onclick="editAnnouncement(${ann.id})" class="text-xs text-gray-500 hover:text-[#ff6b00] transition-colors">ç¼–è¾‘</button>
                                    <button onclick="deleteAnnouncement(${ann.id})" class="text-xs text-gray-500 hover:text-red-500 transition-colors">åˆ é™¤</button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function publishAnnouncement() {
            const title = document.getElementById('ann-title').value.trim();
            const content = document.getElementById('ann-content').value.trim();
            const isPinned = document.getElementById('ann-pinned').checked;

            if (!title) {
                showToast('è¯·è¾“å…¥å…¬å‘Šæ ‡é¢˜', 'warning');
                return;
            }

            try {
                const res = await fetch(`/api/admin/contests/${contestId}/announcements`, {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + token,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ title, content, isPinned })
                });
                if (!res.ok) throw new Error('Failed');
                
                // æ¸…ç©ºè¡¨å•
                document.getElementById('ann-title').value = '';
                document.getElementById('ann-content').value = '';
                document.getElementById('ann-pinned').checked = false;
                
                showToast('å…¬å‘Šå‘å¸ƒæˆåŠŸ', 'success');
                loadAnnouncements();
            } catch (e) {
                showToast('å‘å¸ƒå¤±è´¥', 'error');
            }
        }
        
        // å¿«æ·å…¬å‘Š
        async function quickAnnounce(type) {
            const templates = {
                'challenge_open': { title: 'é¢˜ç›®ä¸Šæ¶', content: 'é¢˜ç›®ã€{title}ã€å·²ä¸Šæ¶ï¼Œå¿«å»æŒ‘æˆ˜å§ï¼' },
                'challenge_close': { title: 'é¢˜ç›®ä¸‹æ¶', content: 'é¢˜ç›®ã€{title}ã€å·²ä¸‹æ¶ã€‚' },
                'first_blood': { title: 'ä¸€è¡€å…¬å‘Š', content: 'æ­å–œé˜Ÿä¼ã€{team}ã€è·å¾—é¢˜ç›®ã€{title}ã€çš„ä¸€è¡€ï¼ğŸ¥‡' },
                'second_blood': { title: 'äºŒè¡€å…¬å‘Š', content: 'æ­å–œé˜Ÿä¼ã€{team}ã€è·å¾—é¢˜ç›®ã€{title}ã€çš„äºŒè¡€ï¼ğŸ¥ˆ' },
                'third_blood': { title: 'ä¸‰è¡€å…¬å‘Š', content: 'æ­å–œé˜Ÿä¼ã€{team}ã€è·å¾—é¢˜ç›®ã€{title}ã€çš„ä¸‰è¡€ï¼ğŸ¥‰' },
                'hint': { title: 'é¢˜ç›®æç¤º', content: 'é¢˜ç›®ã€{title}ã€å‘å¸ƒæ–°æç¤ºï¼š{hint}' },
                'cheating': { title: 'è¿è§„å¤„ç½š', content: 'é˜Ÿä¼ã€{team}ã€å› è¿è§„è¡Œä¸ºè¢«å¤„ç½šï¼ŒåŸå› ï¼š{reason}' },
                'ban': { title: 'å°ç¦å…¬å‘Š', content: 'é˜Ÿä¼ã€{team}ã€å·²è¢«å°ç¦ï¼ŒåŸå› ï¼š{reason}' }
            };
            
            const template = templates[type];
            let title = template.title;
            let content = template.content;
            
            // æ ¹æ®ç±»å‹æç¤ºè¾“å…¥ä¿¡æ¯
            if (['challenge_open', 'challenge_close'].includes(type)) {
                const qTitle = prompt('è¯·è¾“å…¥é¢˜ç›®åç§°:');
                if (!qTitle) return;
                content = content.replace('{title}', qTitle);
            } else if (['first_blood', 'second_blood', 'third_blood'].includes(type)) {
                const team = prompt('è¯·è¾“å…¥é˜Ÿä¼åç§°:');
                if (!team) return;
                const qTitle = prompt('è¯·è¾“å…¥é¢˜ç›®åç§°:');
                if (!qTitle) return;
                content = content.replace('{team}', team).replace('{title}', qTitle);
            } else if (type === 'hint') {
                const qTitle = prompt('è¯·è¾“å…¥é¢˜ç›®åç§°:');
                if (!qTitle) return;
                const hint = prompt('è¯·è¾“å…¥æç¤ºå†…å®¹:');
                if (!hint) return;
                content = content.replace('{title}', qTitle).replace('{hint}', hint);
            } else if (['cheating', 'ban'].includes(type)) {
                const team = prompt('è¯·è¾“å…¥é˜Ÿä¼åç§°:');
                if (!team) return;
                const reason = prompt('è¯·è¾“å…¥åŸå› :');
                if (!reason) return;
                content = content.replace('{team}', team).replace('{reason}', reason);
            }
            
            // è‡ªåŠ¨å‘å¸ƒå…¬å‘Š
            try {
                const res = await fetch(`/api/admin/contests/${contestId}/announcements`, {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + token,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ title, content, pinned: false })
                });
                if (!res.ok) throw new Error('Failed');
                showToast('å…¬å‘Šå‘å¸ƒæˆåŠŸ', 'success');
                loadAnnouncements();
            } catch (e) {
                showToast('å…¬å‘Šå‘å¸ƒå¤±è´¥', 'error');
            }
        }

        async function editAnnouncement(id) {
            const ann = announcements.find(a => a.id === id);
            if (!ann) return;

            const newTitle = prompt('ç¼–è¾‘å…¬å‘Šæ ‡é¢˜:', ann.title);
            if (newTitle === null) return;

            const newContent = prompt('ç¼–è¾‘å…¬å‘Šå†…å®¹:', ann.content || '');
            if (newContent === null) return;

            try {
                const res = await fetch(`/api/admin/contests/${contestId}/announcements/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': 'Bearer ' + token,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ title: newTitle, content: newContent })
                });
                if (!res.ok) throw new Error('Failed');
                showToast('å…¬å‘Šå·²æ›´æ–°', 'success');
                loadAnnouncements();
            } catch (e) {
                showToast('æ›´æ–°å¤±è´¥', 'error');
            }
        }

        async function deleteAnnouncement(id) {
            if (!confirm('ç¡®å®šåˆ é™¤è¿™æ¡å…¬å‘Šï¼Ÿ')) return;

            try {
                const res = await fetch(`/api/admin/contests/${contestId}/announcements/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                if (!res.ok) throw new Error('Failed');
                showToast('å…¬å‘Šå·²åˆ é™¤', 'success');
                loadAnnouncements();
            } catch (e) {
                showToast('åˆ é™¤å¤±è´¥', 'error');
            }
        }

        // åˆå§‹åŒ–æ—¶åŠ è½½å…¬å‘Š
        document.addEventListener('DOMContentLoaded', () => {
            // Tabåˆ‡æ¢æ—¶åŠ è½½å…¬å‘Š
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    if (btn.dataset.tab === 'broadcast') {
                        loadAnnouncements();
                    }
                });
            });
        });

        // ========== Flagæ ¼å¼è®¾ç½® ==========
        function showFlagFormatModal() {
            if (!contestData) {
                showToast('æ¯”èµ›æ•°æ®æœªåŠ è½½', 'error');
                return;
            }
            const formatInput = document.getElementById('flag-format-input');
            formatInput.value = (contestData && contestData.flagFormat) || 'flag{[GUID]}';
            updateFlagPreview();
            document.getElementById('flag-format-modal').classList.remove('hidden');
        }

        function hideFlagFormatModal() {
            document.getElementById('flag-format-modal').classList.add('hidden');
        }

        function updateFlagPreview() {
            const format = document.getElementById('flag-format-input').value || 'flag{[GUID]}';
            const preview = format.replace('[GUID]', 'a1b2c3d4-5678-4abc-8def-123456789abc');
            document.getElementById('flag-format-preview').textContent = preview;
        }

        async function saveFlagFormat() {
            const format = document.getElementById('flag-format-input').value.trim() || 'flag{[GUID]}';
            
            // éªŒè¯æ ¼å¼å¿…é¡»åŒ…å« [GUID]
            if (!format.includes('[GUID]')) {
                showToast('æ ¼å¼å¿…é¡»åŒ…å« [GUID] å ä½ç¬¦', 'error');
                return;
            }
            
            // æ˜¾ç¤ºç¡®è®¤æç¤º
            if (contestData.flagFormat && contestData.flagFormat !== format) {
                if (!confirm('ä¿®æ”¹Flagæ ¼å¼åï¼Œæ‰€æœ‰å·²ç”Ÿæˆçš„Flagå°†è¢«åˆ é™¤ï¼ç¡®å®šè¦ç»§ç»­å—ï¼Ÿ')) {
                    return;
                }
            }
            
            try {
                const res = await fetch(`/api/admin/contests/${contestId}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': 'Bearer ' + token,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ flagFormat: format })
                });
                if (!res.ok) {
                    const data = await res.json();
                    throw new Error(data.error || 'Failed');
                }
                
                // æ›´æ–°æœ¬åœ°æ•°æ®
                contestData.flagFormat = format;
                
                showToast('Flagæ ¼å¼å·²ä¿å­˜', 'success');
                hideFlagFormatModal();
            } catch (e) {
                showToast('ä¿å­˜å¤±è´¥: ' + e.message, 'error');
            }
        }

        // ========== æ‹–æ‹½è°ƒæ•´é¡ºåº ==========
        let dragOrderList = []; // å­˜å‚¨æ‹–æ‹½æ’åºåˆ—è¡¨
        let draggedItem = null;

        function showBatchOrderModal() {
            // æ‰“å¼€å¼¹çª—æ—¶åˆå§‹åŒ–åˆ—è¡¨
            initDragOrderList();
            renderDragList();
            document.getElementById('batch-order-modal').classList.remove('hidden');
        }

        function hideBatchOrderModal() {
            document.getElementById('batch-order-modal').classList.add('hidden');
        }

        // åˆå§‹åŒ–æ‹–æ‹½åˆ—è¡¨ï¼ˆåªåœ¨æ‰“å¼€å¼¹çª—æ—¶è°ƒç”¨ï¼‰
        function initDragOrderList() {
            dragOrderList = [...challenges].sort((a, b) => {
                const orderA = a.displayOrder || 999999;
                const orderB = b.displayOrder || 999999;
                if (orderA !== orderB) return orderA - orderB;
                return (a.id || 0) - (b.id || 0);
            });
        }

        // æ¸²æŸ“æ‹–æ‹½åˆ—è¡¨ï¼ˆä¸é‡ç½®dragOrderListï¼‰
        function renderDragList() {
            const container = document.getElementById('order-list-container');
            if (dragOrderList.length === 0) {
                container.innerHTML = '<div class="p-4 text-center text-gray-500">æš‚æ— é¢˜ç›®</div>';
                return;
            }
            
            container.innerHTML = `<div id="drag-list" class="divide-y divide-[#222]">
                ${dragOrderList.map((ch, idx) => {
                    const title = ch.title || (ch.question && ch.question.title) || 'N/A';
                    let catName = ch.categoryName;
                    if (catName && typeof catName === 'object') catName = catName.String || 'N/A';
                    if (!catName) catName = 'N/A';
                    const statusText = ch.status === 'public' ? 'å…¬å¼€' : 'éšè—';
                    const statusClass = ch.status === 'public' ? 'text-green-500' : 'text-gray-500';
                    return `
                        <div class="drag-item flex items-center gap-3 p-3 bg-[#1a1a1a] hover:bg-[#222] cursor-move transition-colors" 
                             data-id="${ch.id}" data-idx="${idx}" draggable="true">
                            <span class="text-gray-600 text-lg">â˜°</span>
                            <span class="text-cyan-400 font-mono w-8">${idx + 1}</span>
                            <span class="text-white flex-1">${title}</span>
                            <span class="text-gray-500 text-xs">${catName}</span>
                            <span class="${statusClass} text-xs">${statusText}</span>
                        </div>
                    `;
                }).join('')}
            </div>`;
            
            // ç»‘å®šæ‹–æ‹½äº‹ä»¶
            initDragEvents();
        }

        function initDragEvents() {
            const items = document.querySelectorAll('.drag-item');
            items.forEach(item => {
                item.addEventListener('dragstart', handleDragStart);
                item.addEventListener('dragend', handleDragEnd);
                item.addEventListener('dragover', handleDragOver);
                item.addEventListener('dragleave', handleDragLeave);
                item.addEventListener('drop', handleDrop);
            });
        }

        function handleDragStart(e) {
            draggedItem = this;
            this.style.opacity = '0.4';
            this.style.background = '#333';
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', this.dataset.idx);
        }

        function handleDragEnd(e) {
            this.style.opacity = '1';
            this.style.background = '';
            document.querySelectorAll('.drag-item').forEach(item => {
                item.style.borderTop = '';
                item.style.borderBottom = '';
                item.style.background = '';
            });
            draggedItem = null;
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            if (!draggedItem || this === draggedItem) return;
            
            // æ¸…é™¤æ‰€æœ‰å…ƒç´ çš„è¾¹æ¡†
            document.querySelectorAll('.drag-item').forEach(item => {
                item.style.borderTop = '';
                item.style.borderBottom = '';
            });
            
            // æ ¹æ®é¼ æ ‡ä½ç½®æ˜¾ç¤ºè¾¹æ¡†
            const rect = this.getBoundingClientRect();
            const midY = rect.top + rect.height / 2;
            if (e.clientY < midY) {
                this.style.borderTop = '3px solid #ff6b00';
                this.dataset.insertBefore = 'true';
            } else {
                this.style.borderBottom = '3px solid #ff6b00';
                this.dataset.insertBefore = 'false';
            }
        }

        function handleDragLeave(e) {
            this.style.borderTop = '';
            this.style.borderBottom = '';
        }

        function handleDrop(e) {
            e.preventDefault();
            e.stopPropagation();
            if (!draggedItem || this === draggedItem) return;
            
            const fromIdx = parseInt(draggedItem.dataset.idx);
            const toIdx = parseInt(this.dataset.idx);
            const insertBefore = this.dataset.insertBefore === 'true';
            
            console.log('Drop:', {fromIdx, toIdx, insertBefore, listLen: dragOrderList.length});
            
            // ä»æ•°ç»„ä¸­ç§»é™¤è¢«æ‹–æ‹½çš„å…ƒç´ 
            const movedItem = dragOrderList.splice(fromIdx, 1)[0];
            
            // è®¡ç®—æ–°çš„æ’å…¥ä½ç½®
            let newIdx;
            if (fromIdx < toIdx) {
                // å‘ä¸‹æ‹–ï¼Œåˆ é™¤åç´¢å¼•è¦å‡1
                newIdx = insertBefore ? toIdx - 1 : toIdx;
            } else {
                // å‘ä¸Šæ‹–
                newIdx = insertBefore ? toIdx : toIdx + 1;
            }
            newIdx = Math.max(0, Math.min(newIdx, dragOrderList.length));
            
            console.log('Insert at:', newIdx);
            
            // æ’å…¥åˆ°æ–°ä½ç½®
            dragOrderList.splice(newIdx, 0, movedItem);
            
            // æ¸…é™¤æ ·å¼å¹¶é‡æ–°æ¸²æŸ“ï¼ˆæ³¨æ„ï¼šè¿™é‡Œè°ƒç”¨renderDragListï¼Œä¸é‡ç½®æ•°ç»„ï¼‰
            this.style.borderTop = '';
            this.style.borderBottom = '';
            renderDragList();
        }

        // è¿˜åŸé»˜è®¤é¡ºåºï¼ˆæŒ‰æ·»åŠ é¡ºåºï¼‰
        function resetOrderToDefault() {
            dragOrderList = [...challenges].sort((a, b) => (a.id || 0) - (b.id || 0));
            renderDragList();
            showToast('å·²è¿˜åŸä¸ºé»˜è®¤é¡ºåº', 'info');
        }

        // ä¿å­˜é¡ºåº
        async function saveBatchOrder() {
            const orders = dragOrderList.map((ch, idx) => ({
                id: ch.id,
                displayOrder: idx + 1
            }));
            
            try {
                const res = await fetch(`/api/admin/contests/${contestId}/contest-challenges/order`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': 'Bearer ' + token,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ orders })
                });
                
                if (!res.ok) {
                    const data = await res.json();
                    throw new Error(data.error || 'Failed');
                }
                
                const result = await res.json();
                showToast(`å·²æ›´æ–° ${result.updated} é“é¢˜ç›®çš„é¡ºåº`, 'success');
                hideBatchOrderModal();
                loadChallenges(); // é‡æ–°åŠ è½½é¢˜ç›®åˆ—è¡¨
            } catch (e) {
                showToast('ä¿å­˜å¤±è´¥: ' + e.message, 'error');
            }
        }
    </script>

</body>
</html>
