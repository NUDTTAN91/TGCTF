<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="author" content="tan91">
    <link rel="icon" type="image/svg+xml" href="../TeamIco.svg">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/fonts.css">
    <style>
        :root {
            --bg-dark: #121212;
            --bg-panel: #1e1e1e;
            --border-color: #333;
            --accent: #ff6b00;
            --danger: #ef4444;
            --text-main: #e0e0e0;
            --text-dim: #737373;
        }
        body { background-color: var(--bg-dark); color: var(--text-main); font-family: 'Noto Sans SC', sans-serif; }
        .font-eng { font-family: 'Chakra Petch', sans-serif; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        .sidebar-item { border-left: 2px solid transparent; transition: all 0.2s; }
        .sidebar-item:hover, .sidebar-item.active { background: rgba(255, 107, 0, 0.05); border-left-color: var(--accent); color: white; }
        .sidebar-item.active .icon { color: var(--accent); }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #111; }
        ::-webkit-scrollbar-thumb { background: #333; }
        .env-card { background: var(--bg-panel); border: 1px solid var(--border-color); transition: all 0.2s; }
        .env-card:hover { border-color: var(--accent); }
        .env-card.default { border-color: var(--accent); background: rgba(255, 107, 0, 0.05); }
        .form-input { background: #111; border: 1px solid #333; color: #fff; padding: 0.5rem 0.75rem; width: 100%; font-size: 0.875rem; }
        .form-input:focus { outline: none; border-color: var(--accent); }
        .btn-primary { background: var(--accent); color: black; font-weight: bold; padding: 0.5rem 1rem; transition: all 0.2s; }
        .btn-primary:hover { background: #ff8533; }
        .btn-danger { border: 1px solid var(--danger); color: var(--danger); padding: 0.5rem 1rem; transition: all 0.2s; }
        .btn-danger:hover { background: var(--danger); color: white; }
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 100; }
        .modal.show { display: flex; align-items: center; justify-content: center; }
    </style>
</head>
<body class="flex h-screen overflow-hidden selection:bg-[#ff6b00] selection:text-black">

    <!-- å·¦ä¾§ä¾§è¾¹æ  -->
    <aside class="w-48 bg-[#161616] border-r border-[#333] flex flex-col z-20 shadow-xl">
        <div class="h-16 flex items-center px-6 border-b border-[#333]">
            <div class="bg-[#ff6b00] text-black font-black text-xl px-2 py-0.5 font-eng tracking-tighter mr-3">TG</div>
            <span class="font-bold text-gray-300 tracking-wider text-sm">ç®¡ç†ä¸­æ¢</span>
        </div>
        <nav class="flex-1 py-6 space-y-1 font-mono text-xs overflow-y-auto">
            <a href="/admin/admin.html" class="sidebar-item flex items-center px-6 py-3 text-gray-400">
                <span class="icon mr-3">âŒ‚</span> æ¦‚è§ˆ
            </a>
            <p class="px-6 text-[#555] mb-2 font-bold mt-4">èµ›äº‹æ ¸å¿ƒ</p>
            <a href="/admin/admin-contests.html" class="sidebar-item flex items-center px-6 py-3 text-gray-400"><span class="icon mr-3">âš‘</span> æ¯”èµ›ç®¡ç†</a>
            <a href="/admin/admin-question-bank.html" class="sidebar-item active flex items-center px-6 py-3 text-gray-400"><span class="icon mr-3">â˜·</span> é¢˜åº“</a>
            <a href="/admin/admin-users.html" class="sidebar-item flex items-center px-6 py-3 text-gray-400"><span class="icon mr-3">ì›ƒ</span> ç”¨æˆ·ç®¡ç†</a>
            <a href="/admin/admin-teams.html" class="sidebar-item flex items-center px-6 py-3 text-gray-400"><span class="icon mr-3">â—ˆ</span> é˜Ÿä¼ç®¡ç†</a>
            <a href="/admin/admin-organizations.html" class="sidebar-item flex items-center px-6 py-3 text-gray-400"><span class="icon mr-3">ğŸ¢</span> ç»„ç»‡ç®¡ç†</a>
            <a href="/admin/admin-data-import.html" class="sidebar-item flex items-center px-6 py-3 text-gray-400"><span class="icon mr-3">ğŸ“¥</span> æ•°æ®å¯¼å…¥</a>
            <p class="px-6 text-[#555] mb-2 font-bold mt-6">è¿ç»´ç›‘æ§</p>
            <a href="/admin/admin-docker.html" class="sidebar-item flex items-center px-6 py-3 text-gray-400"><span class="icon mr-3">ğŸ³</span> dockerå®ä¾‹ç®¡ç†</a>
            <a href="/admin/admin-anti-cheat.html" class="sidebar-item flex items-center px-6 py-3 text-gray-400"><span class="icon mr-3">ğŸ›¡ï¸</span> é˜²ä½œå¼Šç³»ç»Ÿ</a>
            <a href="/admin/admin-logs.html" class="sidebar-item flex items-center px-6 py-3 text-gray-400"><span class="icon mr-3">âš </span> ç³»ç»Ÿæ—¥å¿—</a>
            <a href="/admin/admin-settings.html" class="sidebar-item flex items-center px-6 py-3 text-gray-400"><span class="icon mr-3">âš™</span> ç³»ç»Ÿè®¾ç½®</a>
        </nav>
        <div class="p-4 border-t border-[#333]">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 bg-[#333] rounded-full flex items-center justify-center text-[#ff6b00] font-bold">A</div>
                <div><p class="text-xs text-white font-bold">è¶…çº§ç®¡ç†å‘˜</p><p class="text-[10px] text-green-500">â— è¿æ¥ç¨³å®š</p></div>
            </div>
        </div>
    </aside>

    <!-- å³ä¾§å†…å®¹åŒº -->
    <div class="flex-1 flex flex-col min-w-0 bg-[#121212]">
        <header class="h-16 bg-[#161616] border-b border-[#333] flex items-center justify-between px-8 z-10">
            <div class="flex items-center gap-4 text-xs font-mono">
                <span class="text-gray-500">ä½ç½®:</span><span class="text-[#ff6b00]">å¤©æ ¼åå°</span><span class="text-gray-600">/</span>
                <a href="/admin/admin-question-bank.html" class="text-gray-400 hover:text-white">é¢˜åº“</a><span class="text-gray-600">/</span>
                <span class="text-white">ç¯å¢ƒå˜é‡æ³¨å…¥</span>
            </div>
            <div class="flex items-center gap-3">
                <a href="/home.html" class="font-mono text-xs font-bold border border-gray-500 text-gray-400 px-4 py-2 hover:border-white hover:text-white transition-all uppercase tracking-wider">â† è¿”å›å‰å°</a>
                <button id="logout-btn" class="font-mono text-xs font-bold border border-[#ff6b00] text-[#ff6b00] px-4 py-2 hover:bg-[#ff6b00] hover:text-black transition-all uppercase tracking-wider">Logout_ç¦»çº¿</button>
            </div>
        </header>

        <main class="flex-1 flex flex-col pt-6 px-8 relative overflow-y-auto">
            <div class="absolute inset-0 z-0 opacity-10 pointer-events-none" style="background-image: radial-gradient(#333 1px, transparent 1px); background-size: 20px 20px;"></div>
            
            <div class="relative z-10 w-full max-w-[900px] mx-auto flex-1 flex flex-col">
                
                <!-- æ ‡é¢˜å’Œæ“ä½œæ  -->
                <div class="flex items-center justify-between mb-6">
                    <div>
                        <h1 class="text-2xl font-black font-eng text-white mb-1">FLAG INJECT</h1>
                        <p class="text-gray-500 font-mono text-xs">ç®¡ç†å®¹å™¨é¢˜ç›®çš„Flagæ³¨å…¥ç¯å¢ƒå˜é‡</p>
                    </div>
                    <button onclick="showAddModal()" class="btn-primary font-mono text-xs">+ æ·»åŠ ç¯å¢ƒå˜é‡</button>
                </div>

                <!-- è¯´æ˜ -->
                <div class="bg-[#1e1e1e] border border-[#333] p-4 mb-6">
                    <p class="text-xs text-gray-400 leading-relaxed">
                        <span class="text-[#ff6b00] font-bold">è¯´æ˜ï¼š</span>
                        å®¹å™¨é¢˜ç›®å¯åŠ¨æ—¶ï¼Œç³»ç»Ÿä¼šé€šè¿‡ç¯å¢ƒå˜é‡å°†åŠ¨æ€Flagæ³¨å…¥åˆ°å®¹å™¨ä¸­ã€‚ä¸åŒçš„Dockeré•œåƒå¯èƒ½ä½¿ç”¨ä¸åŒçš„ç¯å¢ƒå˜é‡åæ¥æ¥æ”¶Flagï¼Œ
                        ä¾‹å¦‚ <code class="text-[#ff6b00]">$FLAG</code>ã€<code class="text-[#ff6b00]">$GZCTF_FLAG</code>ã€<code class="text-[#ff6b00]">$CTF_FLAG</code> ç­‰ã€‚
                        åœ¨æ­¤ç®¡ç†å¸¸ç”¨çš„ç¯å¢ƒå˜é‡åç§°ï¼Œä»¥ä¾¿åœ¨æ–°å¢é¢˜ç›®æ—¶å¿«é€Ÿé€‰æ‹©ã€‚
                    </p>
                </div>

                <!-- ç¯å¢ƒå˜é‡åˆ—è¡¨ -->
                <div id="env-list" class="space-y-3 flex-1">
                    <!-- åŠ¨æ€åŠ è½½ -->
                </div>

            </div>

            <footer class="py-1 border-t border-[#333] flex items-center justify-center flex-shrink-0 mt-auto">
                <div class="flex items-center justify-center gap-4 text-xs flex-wrap">
                    <div class="flex items-center gap-1">
                        <div class="bg-[#ff6b00] text-black font-black px-1.5 py-0.5 font-eng tracking-tighter">TG</div>
                        <span class="text-gray-500">å¤©æ ¼åå°ç®¡ç†ç³»ç»Ÿ</span>
                    </div>
                    <span class="text-white font-mono">Copyright Â© 2021-present tan91. All Rights Reserved.</span>
                    <a href="https://github.com/NUDTTAN91" target="_blank" class="text-[#ff6b00] hover:text-white transition-colors"><svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor"><path d="M12 0C5.37 0 0 5.37 0 12c0 5.31 3.435 9.795 8.205 11.385.6.105.825-.255.825-.57 0-.285-.015-1.23-.015-2.235-3.015.555-3.795-.735-4.035-1.41-.135-.345-.72-1.41-1.23-1.695-.42-.225-1.02-.78-.015-.795.945-.015 1.62.87 1.845 1.23 1.08 1.815 2.805 1.305 3.495.99.105-.78.42-1.305.765-1.605-2.67-.3-5.46-1.335-5.46-5.925 0-1.305.465-2.385 1.23-3.225-.12-.3-.54-1.53.12-3.18 0 0 1.005-.315 3.3 1.23.96-.27 1.98-.405 3-.405s2.04.135 3 .405c2.295-1.56 3.3-1.23 3.3-1.23.66 1.65.24 2.88.12 3.18.765.84 1.23 1.905 1.23 3.225 0 4.605-2.805 5.625-5.475 5.925.435.375.81 1.095.81 2.22 0 1.605-.015 2.895-.015 3.3 0 .315.225.69.825.57A12.02 12.02 0 0024 12c0-6.63-5.37-12-12-12z"/></svg></a>
                    <a href="https://blog.csdn.net/ZXW_NUDT" target="_blank" class="text-[#ff6b00] hover:text-white transition-colors"><svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg></a>
                </div>
            </footer>
        </main>
    </div>

    <!-- æ·»åŠ /ç¼–è¾‘å¼¹çª— -->
    <div id="modal" class="modal">
        <div class="bg-[#1e1e1e] border border-[#333] p-6 w-full max-w-md">
            <h3 id="modal-title" class="text-lg font-bold font-eng text-white mb-4">æ·»åŠ ç¯å¢ƒå˜é‡</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-xs text-gray-400 mb-1">ç¯å¢ƒå˜é‡åç§°</label>
                    <input type="text" id="env-name" class="form-input font-mono" placeholder="ä¾‹å¦‚: FLAG, GZCTF_FLAG">
                    <p class="text-[10px] text-gray-500 mt-1">ä¸éœ€è¦åŠ  $ ç¬¦å·ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨å¤„ç†</p>
                </div>
                <div>
                    <label class="block text-xs text-gray-400 mb-1">æè¿°è¯´æ˜</label>
                    <input type="text" id="env-desc" class="form-input" placeholder="ä¾‹å¦‚: GZCTFå¹³å°é»˜è®¤">
                </div>
                <div class="flex items-center gap-2">
                    <input type="checkbox" id="env-default" class="w-4 h-4 accent-[#ff6b00]">
                    <label for="env-default" class="text-xs text-gray-400">è®¾ä¸ºé»˜è®¤é€‰é¡¹</label>
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="saveEnv()" class="btn-primary flex-1 font-mono text-xs">ä¿å­˜</button>
                <button onclick="closeModal()" class="btn-danger font-mono text-xs">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <script>
        function parseJwt(token) {
            try {
                const base64Url = token.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const jsonPayload = decodeURIComponent(atob(base64).split('').map(c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join(''));
                return JSON.parse(jsonPayload);
            } catch (e) {
                return null;
            }
        }

        const token = localStorage.getItem('tg_token');
        if (!token) {
            window.location.href = '/login.html';
        } else {
            const payload = parseJwt(token);
            if (!payload || payload.role !== 'super') {
                alert('æƒé™ä¸è¶³ï¼šä»…è¶…çº§ç®¡ç†å‘˜å¯è®¿é—®æ­¤é¡µé¢');
                window.location.href = '/home.html';
            }
        }

        document.getElementById('logout-btn').addEventListener('click', () => {
            localStorage.removeItem('tg_token');
            window.location.href = '/login.html';
        });

        // ç¯å¢ƒå˜é‡æ•°æ® - ä½¿ç”¨ localStorage å­˜å‚¨
        const STORAGE_KEY = 'tg_flag_envs';
        
        // é»˜è®¤é¢„è®¾ï¼šFLAGã€GZCTF_FLAG å’Œ CMDARG
        const defaultEnvs = [
            { id: 1, name: 'FLAG', desc: 'é€šç”¨é»˜è®¤', isDefault: true },
            { id: 2, name: 'GZCTF_FLAG', desc: 'GZCTFå¹³å°', isDefault: false },
            { id: 3, name: 'CMDARG', desc: 'å‘½ä»¤è¡Œå‚æ•° $1', isDefault: false },
        ];

        function getEnvs() {
            const stored = localStorage.getItem(STORAGE_KEY);
            if (!stored) {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(defaultEnvs));
                return defaultEnvs;
            }
            return JSON.parse(stored);
        }

        function saveEnvs(envs) {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(envs));
        }

        let editingId = null;

        function renderList() {
            const envs = getEnvs();
            const container = document.getElementById('env-list');
            
            if (envs.length === 0) {
                container.innerHTML = `<div class="text-center text-gray-500 py-12">æš‚æ— ç¯å¢ƒå˜é‡é…ç½®</div>`;
                return;
            }

            container.innerHTML = envs.map(env => `
                <div class="env-card ${env.isDefault ? 'default' : ''} p-4 flex items-center justify-between">
                    <div class="flex items-center gap-4">
                        <div class="font-mono text-lg text-[#ff6b00] font-bold">$${env.name}</div>
                        <div class="text-xs text-gray-500">${env.desc || ''}</div>
                        ${env.isDefault ? '<span class="text-[10px] bg-[#ff6b00] text-black px-2 py-0.5 font-bold">é»˜è®¤</span>' : ''}
                    </div>
                    <div class="flex items-center gap-2">
                        ${!env.isDefault ? `<button onclick="setDefault(${env.id})" class="text-xs text-gray-400 hover:text-[#ff6b00] transition-colors">è®¾ä¸ºé»˜è®¤</button>` : ''}
                        <button onclick="editEnv(${env.id})" class="text-xs text-gray-400 hover:text-white transition-colors">ç¼–è¾‘</button>
                        <button onclick="deleteEnv(${env.id})" class="text-xs text-gray-400 hover:text-red-500 transition-colors">åˆ é™¤</button>
                    </div>
                </div>
            `).join('');
        }

        function showAddModal() {
            editingId = null;
            document.getElementById('modal-title').textContent = 'æ·»åŠ ç¯å¢ƒå˜é‡';
            document.getElementById('env-name').value = '';
            document.getElementById('env-desc').value = '';
            document.getElementById('env-default').checked = false;
            document.getElementById('modal').classList.add('show');
        }

        function editEnv(id) {
            const envs = getEnvs();
            const env = envs.find(e => e.id === id);
            if (!env) return;

            editingId = id;
            document.getElementById('modal-title').textContent = 'ç¼–è¾‘ç¯å¢ƒå˜é‡';
            document.getElementById('env-name').value = env.name;
            document.getElementById('env-desc').value = env.desc || '';
            document.getElementById('env-default').checked = env.isDefault;
            document.getElementById('modal').classList.add('show');
        }

        function closeModal() {
            document.getElementById('modal').classList.remove('show');
            editingId = null;
        }

        function saveEnv() {
            const name = document.getElementById('env-name').value.trim().toUpperCase().replace(/^\$/, '');
            const desc = document.getElementById('env-desc').value.trim();
            const isDefault = document.getElementById('env-default').checked;

            if (!name) {
                alert('è¯·è¾“å…¥ç¯å¢ƒå˜é‡åç§°');
                return;
            }

            if (!/^[A-Z_][A-Z0-9_]*$/.test(name)) {
                alert('ç¯å¢ƒå˜é‡åç§°åªèƒ½åŒ…å«å¤§å†™å­—æ¯ã€æ•°å­—å’Œä¸‹åˆ’çº¿ï¼Œä¸”ä¸èƒ½ä»¥æ•°å­—å¼€å¤´');
                return;
            }

            let envs = getEnvs();

            // æ£€æŸ¥é‡å
            if (envs.some(e => e.name === name && e.id !== editingId)) {
                alert('è¯¥ç¯å¢ƒå˜é‡åç§°å·²å­˜åœ¨');
                return;
            }

            if (editingId) {
                // ç¼–è¾‘
                envs = envs.map(e => {
                    if (e.id === editingId) {
                        return { ...e, name, desc, isDefault };
                    }
                    if (isDefault && e.id !== editingId) {
                        return { ...e, isDefault: false };
                    }
                    return e;
                });
            } else {
                // æ–°å¢
                const newId = Math.max(0, ...envs.map(e => e.id)) + 1;
                if (isDefault) {
                    envs = envs.map(e => ({ ...e, isDefault: false }));
                }
                envs.push({ id: newId, name, desc, isDefault });
            }

            saveEnvs(envs);
            closeModal();
            renderList();
        }

        function setDefault(id) {
            let envs = getEnvs();
            envs = envs.map(e => ({ ...e, isDefault: e.id === id }));
            saveEnvs(envs);
            renderList();
        }

        function deleteEnv(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¯¥ç¯å¢ƒå˜é‡å—ï¼Ÿ')) return;
            
            let envs = getEnvs();
            const toDelete = envs.find(e => e.id === id);
            envs = envs.filter(e => e.id !== id);
            
            // å¦‚æœåˆ é™¤çš„æ˜¯é»˜è®¤é¡¹ï¼Œå°†ç¬¬ä¸€é¡¹è®¾ä¸ºé»˜è®¤
            if (toDelete?.isDefault && envs.length > 0) {
                envs[0].isDefault = true;
            }
            
            saveEnvs(envs);
            renderList();
        }

        // åˆå§‹åŒ–
        renderList();
    </script>

</body>
</html>
